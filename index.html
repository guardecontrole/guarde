<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle Financeiro Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <!-- SDKs do Firebase (Versão Modular v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            setDoc, 
            getDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        window.firebase = {
             initializeApp,
             getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut,
             getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart } = Recharts;

        // --- Configuração e Inicialização do Firebase (SDK v9+) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCjRdWFxR07ryhlI4bB8XJjBoxqXjw2LBE",
            authDomain: "guardecontrolefinanceiro.firebaseapp.com",
            projectId: "guardecontrolefinanceiro",
            storageBucket: "guardecontrolefinanceiro.appspot.com",
            messagingSenderId: "930219640587",
            appId: "1:930219640587:web:eca78fa4a2fb62960a040e",
            measurementId: "G-9D98TPEQ7V"
        };
        
        const {
            initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
            GoogleAuthProvider, signInWithPopup, signOut, getFirestore, collection, doc, onSnapshot,
            addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        } = window.firebase;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.appId || 'default-app-id';

        // --- Ícones SVG ---
        const TrashIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-400 hover:text-red-300"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> );
        const EditIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-400 hover:text-blue-300"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> );
        const ShieldIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> );
        const ExportIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> );
        const ImportIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 5 17 10"></polyline><line x1="12" y1="5" x2="12" y2="19"></line></svg> );
        const UndoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg> );
        const RedoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"></path></svg> );
        const HelpIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> );
        const LogoutIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> );
        const GoogleIcon = () => ( <svg className="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 109.8 512 0 402.2 0 261.8 0 122.4 109.8 13.6 244 13.6c70.3 0 129.8 27.8 174.3 71.9l-64.8 64.8C327.5 112.5 289.1 90.9 244 90.9c-86.1 0-156.2 69.1-156.2 154.9s70.1 154.9 156.2 154.9c94.2 0 135.3-72.2 140.8-109.9H244V261.8h244z"></path></svg> );
        const SortAscIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-blue-400"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z"></path></svg> );
        const SortDescIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-blue-400"><path d="M12 16l-6-6 1.41-1.41L12 13.17l4.59-4.58L18 10l-6 6z"></path></svg> );
        const NeutralSortIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity"><path d="m7 15 5 5 5-5"></path><path d="m7 9 5-5 5 5"></path></svg> );
        const SortIndicator = ({ sortConfig, columnKey }) => { if (sortConfig.key === columnKey) { return sortConfig.direction === 'ascending' ? <SortAscIcon /> : <SortDescIcon />; } return <NeutralSortIcon />; };
        
        // --- COMPONENTES ---

        const AuthModal = ({ auth, db }) => {
            const [isLoginView, setIsLoginView] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuthSuccess = async (userCredential) => {
                const user = userCredential.user;
                const userRef = doc(db, "users", user.uid);
                const userData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    lastLoginAt: serverTimestamp(),
                };
                await setDoc(userRef, userData, { merge: true });
            };

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let userCredential;
                    if (isLoginView) {
                        userCredential = await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const userRef = doc(db, "users", userCredential.user.uid);
                        await setDoc(userRef, { plan: 'free', createdAt: serverTimestamp() }, { merge: true });
                    }
                    await handleAuthSuccess(userCredential);
                } catch (err) {
                    setError(getFriendlyAuthError(err.code));
                    console.error("Erro de autenticação:", err);
                }
                setLoading(false);
            };

            const handleGoogleSignIn = async () => {
                setLoading(true);
                setError('');
                try {
                    const provider = new GoogleAuthProvider();
                    const result = await signInWithPopup(auth, provider);
                    const userRef = doc(db, "users", result.user.uid);
                    const docSnap = await getDoc(userRef);
                    if (!docSnap.exists()) {
                        await setDoc(userRef, { plan: 'free', createdAt: serverTimestamp() }, { merge: true });
                    }
                    await handleAuthSuccess(result);
                } catch (err) {
                    setError(getFriendlyAuthError(err.code));
                    console.error("Erro com o login Google:", err);
                }
                setLoading(false);
            };
            
            const getFriendlyAuthError = (code) => {
                switch (code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'E-mail ou senha inválidos.';
                    case 'auth/email-already-in-use':
                        return 'Este e-mail já está em uso.';
                    case 'auth/weak-password':
                        return 'A senha deve ter pelo menos 6 caracteres.';
                    case 'auth/invalid-email':
                        return 'O formato do e-mail é inválido.';
                    default:
                        return 'Ocorreu um erro. Por favor, tente novamente.';
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 flex justify-center items-center z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                        <h2 className="text-3xl font-bold text-gray-100 mb-2 text-center">{isLoginView ? 'Bem-vindo de volta!' : 'Crie sua conta'}</h2>
                        <p className="text-gray-400 text-center mb-6">{isLoginView ? 'Insira suas credenciais para acessar.' : 'Cadastre-se para começar a controlar suas finanças.'}</p>
                        {error && <div className="bg-red-900/50 border border-red-500 text-red-400 px-4 py-3 rounded-lg mb-4" role="alert">{error}</div>}
                        <form onSubmit={handleAuthAction}>
                            <div className="space-y-4">
                                <input type="email" placeholder="E-mail" value={email} onChange={e => setEmail(e.target.value)} required className="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                <input type="password" placeholder="Senha" value={password} onChange={e => setPassword(e.target.value)} required className="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                            </div>
                            <button type="submit" disabled={loading} className="w-full mt-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-colors disabled:bg-blue-800 disabled:cursor-not-allowed">
                                {loading ? 'Processando...' : (isLoginView ? 'Entrar' : 'Cadastrar')}
                            </button>
                        </form>
                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-600"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-gray-800 text-gray-500">OU</span></div></div>
                        <button onClick={handleGoogleSignIn} disabled={loading} className="w-full flex justify-center items-center py-3 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors border border-gray-600 disabled:bg-gray-800 disabled:cursor-not-allowed">
                            <GoogleIcon />
                            {isLoginView ? 'Entrar com o Google' : 'Cadastrar com o Google'}
                        </button>
                        <p className="mt-6 text-center text-sm text-gray-400">
                            {isLoginView ? 'Não tem uma conta?' : 'Já tem uma conta?'}
                            <button onClick={() => { setIsLoginView(!isLoginView); setError(''); }} className="font-medium text-blue-400 hover:text-blue-300 ml-1">
                                {isLoginView ? 'Cadastre-se' : 'Entrar'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        };

        const Tour = ({ steps, isOpen, onClose }) => { const [currentStepIndex, setCurrentStepIndex] = useState(0); const [style, setStyle] = useState({}); useEffect(() => { if (!isOpen) return; const currentStep = steps[currentStepIndex]; const targetElement = document.querySelector(currentStep.target); if (targetElement) { targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); const targetRect = targetElement.getBoundingClientRect(); targetElement.classList.add('tour-highlight'); const popoverStyle = { position: 'absolute', top: `${targetRect.bottom + window.scrollY + 10}px`, left: `${targetRect.left + window.scrollX}px`, maxWidth: '350px', transform: 'translateX(0)', }; if (targetRect.left + 350 > window.innerWidth) { popoverStyle.left = `${targetRect.right + window.scrollX - 350}px`; } if (targetRect.top < 200) { popoverStyle.top = `${targetRect.bottom + window.scrollY + 10}px`; } else { popoverStyle.top = `${targetRect.top + window.scrollY - 10}px`; popoverStyle.transform = 'translateY(-100%)'; } setStyle(popoverStyle); } else { setStyle({ position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', maxWidth: '350px', }); } return () => { if (targetElement) { targetElement.classList.remove('tour-highlight'); } }; }, [currentStepIndex, isOpen, steps]); if (!isOpen) return null; const handleNext = () => currentStepIndex < steps.length - 1 ? setCurrentStepIndex(currentStepIndex + 1) : onClose(); const handlePrev = () => currentStepIndex > 0 && setCurrentStepIndex(currentStepIndex - 1); const currentStep = steps[currentStepIndex]; return ( <> <div className="fixed inset-0 bg-black/70 z-40" onClick={onClose}></div> <div style={style} className="bg-gray-700 text-gray-200 rounded-lg shadow-2xl p-5 z-50 transition-all duration-300"> <h3 className="text-xl font-bold text-blue-400 mb-2">{currentStep.title}</h3> <p className="text-sm mb-4">{currentStep.content}</p> <div className="flex justify-between items-center"> <span className="text-xs text-gray-400">Passo {currentStepIndex + 1} de {steps.length}</span> <div className="flex gap-2"> <button onClick={onClose} className="text-xs px-3 py-1 rounded hover:bg-gray-600 transition-colors">Pular</button> {currentStepIndex > 0 && <button onClick={handlePrev} className="px-4 py-1 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors">Anterior</button>} <button onClick={handleNext} className="px-4 py-1 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-colors"> {currentStepIndex === steps.length - 1 ? 'Concluir' : 'Próximo'} </button> </div> </div> </div> <style>{`.tour-highlight { position: relative; z-index: 50; border-radius: 8px; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7); transition: box-shadow 0.3s ease-in-out; }`}</style> </> ); };
        const RecordsTable = ({ title, records, onDelete, onEdit, type, sortConfig, requestSort }) => ( <div className="bg-gray-800/50 p-6 rounded-b-xl rounded-r-xl shadow-inner"> <h3 className="text-xl font-semibold text-gray-200 mb-4">{title}</h3> {records.length > 0 ? ( <div className="overflow-x-auto max-h-[400px]"> <table className="w-full text-left"> <thead> <tr className="border-b-2 border-gray-700 bg-gray-700/50 sticky top-0"> <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('month')}> <div className="flex items-center justify-start group"> <span>Mês</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="month" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 w-2/3 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('description')}> <div className="flex items-center justify-start group"> <span>Descrição</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="description" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('amount')}> <div className="flex items-center justify-end group"> <span>Valor</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="amount" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 text-center">Ações</th> </tr> </thead> <tbody> {records.map((record) => ( <tr key={record.id} className="border-b border-gray-700 hover:bg-gray-700/70"> <td className="p-3 text-gray-300 capitalize">{new Date(0, record.month).toLocaleString('pt-BR', { month: 'long' })}</td> <td className="p-3 text-gray-300">{record.description}</td> <td className={`p-3 font-medium text-right ${type === 'income' ? 'text-green-400' : 'text-red-400'}`}> {record.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> <td className="p-3 text-center"> <div className="flex justify-center items-center gap-3"> <button onClick={() => onEdit(record, type)} className="p-1 rounded-full hover:bg-blue-800/50 transition-colors"> <EditIcon /> </button> <button onClick={() => onDelete(record.id, type)} className="p-1 rounded-full hover:bg-red-800/50 transition-colors"> <TrashIcon /> </button> </div> </td> </tr> ))} </tbody> </table> </div> ) : ( <p className="text-gray-500 text-center py-4">Nenhum registro encontrado.</p> )} </div> );
        const EditModal = ({ record, onSave, onCancel, onError }) => { const [newDescription, setNewDescription] = useState(record.description); const [newAmount, setNewAmount] = useState(record.amount); const handleSave = () => { if (!newDescription.trim() || !newAmount || isNaN(parseFloat(newAmount))) { onError("Por favor, preencha a descrição e um valor válido."); return; } onSave(record.id, record.type, { description: newDescription, amount: parseFloat(newAmount) }); }; return ( <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50"> <div className="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md"> <h2 className="text-2xl font-bold text-gray-100 mb-4">Editar Registro</h2> <div className="space-y-4"> <div> <label htmlFor="edit-description" className="block text-sm font-medium text-gray-400 mb-1">Descrição</label> <input id="edit-description" type="text" value={newDescription} onChange={(e) => setNewDescription(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div> <div> <label htmlFor="edit-amount" className="block text-sm font-medium text-gray-400 mb-1">Valor (R$)</label> <input id="edit-amount" type="number" step="0.01" value={newAmount} onChange={(e) => setNewAmount(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div> </div> <div className="mt-6 flex justify-end gap-4"> <button onClick={onCancel} className="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors">Cancelar</button> <button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-colors">Salvar</button> </div> </div> </div> ); };
        const FinancialEvolutionChart = ({ data }) => { const [visibility, setVisibility] = useState({ balance: true, avgBalance: true, expense: true, stabilityReserve: true, }); const handleLegendClick = (e) => { const { dataKey } = e; setVisibility(prev => ({ ...prev, [dataKey]: !prev[dataKey] })); }; const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); const formatCompactCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', notation: 'compact' }).format(value); return ( <div id="financial-chart" className="bg-gray-800 p-6 rounded-xl shadow-md"> <h2 className="text-2xl font-semibold text-gray-200 mb-4">Evolução Financeira</h2> <div style={{ width: '100%', height: 350 }}> <ResponsiveContainer> <ComposedChart data={data} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}> <CartesianGrid strokeDasharray="3 3" stroke="#4A5568" /> <XAxis dataKey="monthName" stroke="#A0AEC0" tick={{textTransform: 'capitalize'}} /> <YAxis stroke="#A0AEC0" tickFormatter={formatCompactCurrency} /> <Tooltip contentStyle={{ backgroundColor: '#2D3748', border: '1px solid #4A5568', color: '#E2E8F0' }} formatter={(value, name) => [formatCurrency(value), name]} /> <Legend onClick={handleLegendClick} wrapperStyle={{ color: '#E2E8F0', cursor: 'pointer' }} /> <Line type="monotone" dataKey="balance" name="Renda Líquida Mensal" stroke="#48BB78" strokeWidth={2} hide={!visibility.balance} /> <Line type="monotone" dataKey="avgBalance" name="Média Líquida (12m)" stroke="#4299E1" strokeDasharray="5 5" strokeWidth={2} hide={!visibility.avgBalance} /> <Line type="monotone" dataKey="expense" name="Saída Mensal" stroke="#F56565" strokeWidth={2} hide={!visibility.expense} /> <Line type="monotone" dataKey="stabilityReserve" name="Reserva de Estabilidade" stroke="#A0AEC0" strokeWidth={2} hide={!visibility.stabilityReserve} /> </ComposedChart> </ResponsiveContainer> </div> </div> ); };
        const MonthlyBalanceHistoryTable = ({ data, isLoading, sortConfig, requestSort }) => ( <div className="bg-gray-800/50 p-6 rounded-b-xl rounded-r-xl shadow-inner"> <h2 className="text-xl font-semibold text-gray-200 mb-4">Histórico de Saldo Mensal ({new Date().getFullYear()})</h2> <div className="overflow-y-auto" style={{maxHeight: '350px'}}> <table className="w-full text-left"> <thead className="sticky top-0 bg-gray-800"> <tr className="border-b-2 border-gray-700 bg-gray-700/50"> <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('month')}> <div className="flex items-center justify-start group"> <span>Mês</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="month" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('income')}> <div className="flex items-center justify-end group"> <span>Entradas</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="income" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('expense')}> <div className="flex items-center justify-end group"> <span>Saídas</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="expense" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('balance')}> <div className="flex items-center justify-end group"> <span>Saldo do Mês</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="balance" /></span> </div> </th> </tr> </thead> <tbody> {data.map((monthData, index) => ( <tr key={index} className="border-b border-gray-700 hover:bg-gray-700/70"> <td className="p-3 text-gray-300 capitalize">{monthData.monthName}</td> <td className="p-3 text-green-400 font-medium text-right"> {monthData.income.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> <td className="p-3 text-red-400 font-medium text-right"> {monthData.expense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> <td className={`p-3 font-bold text-right ${monthData.balance >= 0 ? 'text-blue-400' : 'text-yellow-400'}`}> {monthData.balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> </tr> ))} {data.length === 0 && !isLoading && ( <tr> <td colSpan="4" className="text-center text-gray-500 py-4"> Nenhuma atividade registrada para este ano. </td> </tr> )} </tbody> </table> </div> </div> );
        const StabilityReserveHistoryTable = ({ data, sortConfig, requestSort }) => ( <div className="bg-gray-800/50 p-6 rounded-b-xl rounded-r-xl shadow-inner"> <h2 className="text-xl font-semibold text-gray-200 mb-4">Histórico da Reserva de Estabilidade</h2> <div className="overflow-y-auto" style={{maxHeight: '350px'}}> <table className="w-full text-left"> <thead className="sticky top-0 bg-gray-800"> <tr className="border-b-2 border-gray-700 bg-gray-700/50"> <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('monthKey')}> <div className="flex items-center justify-start group"> <span>Mês</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="monthKey" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('amountAdded')}> <div className="flex items-center justify-end group"> <span>Valor Guardado</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="amountAdded" /></span> </div> </th> <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('totalReserve')}> <div className="flex items-center justify-end group"> <span>Total na Reserva</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="totalReserve" /></span> </div> </th> </tr> </thead> <tbody> {data.map((monthData) => ( <tr key={monthData.monthKey} className="border-b border-gray-700 hover:bg-gray-700/70"> <td className="p-3 text-gray-300 capitalize">{monthData.monthName}</td> <td className={`p-3 font-medium text-right ${ monthData.amountAdded > 0 ? 'text-green-400' : monthData.amountAdded < 0 ? 'text-red-400' : 'text-gray-400' }`}> {monthData.amountAdded.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> <td className="p-3 text-purple-400 font-bold text-right"> {monthData.totalReserve.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> </tr> ))} {data.length === 0 && ( <tr> <td colSpan="3" className="text-center text-gray-500 py-4"> Dados insuficientes para calcular o histórico. </td> </tr> )} </tbody> </table> </div> </div> );
        const useSortableData = (items, config) => { return useMemo(() => { if (!config) return items; const sortedItems = [...items]; sortedItems.sort((a, b) => { if (a[config.key] < b[config.key]) { return config.direction === 'ascending' ? -1 : 1; } if (a[config.key] > b[config.key]) { return config.direction === 'ascending' ? 1 : -1; } return 0; }); return sortedItems; }, [items, config]); };
        
        // --- COMPONENTE PRINCIPAL ---

        function App() {
            const [user, setUser] = useState(null);
            const [incomes, setIncomes] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [formType, setFormType] = useState('income');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [editingRecord, setEditingRecord] = useState(null);
            const [activeTab, setActiveTab] = useState('summary');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const fileInputRef = useRef(null);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isTourOpen, setIsTourOpen] = useState(false);
            const [sortConfigs, setSortConfigs] = useState({ summary: { key: 'month', direction: 'ascending' }, reserve: { key: 'monthKey', direction: 'ascending' }, incomes: { key: 'month', direction: 'ascending' }, expenses: { key: 'month', direction: 'ascending' } });
            const [showFullSummary, setShowFullSummary] = useState(false);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setUser(user);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) { 
                    setIncomes([]); 
                    setExpenses([]); 
                    return; 
                }

                const incomesCol = collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`);
                const expensesCol = collection(db, `/artifacts/${appId}/users/${user.uid}/expenses`);

                let initialLoad = true;
                
                const unsubIncomes = onSnapshot(incomesCol, (snapshot) => { 
                    const incomeData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                    setIncomes(incomeData); 
                    if (initialLoad && incomeData.length === 0 && expenses.length === 0) {
                       setIsTourOpen(true);
                       initialLoad = false;
                    }
                });
                
                const unsubExpenses = onSnapshot(expensesCol, (snapshot) => { 
                    const expenseData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExpenses(expenseData);
                    if (initialLoad && expenseData.length === 0 && incomes.length === 0) {
                        setIsTourOpen(true);
                        initialLoad = false;
                    }
                });

                return () => { unsubIncomes(); unsubExpenses(); };
            }, [user]);
            
            useEffect(() => { if (error) { const timer = setTimeout(() => setError(''), 5000); return () => clearTimeout(timer); } }, [error]);
            useEffect(() => { if (success) { const timer = setTimeout(() => setSuccess(''), 5000); return () => clearTimeout(timer); } }, [success]);
            
            const addActionToHistory = (action) => { const newHistory = history.slice(0, historyIndex + 1); newHistory.push(action); setHistory(newHistory); setHistoryIndex(newHistory.length - 1); };
            const handleAddRecord = async (e) => { e.preventDefault(); if (!description.trim() || !amount || isNaN(parseFloat(amount))) { setError("Por favor, preencha a descrição e um valor válido."); return; } if (!db || !user) { setError("A conexão com o banco de dados não está pronta."); return; } setError(''); const newRecord = { description, amount: parseFloat(amount), month: parseInt(month), year: parseInt(year), createdAt: new Date() }; const collectionName = formType === 'income' ? 'incomes' : 'expenses'; try { const colRef = collection(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`); const docRef = await addDoc(colRef, newRecord); addActionToHistory({ type: 'ADD', collection: collectionName, docId: docRef.id, data: newRecord }); setDescription(''); setAmount(''); setSuccess(`Registro de ${formType === 'income' ? 'entrada' : 'saída'} adicionado com sucesso!`); } catch (err) { console.error(`Erro ao adicionar ${formType}:`, err); setError("Ocorreu um erro ao salvar o registro."); } };
            const handleDeleteRecord = async (id, type) => { if (!db || !user) return; const collectionName = type === 'income' ? 'incomes' : 'expenses'; const recordToDelete = (type === 'income' ? incomes : expenses).find(r => r.id === id); if (!recordToDelete) { setError("Registro não encontrado para apagar."); return; } try { const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, id); await deleteDoc(docRef); addActionToHistory({ type: 'DELETE', collection: collectionName, docId: id, data: recordToDelete }); setSuccess("Registro apagado com sucesso."); } catch (err) { console.error(`Erro ao deletar ${type}:`, err); setError("Ocorreu um erro ao apagar o registro."); } };
            const handleUpdateRecord = async (id, type, updatedData) => { if (!db || !user) return; const collectionName = type === 'income' ? 'incomes' : 'expenses'; const originalRecord = (type === 'income' ? incomes : expenses).find(r => r.id === id); if (!originalRecord) { setError("Registro não encontrado para atualizar."); return; } try { const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, id); await updateDoc(docRef, updatedData); addActionToHistory({ type: 'UPDATE', collection: collectionName, docId: id, oldData: { description: originalRecord.description, amount: originalRecord.amount }, newData: updatedData }); setEditingRecord(null); setSuccess("Registro atualizado com sucesso."); } catch (err) { console.error("Erro ao atualizar registro:", err); setError("Ocorreu um erro ao atualizar o registro."); } };
            const handleUndo = async () => { if (historyIndex < 0) return; const actionToUndo = history[historyIndex]; const { type, collection: collectionName, docId, data, oldData } = actionToUndo; try { const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, docId); if (type === 'ADD') { await deleteDoc(docRef); } else if (type === 'DELETE') { const { id, ...dataToRestore } = data; await setDoc(docRef, dataToRestore); } else if (type === 'UPDATE') { await updateDoc(docRef, oldData); } setHistoryIndex(prev => prev - 1); setSuccess("Ação desfeita com sucesso."); } catch (err) { console.error("Erro ao desfazer:", err); setError("Falha ao desfazer a ação."); } };
            const handleRedo = async () => { if (historyIndex >= history.length - 1) return; const newIndex = historyIndex + 1; const actionToRedo = history[newIndex]; const { type, collection: collectionName, docId, data, newData } = actionToRedo; try { const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, docId); if (type === 'ADD') { await setDoc(docRef, data); } else if (type === 'DELETE') { await deleteDoc(docRef); } else if (type === 'UPDATE') { await updateDoc(docRef, newData); } setHistoryIndex(newIndex); setSuccess("Ação refeita com sucesso."); } catch (err) { console.error("Erro ao refazer:", err); setError("Falha ao refazer a ação."); } };
            const handleExportData = () => { if (incomes.length === 0 && expenses.length === 0) { setError("Não há dados para exportar."); return; } const convertTimestamp = (data) => data.map(doc => { const { id, ...rest } = doc; if (rest.createdAt && typeof rest.createdAt.toDate === 'function') { rest.createdAt = rest.createdAt.toDate().toISOString(); } return rest; }); const dataToExport = { incomes: convertTimestamp(incomes), expenses: convertTimestamp(expenses), }; const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(dataToExport, null, 2))}`; const link = document.createElement("a"); link.href = jsonString; link.download = `dados_financeiros_${new Date().toISOString().slice(0, 10)}.json`; link.click(); setSuccess('Dados exportados com sucesso!'); };
            const handleImportClick = () => { fileInputRef.current.click(); };
            const handleFileChange = async (event) => { const file = event.target.files[0]; if (!file) return; if (file.type !== "application/json") { setError("Por favor, selecione um arquivo .json válido."); return; } const reader = new FileReader(); reader.onload = async (e) => { try { const data = JSON.parse(e.target.result); if (!data.incomes || !data.expenses || !Array.isArray(data.incomes) || !Array.isArray(data.expenses)) { throw new Error("Formato de arquivo inválido."); } setIsLoading(true); const createRecordIdentifier = (rec) => { const date = rec.createdAt?.toDate ? rec.createdAt.toDate() : new Date(rec.createdAt); return `${rec.description?.trim()}|${rec.amount}|${date.toISOString()}`; }; const existingIncomes = new Set(incomes.map(createRecordIdentifier)); const existingExpenses = new Set(expenses.map(createRecordIdentifier)); let importedCount = 0; let skippedCount = 0; const incomeCollectionRef = collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`); for (const record of data.incomes) { const newRecord = { ...record, createdAt: record.createdAt ? new Date(record.createdAt) : new Date() }; const identifier = createRecordIdentifier(newRecord); if (!existingIncomes.has(identifier)) { await addDoc(incomeCollectionRef, newRecord); importedCount++; } else { skippedCount++; } } const expenseCollectionRef = collection(db, `/artifacts/${appId}/users/${user.uid}/expenses`); for (const record of data.expenses) { const newRecord = { ...record, createdAt: record.createdAt ? new Date(record.createdAt) : new Date() }; const identifier = createRecordIdentifier(newRecord); if (!existingExpenses.has(identifier)) { await addDoc(expenseCollectionRef, newRecord); importedCount++; } else { skippedCount++; } } setSuccess(`Importação concluída! ${importedCount} registros adicionados, ${skippedCount} duplicados ignorados.`); setHistory([]); setHistoryIndex(-1); } catch (err) { console.error("Erro ao importar dados:", err); setError(`Erro ao importar dados: ${err.message}`); } finally { if(fileInputRef.current) { fileInputRef.current.value = ""; } setIsLoading(false); } }; reader.readAsText(file); };
            const handleRequestSort = (tab, key) => { setSortConfigs(prevConfigs => { const currentConfig = prevConfigs[tab]; let direction = 'ascending'; if (currentConfig.key === key && currentConfig.direction === 'ascending') { direction = 'descending'; } return { ...prevConfigs, [tab]: { key, direction } }; }); };
            
            // --- Hooks de Cálculo (Memoização) ---
            const filteredIncomes = useMemo(() => incomes.filter(i => i.year === filterYear), [incomes, filterYear]);
            const filteredExpenses = useMemo(() => expenses.filter(e => e.year === filterYear), [expenses, filterYear]);
            const totalIncomes = useMemo(() => filteredIncomes.reduce((sum, i) => sum + i.amount, 0), [filteredIncomes]);
            const totalExpenses = useMemo(() => filteredExpenses.reduce((sum, e) => sum + e.amount, 0), [filteredExpenses]);
            const balance = useMemo(() => totalIncomes - totalExpenses, [totalIncomes, totalExpenses]);
            const twelveMonthAverages = useMemo(() => { const now = new Date(); const twelveMonthsAgo = new Date(); twelveMonthsAgo.setMonth(now.getMonth() - 11); twelveMonthsAgo.setDate(1); twelveMonthsAgo.setHours(0, 0, 0, 0); const last12MonthsIncomes = incomes.filter(income => { const incomeDate = new Date(income.year, income.month); return incomeDate >= twelveMonthsAgo && incomeDate <= now; }); const last12MonthsExpenses = expenses.filter(expense => { const expenseDate = new Date(expense.year, expense.month); return expenseDate >= twelveMonthsAgo && expenseDate <= now; }); const activeMonths = new Set(); last12MonthsIncomes.forEach(i => activeMonths.add(`${i.year}-${i.month}`)); last12MonthsExpenses.forEach(e => activeMonths.add(`${e.year}-${e.month}`)); const numberOfActiveMonths = activeMonths.size; const divisor = numberOfActiveMonths > 0 ? numberOfActiveMonths : 1; const totalIncomeLast12Months = last12MonthsIncomes.reduce((sum, i) => sum + i.amount, 0); const totalExpenseLast12Months = last12MonthsExpenses.reduce((sum, e) => sum + e.amount, 0); const avgIncome = totalIncomeLast12Months / divisor; const avgExpense = totalExpenseLast12Months / divisor; const avgBalance = avgIncome - avgExpense; return { avgIncome, avgExpense, avgBalance }; }, [incomes, expenses]);
            const stabilityReserveHistory = useMemo(() => { const monthlyNetIncomes = {}; incomes.forEach(record => { const key = `${record.year}-${String(record.month).padStart(2, '0')}`; if (!monthlyNetIncomes[key]) monthlyNetIncomes[key] = 0; monthlyNetIncomes[key] += record.amount; }); expenses.forEach(record => { const key = `${record.year}-${String(record.month).padStart(2, '0')}`; if (!monthlyNetIncomes[key]) monthlyNetIncomes[key] = 0; monthlyNetIncomes[key] -= record.amount; }); const sortedMonthKeys = Object.keys(monthlyNetIncomes).sort(); if (sortedMonthKeys.length < 2) { return []; } const history = []; let runningReserve = 0; for (const monthKey of sortedMonthKeys) { const [currentYear, currentMonthIndex] = monthKey.split('-').map(Number); const currentDate = new Date(currentYear, currentMonthIndex + 1, 0); const twelveMonthsAgo = new Date(currentDate); twelveMonthsAgo.setMonth(currentDate.getMonth() - 11); twelveMonthsAgo.setDate(1); const relevantIncomes = incomes.filter(i => { const d = new Date(i.year, i.month, 1); return d >= twelveMonthsAgo && d <= currentDate; }); const relevantExpenses = expenses.filter(e => { const d = new Date(e.year, e.month, 1); return d >= twelveMonthsAgo && d <= currentDate; }); const activeMonths = new Set(); relevantIncomes.forEach(i => activeMonths.add(`${i.year}-${i.month}`)); relevantExpenses.forEach(e => activeMonths.add(`${e.year}-${e.month}`)); const divisor = activeMonths.size > 0 ? activeMonths.size : 1; const totalIncomeWindow = relevantIncomes.reduce((sum, i) => sum + i.amount, 0); const totalExpenseWindow = relevantExpenses.reduce((sum, e) => sum + e.amount, 0); const avgBalanceForThisMonth = (totalIncomeWindow - totalExpenseWindow) / divisor; const previousReserve = runningReserve; const currentMonthBalance = monthlyNetIncomes[monthKey] || 0; const difference = currentMonthBalance - avgBalanceForThisMonth; runningReserve += difference; if (runningReserve < 0) { runningReserve = 0; } const amountAdded = runningReserve - previousReserve; const monthName = new Date(currentYear, currentMonthIndex).toLocaleString('pt-BR', { month: 'long' }); history.push({ monthKey: monthKey, monthName: `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} de ${currentYear}`, amountAdded: amountAdded, totalReserve: runningReserve }); } return history; }, [incomes, expenses]);
            const finalStabilityReserve = useMemo(() => { return stabilityReserveHistory.length > 0 ? stabilityReserveHistory[stabilityReserveHistory.length - 1].totalReserve : 0; }, [stabilityReserveHistory]);
            const monthlySummary = useMemo(() => { const summary = Array.from({ length: 12 }, (_, i) => ({ month: i, monthName: new Date(0, i).toLocaleString('pt-BR', { month: 'short' }).replace('.', ''), income: 0, expense: 0, balance: 0, })); filteredIncomes.forEach(income => { summary[income.month].income += income.amount; }); filteredExpenses.forEach(expense => { summary[expense.month].expense += expense.amount; }); summary.forEach(monthData => { monthData.balance = monthData.income - monthData.expense; }); return summary; }, [filteredIncomes, filteredExpenses]);
            const chartData = useMemo(() => { const reserveMap = new Map(stabilityReserveHistory.map(entry => [entry.monthKey, entry.totalReserve])); let lastKnownReserve = 0; return monthlySummary.map(summaryMonth => { const monthKey = `${filterYear}-${String(summaryMonth.month).padStart(2, '0')}`; if (reserveMap.has(monthKey)) { lastKnownReserve = reserveMap.get(monthKey); } return { ...summaryMonth, avgBalance: twelveMonthAverages.avgBalance, stabilityReserve: lastKnownReserve }; }); }, [monthlySummary, stabilityReserveHistory, filterYear, twelveMonthAverages.avgBalance]);
            const monthlyBalanceHistory = useMemo(() => monthlySummary.filter(m => m.income > 0 || m.expense > 0), [monthlySummary]);
            
            const sortedMonthlyBalanceHistory = useSortableData(monthlyBalanceHistory, sortConfigs.summary);
            const sortedStabilityReserveHistory = useSortableData(stabilityReserveHistory, sortConfigs.reserve);
            const sortedFilteredIncomes = useSortableData(filteredIncomes, sortConfigs.incomes);
            const sortedFilteredExpenses = useSortableData(filteredExpenses, sortConfigs.expenses);

            const canUndo = historyIndex >= 0;
            const canRedo = historyIndex < history.length - 1;
            const tourSteps = [
                { target: '#add-record-form', title: 'Bem-vindo(a)!', content: 'Comece por aqui! Use este formulário para adicionar suas entradas e saídas. Ele estará sempre visível para acesso rápido.' },
                { target: '#summary-cards', title: 'Seu Painel Principal', content: 'Aqui você vê o mais importante: sua Reserva de Estabilidade e o Salário sugerido para o mês.' },
                { target: '#summary-toggle', title: 'Ver Detalhes do Ano', content: 'Quer ver o total de entradas, saídas e o saldo do ano? Clique aqui para expandir e ver o resumo completo.'},
                { target: '#financial-chart', title: 'Evolução Financeira', content: 'Este gráfico mostra o seu progresso mês a mês. Clique nas legendas para focar no que é mais importante.' },
                { target: '#action-buttons', title: 'Ferramentas', content: 'Precisa importar ou exportar dados? Cometeu um erro e quer desfazer? Use as ferramentas neste painel.' }
            ];

            if (isLoading) { return <div className="bg-gray-900 text-gray-300 min-h-screen flex justify-center items-center"><p>Carregando...</p></div>; }
            if (!user) { return <AuthModal auth={auth} db={db} />; }

            return (
                <div className="bg-gray-900 text-gray-300 min-h-screen font-sans">
                    <Tour steps={tourSteps} isOpen={isTourOpen} onClose={() => setIsTourOpen(false)} />
                    {editingRecord && ( <EditModal record={editingRecord} onSave={handleUpdateRecord} onCancel={() => { setEditingRecord(null); setError(''); }} onError={setError} /> )}
                    
                    <header className="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
                            <h1 className="text-2xl font-bold text-gray-100">Controle Financeiro</h1>
                            <div className="flex items-center gap-4">
                                <p className="text-sm text-gray-400 hidden sm:block">
                                    {user.email || user.displayName || 'Usuário Anônimo'}
                                </p>
                                <button onClick={() => signOut(auth)} className="flex items-center justify-center p-2 bg-red-600/80 text-white font-semibold rounded-full hover:bg-red-500 transition-colors" title="Sair">
                                    <LogoutIcon />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                        {error && <div className="bg-red-900/50 border border-red-500 text-red-400 px-4 py-3 rounded-lg relative mb-6" role="alert">{error}</div>}
                        {success && <div className="bg-green-900/50 border border-green-500 text-green-400 px-4 py-3 rounded-lg relative mb-6" role="alert">{success}</div>}

                        <div className="grid grid-cols-1 lg:grid-cols-12 lg:gap-8">
                            
                            {/* Coluna Principal (Esquerda) */}
                            <div className="lg:col-span-8 space-y-8">
                                <div id="summary-cards" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                    <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                                        <h2 className="text-2xl font-semibold text-gray-200">Resumo de {filterYear}</h2>
                                        <div className="flex items-center gap-2">
                                            <label htmlFor="filterYear" className="text-sm font-medium text-gray-400">Filtrar por Ano:</label>
                                            <input id="filterYear" type="number" value={filterYear} onChange={(e) => setFilterYear(parseInt(e.target.value))} className="w-32 px-3 py-1 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div id="monthly-salary-card" className={`p-4 rounded-lg border ${twelveMonthAverages.avgBalance >= 0 ? 'bg-blue-900/50 border-blue-700' : 'bg-yellow-900/50 border-yellow-700'}`}>
                                            <h3 className={`text-lg font-semibold ${twelveMonthAverages.avgBalance >= 0 ? 'text-blue-300' : 'text-yellow-300'}`}>Salário para Usar Este Mês</h3>
                                            <p className={`text-3xl font-bold mt-2 ${twelveMonthAverages.avgBalance >= 0 ? 'text-blue-400' : 'text-yellow-400'}`}>{twelveMonthAverages.avgBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                        </div>
                                        <div className="bg-purple-900/50 p-4 rounded-lg border border-purple-700">
                                            <h3 className="text-lg font-semibold text-purple-300 flex items-center gap-2 relative group">
                                                <ShieldIcon /> Reserva de Estabilidade
                                                <span className="absolute -top-2 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-gray-600 text-white text-xs rounded py-1 px-2 w-72">
                                                    Calculada mês a mês: Saldo Anterior + (Saldo do Mês - Média de Saldo dos 12 meses anteriores). A reserva é zerada se ficar negativa.
                                                </span>
                                            </h3>
                                            <p className="text-3xl font-bold text-purple-400 mt-2">{finalStabilityReserve.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                        </div>

                                        {showFullSummary && (
                                            <>
                                                <div className="bg-green-900/50 p-4 rounded-lg border border-green-700"> <h3 className="text-lg font-semibold text-green-300">Total de Entradas</h3> <p className="text-3xl font-bold text-green-400 mt-2">{totalIncomes.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p> </div>
                                                <div className="bg-red-900/50 p-4 rounded-lg border border-red-700"> <h3 className="text-lg font-semibold text-red-300">Total de Saídas</h3> <p className="text-3xl font-bold text-red-400 mt-2">{totalExpenses.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p> </div>
                                                <div className={`md:col-span-2 p-4 rounded-lg border ${balance >= 0 ? 'bg-blue-900/50 border-blue-700' : 'bg-yellow-900/50 border-yellow-700'}`}> <h3 className={`text-lg font-semibold ${balance >= 0 ? 'text-blue-300' : 'text-yellow-300'}`}>Saldo Final do Ano</h3> <p className={`text-3xl font-bold mt-2 ${balance >= 0 ? 'text-blue-400' : 'text-yellow-400'}`}>{balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p> </div>
                                            </>
                                        )}
                                    </div>
                                    
                                    <div id="summary-toggle" className="text-center mt-6 border-t border-gray-700 pt-4">
                                        <button onClick={() => setShowFullSummary(!showFullSummary)} className="text-sm font-medium text-blue-400 hover:text-blue-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-3 py-1">
                                            {showFullSummary ? 'Ocultar Detalhes do Ano' : 'Mostrar Detalhes do Ano'}
                                        </button>
                                    </div>
                                </div>
                                
                                <FinancialEvolutionChart data={chartData} />

                                <div id="detailed-reports" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                    <h2 className="text-2xl font-semibold text-gray-200 mb-4">Relatórios Detalhados</h2>
                                    <div className="border-b border-gray-700 flex flex-wrap">
                                        <button onClick={() => setActiveTab('summary')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'summary' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Resumo Mensal </button>
                                        <button onClick={() => setActiveTab('reserve')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'reserve' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Reserva de Estabilidade </button>
                                        <button onClick={() => setActiveTab('incomes')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'incomes' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Entradas </button>
                                        <button onClick={() => setActiveTab('expenses')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'expenses' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Saídas </button>
                                    </div>
                                    <div className="mt-4"> 
                                        {isLoading && !user ? (<p className="text-gray-500 text-center py-4">Carregando dados...</p>) : ( <> 
                                            {activeTab === 'summary' && <MonthlyBalanceHistoryTable data={sortedMonthlyBalanceHistory} isLoading={isLoading} sortConfig={sortConfigs.summary} requestSort={(key) => handleRequestSort('summary', key)} />} 
                                            {activeTab === 'reserve' && <StabilityReserveHistoryTable data={sortedStabilityReserveHistory} sortConfig={sortConfigs.reserve} requestSort={(key) => handleRequestSort('reserve', key)} />} 
                                            {activeTab === 'incomes' && <RecordsTable title={`Detalhes de Entradas (${filterYear})`} records={sortedFilteredIncomes} onDelete={handleDeleteRecord} onEdit={(record, type) => setEditingRecord({...record, type})} type="income" sortConfig={sortConfigs.incomes} requestSort={(key) => handleRequestSort('incomes', key)} />} 
                                            {activeTab === 'expenses' && <RecordsTable title={`Detalhes de Saídas (${filterYear})`} records={sortedFilteredExpenses} onDelete={handleDeleteRecord} onEdit={(record, type) => setEditingRecord({...record, type})} type="expense" sortConfig={sortConfigs.expenses} requestSort={(key) => handleRequestSort('expenses', key)} />} 
                                        </> )} 
                                    </div>
                                </div>
                            </div>

                            {/* Coluna de Ações (Direita) */}
                            <div className="lg:col-span-4 space-y-8 lg:sticky top-24 h-screen">
                                <div id="add-record-form" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                    <h3 className="text-xl font-semibold text-gray-200 mb-4">Adicionar Transação</h3>
                                    <div className="mb-4 border-b border-gray-700 flex"> <button onClick={() => setFormType('income')} className={`py-2 px-4 text-lg font-semibold transition-colors duration-300 ${formType === 'income' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400 hover:text-green-400'}`}> Entrada </button> <button onClick={() => setFormType('expense')} className={`py-2 px-4 text-lg font-semibold transition-colors duration-300 ${formType === 'expense' ? 'text-red-400 border-b-2 border-red-400' : 'text-gray-400 hover:text-red-400'}`}> Saída </button> </div>
                                    <form onSubmit={handleAddRecord} className="space-y-4">
                                        <div> <label htmlFor="description" className="block text-sm font-medium text-gray-400 mb-1">Descrição</label> <input id="description" type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder={formType === 'income' ? 'Ex: Salário, Venda' : 'Ex: Aluguel, Compras'} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div>
                                        <div> <label htmlFor="amount" className="block text-sm font-medium text-gray-400 mb-1">Valor (R$)</label> <input id="amount" type="number" step="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="1500.00" className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div>
                                        <div className="flex gap-4"> <div className="flex-1"> <label htmlFor="month" className="block text-sm font-medium text-gray-400 mb-1">Mês</label> <select id="month" value={month} onChange={(e) => setMonth(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> {Array.from({length: 12}, (_, i) => <option key={i} value={i}>{new Date(0, i).toLocaleString('pt-BR', { month: 'long' })}</option>)} </select> </div> <div className="flex-1"> <label htmlFor="year" className="block text-sm font-medium text-gray-400 mb-1">Ano</label> <input id="year" type="number" value={year} onChange={(e) => setYear(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div> </div>
                                        <button type="submit" className={`w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-opacity-50 ${formType === 'income' ? 'bg-green-600 hover:bg-green-500 focus:ring-green-500' : 'bg-red-600 hover:bg-red-500 focus:ring-red-500'}`}> Adicionar {formType === 'income' ? 'Entrada' : 'Saída'} </button>
                                    </form>
                                </div>
                                <div id="action-buttons" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                    <h3 className="text-xl font-semibold text-gray-200 mb-4">Ferramentas</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={handleImportClick} className="flex items-center justify-center text-sm px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-colors"> <ImportIcon /> Importar </button>
                                        <button onClick={handleExportData} className="flex items-center justify-center text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors"> <ExportIcon /> Exportar </button>
                                        <button onClick={handleUndo} disabled={!canUndo} className="flex items-center justify-center text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"> <UndoIcon /> Desfazer </button>
                                        <button onClick={handleRedo} disabled={!canRedo} className="flex items-center justify-center text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"> <RedoIcon /> Refazer </button>
                                        <button onClick={() => setIsTourOpen(true)} className="col-span-2 flex items-center justify-center text-sm px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-500 transition-colors"> <HelpIcon /> Ajuda & Tour Guiado </button>
                                        <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                    </div>
                                </div>
                            </div>
                        </div>
                         <footer className="text-center mt-12 py-8 text-sm text-gray-500 border-t border-gray-800">
                            <div className="flex flex-col items-center justify-center">
                                <p className="mb-2">Desenvolvido por:</p>
                                <img src="https://i.postimg.cc/dVgn73g8/Monocromatica-Horizontal.png" alt="Logo do Desenvolvedor" className="h-8 opacity-50" />
                            </div>
                        </footer>
                    </main>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

