<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle Financeiro Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Anima√ß√µes do Or√ßamento */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        @keyframes pulse-border { 0%, 100% { border-color: rgba(59, 130, 246, 0.4); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 50% { border-color: rgba(59, 130, 246, 1); box-shadow: 0 0 10px 2px rgba(59, 130, 246, 0.2); } }
        .animate-pulse-border { animation: pulse-border 2s infinite; border: 2px solid; }
        @keyframes fade-in-down { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .animate-fade-in-down { animation: fade-in-down 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            setDoc, 
            getDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        window.firebase = {
             initializeApp,
             getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut,
             getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, PieChart, Pie, Cell } = Recharts;

        // --- Configura√ß√£o e Inicializa√ß√£o do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCjRdWFxR07ryhlI4bB8XJjBoxqXjw2LBE",
            authDomain: "guardecontrolefinanceiro.firebaseapp.com",
            projectId: "guardecontrolefinanceiro",
            storageBucket: "guardecontrolefinanceiro.appspot.com",
            messagingSenderId: "930219640587",
            appId: "1:930219640587:web:eca78fa4a2fb62960a040e",
            measurementId: "G-9D98TPEQ7V"
        };
        
        const {
            initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
            GoogleAuthProvider, signInWithPopup, signOut, getFirestore, collection, doc, onSnapshot,
            addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        } = window.firebase;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.appId || 'default-app-id';

        // --- Cores e √çcones Globais ---
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658'];

        // --- √çcones B√°sicos SVG (Originais) ---
        const TrashIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-400 hover:text-red-300"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> );
        const EditIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-400 hover:text-blue-300"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> );
        const ShieldIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> );
        const ExportIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> );
        const ImportIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 5 17 10"></polyline><line x1="12" y1="5" x2="12" y2="19"></line></svg> );
        const UndoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg> );
        const RedoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"></path></svg> );
        const HelpIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> );
        const LogoutIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> );
        const GoogleIcon = () => ( <svg className="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 109.8 512 0 402.2 0 261.8 0 122.4 109.8 13.6 244 13.6c70.3 0 129.8 27.8 174.3 71.9l-64.8 64.8C327.5 112.5 289.1 90.9 244 90.9c-86.1 0-156.2 69.1-156.2 154.9s70.1 154.9 156.2 154.9c94.2 0 135.3-72.2 140.8-109.9H244V261.8h244z"></path></svg> );
        const SortAscIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-blue-400"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z"></path></svg> );
        const SortDescIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-blue-400"><path d="M12 16l-6-6 1.41-1.41L12 13.17l4.59-4.58L18 10l-6 6z"></path></svg> );
        const NeutralSortIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity"><path d="m7 15 5 5 5-5"></path><path d="m7 9 5-5 5 5"></path></svg> );
        const ResetIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2M20 19v-4h-4"/></svg> );
        const CalculatorIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg> );
        const AdjustIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> );
        const InfoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block ml-1 text-yellow-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg> );
        const SettingsIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-300 hover:text-white transition-colors"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> );

        const SortIndicator = ({ sortConfig, columnKey }) => { if (sortConfig.key === columnKey) { return sortConfig.direction === 'ascending' ? <SortAscIcon /> : <SortDescIcon />; } return <NeutralSortIcon />; };
        
        // --- √çcones do Or√ßamento (Budget) mapeados para Lucide-like SVG ---
        // Para evitar depend√™ncia de build system, definimos os componentes de √≠cones usados no Budget aqui
        const BudgetIcons = {
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="m9 18 6-6-6-6"/></svg>,
            Folder: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            ArrowLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            DollarSign: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            BookOpen: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M20 6 9 17l-5-5"/></svg>,
            RefreshCw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 21h-5v-5"/></svg>,
            Eye: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Layers: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="m6 9 6 6 6-6"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            MessageSquare: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>,
            Undo2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>,
            Redo2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg>,
            Pause: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>,
            Play: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Copy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            MoreVertical: (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size||24} height={props.size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
        };

        // --- SUB-APLICA√á√ÉO: OR√áAMENTO (BudgetApp) ---
        // Dados iniciais para o estado da aplica√ß√£o.
        const budgetInitialData = {
            income: 0,
            categories: [],
        };

        // Paleta de cores para as categorias.
        const availableColors = [
            'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-red-500', 
            'bg-yellow-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'
        ];

        // Modelos de or√ßamento pr√©-definidos.
        const budgetPresets = [
            {
                name: 'Sugest√£o do App',
                description: 'Um modelo balanceado para despesas comuns no Brasil.',
                icon: BudgetIcons.Star,
                categories: [
                    { name: 'üè† Casa', percentage: 27.5, color: 'bg-blue-500', group: 'Custos de Vida' },
                    { name: 'üë∂ Filhos', percentage: 21.5, color: 'bg-green-500', group: 'Custos de Vida' },
                    { name: 'üë§ Pessoal', percentage: 23.5, color: 'bg-purple-500', group: 'Custos de Vida' },
                    { name: 'üöó Carro', percentage: 17.5, color: 'bg-red-500', group: 'Custos de Vida' },
                    { name: 'üëµ Aposentadoria', percentage: 10.0, color: 'bg-yellow-500', group: 'Investimentos' },
                ]
            },
            {
                name: 'Pai Rico, Pai Pobre',
                description: 'Inspirado em Robert Kiyosaki, foca em "pague-se primeiro".',
                icon: BudgetIcons.BookOpen,
                categories: [
                    { name: 'üí∞ Pague-se Primeiro', percentage: 30, color: 'bg-purple-500', group: 'Investimentos' },
                    { name: '‚úÖ Necessidades', percentage: 60, color: 'bg-blue-500', group: 'Necessidades' },
                    { name: 'üõçÔ∏è Desejos', percentage: 10, color: 'bg-pink-500', group: 'Desejos' },
                ]
            },
            {
                name: '50/30/20',
                description: 'Equil√≠brio cl√°ssico: Essenciais, Desejos e Investimentos.',
                icon: BudgetIcons.BookOpen,
                categories: [
                    { name: '‚úÖ Essenciais', percentage: 50, color: 'bg-blue-500', group: 'Essenciais' },
                    { name: 'üõçÔ∏è Desejos', percentage: 30, color: 'bg-pink-500', group: 'N√£o Essenciais' },
                    { name: 'üìà Investimentos', percentage: 20, color: 'bg-purple-500', group: 'Investimentos' },
                ]
            }
        ];

        // Hook personalizado para gerir o estado com hist√≥rico (desfazer/refazer).
        const useHistoryState = (initialState) => {
            const [state, setState] = useState({
                past: [],
                present: initialState,
                future: [],
            });

            const canUndo = state.past.length > 0;
            const canRedo = state.future.length > 0;

            const undo = () => {
                if (!canUndo) return;
                const newFuture = [state.present, ...state.future];
                const newPresent = state.past[state.past.length - 1];
                const newPast = state.past.slice(0, state.past.length - 1);
                setState({ past: newPast, present: newPresent, future: newFuture });
            };

            const redo = () => {
                if (!canRedo) return;
                const newPast = [...state.past, state.present];
                const newPresent = state.future[0];
                const newFuture = state.future.slice(1);
                setState({ past: newPast, present: newPresent, future: newFuture });
            };

            const set = (newPresent) => {
                if (JSON.stringify(newPresent) === JSON.stringify(state.present)) {
                    return; 
                }
                setState({
                    past: [...state.past, state.present],
                    present: newPresent,
                    future: [], 
                });
            };
            
            const setInitial = (newPresent) => {
                setState({
                    past: [],
                    present: newPresent,
                    future: [],
                });
            }

            return { state: state.present, set, undo, redo, canUndo, canRedo, setInitial };
        };

        const formatCurrency = (value) => {
            if (typeof value !== 'number' || isNaN(value)) {
                value = 0;
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(value);
        };

        const BudgetModal = ({ children, isOpen, onClose, maxWidth = 'max-w-md' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className={`bg-gray-800 rounded-2xl shadow-2xl w-full ${maxWidth} m-4`}>
                        <div className="relative p-6">
                            <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                                <BudgetIcons.X size={24} />
                            </button>
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const BudgetConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <BudgetModal isOpen={isOpen} onClose={onClose}>
                    <div className="text-white flex flex-col items-center text-center">
                        <div className="w-16 h-16 flex items-center justify-center bg-yellow-500/20 rounded-full mb-4">
                            <BudgetIcons.AlertTriangle size={40} className="text-yellow-500" />
                        </div>
                        <h3 className="text-xl font-bold mb-2">{title}</h3>
                        <p className="text-gray-300 mb-6">{message}</p>
                        <div className="flex justify-center space-x-4 w-full">
                            <button type="button" onClick={onClose} className="flex-1 px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancelar</button>
                            <button type="button" onClick={onConfirm} className="flex-1 px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 font-semibold transition">Confirmar</button>
                        </div>
                    </div>
                </BudgetModal>
            );
        };

        const PaymentAmountModal = ({ isOpen, onClose, onSubmit, expense }) => {
            const [amount, setAmount] = useState('');
            useEffect(() => {
                if (isOpen && expense) {
                    setAmount(String(expense.installmentValue || '').replace('.', ','));
                }
            }, [isOpen, expense]);
            const handleSubmit = (e) => {
                e.preventDefault();
                const parsedAmount = parseFloat(String(amount).replace(',', '.'));
                if (!isNaN(parsedAmount) && parsedAmount >= 0) { onSubmit(parsedAmount); }
            };
            if (!isOpen) return null;
            return (
                <BudgetModal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-4 text-white">
                        <h3 className="text-xl font-bold">Registrar Pagamento</h3>
                        <p>Qual foi o valor pago para a despesa <span className="font-bold">{expense?.description}</span>?</p>
                        <div>
                            <label className="block text-sm font-medium text-gray-400 mb-1">Valor Pago (R$)</label>
                            <input type="text" inputMode="decimal" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required autoFocus />
                        </div>
                        <div className="flex justify-end space-x-3 pt-4">
                            <button type="button" onClick={onClose} className="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancelar</button>
                            <button type="submit" className="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 font-semibold transition">Confirmar Pagamento</button>
                        </div>
                    </form>
                </BudgetModal>
            );
        };

        const PresetModal = ({ isOpen, onClose, onSelectPreset }) => {
            return (
                <BudgetModal isOpen={isOpen} onClose={onClose} maxWidth="max-w-4xl">
                    <div className="text-white">
                        <h3 className="text-2xl font-bold mb-2 text-center">Escolha um Modelo de Or√ßamento</h3>
                        <p className="text-gray-400 mb-8 text-center">Comece rapidamente com um modelo pr√©-definido por especialistas.</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {budgetPresets.map(preset => {
                                const Icon = preset.icon;
                                return (
                                    <div key={preset.name} onClick={() => onSelectPreset(preset)} className="bg-gray-700/50 p-6 rounded-xl border border-gray-700 hover:border-blue-500 hover:bg-gray-700 cursor-pointer transition-all flex flex-col">
                                        <div className="flex items-center mb-3">
                                            <Icon className="text-blue-400 mr-3" size={24} />
                                            <h4 className="text-lg font-bold">{preset.name}</h4>
                                        </div>
                                        <p className="text-gray-400 text-sm mb-4 flex-grow">{preset.description}</p>
                                        <ul className="space-y-2 text-sm">
                                            {preset.categories.map(cat => (
                                                <li key={cat.name} className="flex items-center">
                                                    <div className={`w-3 h-3 rounded-full mr-3 ${cat.color}`}></div>
                                                    <span className="text-gray-300 truncate" title={cat.name}>{cat.name}</span>
                                                    <span className="ml-auto font-mono text-gray-400">{cat.percentage}%</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </BudgetModal>
            );
        };

        const EditGroupModal = ({ isOpen, onClose, onSubmit, groupName }) => {
            const [newGroupName, setNewGroupName] = useState(groupName || '');
            useEffect(() => { if (isOpen) { setNewGroupName(groupName); } }, [isOpen, groupName]);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (newGroupName.trim() && newGroupName.trim() !== groupName) { onSubmit(groupName, newGroupName.trim()); }
                onClose();
            };
            return (
                <BudgetModal isOpen={isOpen} onClose={onClose}>
                    <form onSubmit={handleSubmit} className="space-y-6 text-white">
                        <h3 className="text-xl font-bold">Editar Nome do Grupo</h3>
                        <div>
                            <label className="block text-sm font-medium text-gray-400 mb-2">Novo nome para "{groupName}"</label>
                            <input type="text" value={newGroupName} onChange={(e) => setNewGroupName(e.target.value)} className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required autoFocus />
                        </div>
                        <div className="flex justify-end space-x-3 pt-4">
                            <button type="button" onClick={onClose} className="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancelar</button>
                            <button type="submit" className="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 font-semibold transition">Salvar Altera√ß√µes</button>
                        </div>
                    </form>
                </BudgetModal>
            );
        };

        const CategoryForm = ({ onSubmit, onCancel, categoryData, existingGroups = [] }) => {
            const [name, setName] = useState(categoryData?.name || '');
            const [group, setGroup] = useState(categoryData?.group || '');
            const [color, setColor] = useState(categoryData?.color || availableColors[0]);
            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit({ ...categoryData, name, group, color });
            };
            return (
                <form onSubmit={handleSubmit} className="space-y-6">
                    <h3 className="text-xl font-bold text-white mb-4">{categoryData?.id ? 'Editar Categoria' : 'Nova Categoria'}</h3>
                    <div>
                        <label className="block text-sm font-medium text-gray-400 mb-2">Nome da Categoria</label>
                        <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-400 mb-2">Grupo (Opcional)</label>
                        <input type="text" value={group} onChange={(e) => setGroup(e.target.value)} placeholder="Digite ou selecione um grupo existente" className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" list="group-suggestions" />
                        <datalist id="group-suggestions"> {existingGroups.map(g => ( <option key={g} value={g} /> ))} </datalist>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-400 mb-2">Cor</label>
                        <div className="flex flex-wrap gap-3">
                            {availableColors.map(c => ( <div key={c} onClick={() => setColor(c)} className={`w-10 h-10 rounded-full cursor-pointer ${c} transition-transform transform hover:scale-110 ${color === c ? 'ring-2 ring-offset-2 ring-offset-gray-800 ring-white' : ''}`}></div> ))}
                        </div>
                    </div>
                    <div className="flex justify-end space-x-3 pt-4">
                        <button type="button" onClick={onCancel} className="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancelar</button>
                        <button type="submit" className="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 font-semibold transition">Salvar</button>
                    </div>
                </form>
            );
        };

        const ExpenseForm = ({ onSubmit, onCancel, expenseData }) => {
            const [description, setDescription] = useState(expenseData?.description || '');
            const [totalValue, setTotalValue] = useState(expenseData?.totalValue || '');
            const [installments, setInstallments] = useState(expenseData?.installments > 1 && expenseData?.installments < 9999 ? expenseData.installments : 1);
            const [status, setStatus] = useState(expenseData?.status || 'Andamento');
            const [startDate, setStartDate] = useState(expenseData?.startDate || new Date().toISOString().split('T')[0]);
            const [observation, setObservation] = useState(expenseData?.observation || '');
            const [finalInstallmentDate, setFinalInstallmentDate] = useState(null);

            useEffect(() => {
                if (status === 'Andamento' && startDate && installments > 1) {
                    const parsedInstallments = parseInt(installments, 10);
                    if (!isNaN(parsedInstallments) && parsedInstallments > 1) {
                        const start = new Date(startDate);
                        const final = new Date(start.getFullYear(), start.getMonth() + parsedInstallments - 1, start.getDate() + 1);
                        setFinalInstallmentDate(final);
                    } else { setFinalInstallmentDate(null); }
                } else { setFinalInstallmentDate(null); }
            }, [startDate, installments, status]);

            const handleSubmit = (e) => {
                e.preventDefault();
                const parsedValue = parseFloat(String(totalValue).replace(',', '.')) || 0;
                let expensePayload = {
                    id: expenseData?.id || Date.now(),
                    description, status, startDate, observation,
                    paidInstallments: expenseData?.paidInstallments || 0,
                    isPaused: expenseData?.isPaused || false,
                };
                if (status === 'Andamento') {
                    const parsedInstallments = parseInt(installments, 10) || 1;
                    expensePayload = { ...expensePayload, totalValue: parsedValue, installments: parsedInstallments, installmentValue: parsedInstallments > 0 ? parsedValue / parsedInstallments : parsedValue };
                } else if (status === 'Fixa-Vari√°vel') {
                    expensePayload = { ...expensePayload, totalValue: parsedValue, installments: 9999, installmentValue: parsedValue, paymentHistory: expenseData?.paymentHistory || [] };
                } else {
                    expensePayload = { ...expensePayload, totalValue: parsedValue, installments: status === 'Fixo' ? 9999 : 1, installmentValue: parsedValue };
                }
                onSubmit(expensePayload);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h3 className="text-xl font-bold text-white mb-4">{expenseData ? 'Editar Despesa' : 'Adicionar Despesa'}</h3>
                    <div> <label className="block text-sm font-medium text-gray-400 mb-1">Descri√ß√£o</label> <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required /> </div>
                    <div> <label className="block text-sm font-medium text-gray-400 mb-1">{status === 'Andamento' ? 'Valor Total da Compra' : 'Valor da Despesa (ou 1¬∫ Pagamento)'}</label> <input type="text" inputMode="decimal" value={String(totalValue).replace('.', ',')} onChange={(e) => setTotalValue(e.target.value)} className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required /> </div>
                    <div className={`grid ${status === 'Andamento' ? 'grid-cols-2' : 'grid-cols-1'} gap-4`}>
                        {status === 'Andamento' && ( <div> <label className="block text-sm font-medium text-gray-400 mb-1">N¬∫ de Parcelas</label> <input type="number" value={installments} onChange={(e) => setInstallments(e.target.value)} min="1" className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required /> {finalInstallmentDate && ( <p className="text-xs text-gray-400 mt-2"> √öltima parcela em: {finalInstallmentDate.toLocaleDateString('pt-BR')} </p> )} </div> )}
                        <div> <label className="block text-sm font-medium text-gray-400 mb-1">{status === 'Andamento' ? 'Data da 1¬™ Parcela' : 'Data do Vencimento'}</label> <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required /> </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-400 mb-1">Tipo de Despesa</label>
                        <select value={status} onChange={(e) => setStatus(e.target.value)} className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="Andamento">Andamento (Parcelado)</option>
                            <option value="Fixo">Fixo (Valor Fixo)</option>
                            <option value="Fixa-Vari√°vel">Fixo (Valor Vari√°vel)</option>
                            <option value="Vari√°vel">Vari√°vel (Pagamento √önico)</option>
                        </select>
                    </div>
                    <div> <label className="block text-sm font-medium text-gray-400 mb-1">Observa√ß√£o (Opcional)</label> <textarea value={observation} onChange={(e) => setObservation(e.target.value)} rows="3" className="w-full bg-gray-700 text-white rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" ></textarea> </div>
                    <div className="flex justify-end space-x-3 pt-4"> <button type="button" onClick={onCancel} className="px-6 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition">Cancelar</button> <button type="submit" className="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 font-semibold transition">Salvar</button> </div>
                </form>
            );
        };

        const ExpenseList = ({ category, onBack, onUpdateExpense, onDeleteExpense, onAddExpense, onMarkAsPaid, onUndoPayment, onOpenPaymentModal, onTogglePause, onDuplicateExpense }) => {
            const [isExpenseModalOpen, setExpenseModalOpen] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [isConfirmationModalOpen, setConfirmationModalOpen] = useState(false);
            const [expenseToDelete, setExpenseToDelete] = useState(null);
            const [isActionModalOpen, setIsActionModalOpen] = useState(false);
            const [selectedExpenseForAction, setSelectedExpenseForAction] = useState(null);

            const openActionsModal = (expense) => { setSelectedExpenseForAction(expense); setIsActionModalOpen(true); };
            const closeActionsModal = () => { setIsActionModalOpen(false); setSelectedExpenseForAction(null); };
            const handleAddClick = () => { setEditingExpense(null); setExpenseModalOpen(true); };
            const handleEditClick = (expense) => { setEditingExpense(expense); setExpenseModalOpen(true); closeActionsModal(); };
            const handleDeleteRequest = (expenseId) => { setExpenseToDelete(expenseId); setConfirmationModalOpen(true); closeActionsModal(); };
            const confirmDelete = () => { onDeleteExpense(category.id, expenseToDelete); setConfirmationModalOpen(false); setExpenseToDelete(null); };
            const handleFormSubmit = (expenseData) => { if (editingExpense) { onUpdateExpense(category.id, expenseData); } else { onAddExpense(category.id, expenseData); } setExpenseModalOpen(false); setEditingExpense(null); };

            const totalCategoryValue = category.expenses.filter(exp => !exp.isPaused).reduce((sum, exp) => sum + exp.installmentValue, 0);
            const budgetedValue = category.budgetedValue || 0;
            const availableValue = budgetedValue - totalCategoryValue;

            return (
                <div className="bg-gray-900 text-gray-200 p-4 sm:p-6 lg:p-8 rounded-2xl animate-fade-in">
                    <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                        <div className="flex items-center">
                            <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-700 transition mr-4"> <BudgetIcons.ArrowLeft size={24} /> </button>
                            <div className={`w-4 h-8 rounded mr-3 ${category.color}`}></div>
                            <h2 className="text-2xl sm:text-3xl font-bold text-white flex-grow">{category.name}</h2>
                        </div>
                        <div className="flex-shrink-0 grid grid-cols-3 gap-4 sm:gap-6 text-right w-full sm:w-auto">
                            <div> <p className="text-gray-400 text-sm">Or√ßado</p> <p className="text-xl font-bold text-white">{formatCurrency(budgetedValue)}</p> </div>
                            <div> <p className="text-gray-400 text-sm">Gasto</p> <p className="text-xl font-bold text-red-400">{formatCurrency(totalCategoryValue)}</p> </div>
                            <div> <p className="text-gray-400 text-sm">Dispon√≠vel</p> <p className={`text-xl font-bold ${availableValue >= 0 ? 'text-green-400' : 'text-yellow-400'}`}> {formatCurrency(availableValue)} </p> </div>
                        </div>
                    </div>
                    <div className="flex justify-end mb-6">
                        <button onClick={handleAddClick} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-transform transform hover:scale-105 shadow-lg"> <BudgetIcons.Plus size={20} /> Adicionar Despesa </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left table-auto">
                            <thead className="border-b-2 border-gray-700"> <tr className="text-sm text-gray-400"> <th className="p-3">Descri√ß√£o</th> <th className="p-3 text-right">Valor Mensal</th> <th className="p-3 text-center">Progresso</th> <th className="p-3 text-center">Status</th> <th className="p-3 text-center">A√ß√µes</th> </tr> </thead>
                            <tbody>
                                {category.expenses.length === 0 ? ( <tr> <td colSpan="5" className="text-center py-10 text-gray-500">Nenhuma despesa adicionada.</td> </tr> ) : category.expenses.map(expense => {
                                    const isPaused = expense.isPaused; const paidInstallments = expense.paidInstallments || 0; const isComplete = paidInstallments >= expense.installments;
                                    let dueDate = null; let isOverdue = false;
                                    if (expense.startDate) {
                                        const startDate = new Date(expense.startDate);
                                        dueDate = new Date(startDate.getFullYear(), startDate.getMonth() + paidInstallments, startDate.getDate() + 1);
                                        const today = new Date(); today.setHours(0, 0, 0, 0);
                                        if (today > dueDate && !isComplete && !isPaused) { isOverdue = true; }
                                    }
                                    const remainingInstallments = expense.installments - paidInstallments; const remainingValue = remainingInstallments * expense.installmentValue;
                                    const displayStatus = isPaused ? 'Pausado' : isComplete ? 'Pago' : (isOverdue ? 'Atrasado' : expense.status);
                                    return (
                                        <tr key={expense.id} className={`border-b border-gray-800 transition-colors ${isPaused ? 'bg-gray-800/60' : 'hover:bg-gray-800/50'} ${isOverdue && !isPaused ? 'bg-red-900/30' : ''}`}>
                                            <td className={`p-3 font-medium text-white transition-opacity ${isPaused ? 'opacity-60' : ''}`}>
                                                <div className="flex items-center gap-2"> <span>{expense.description}</span> {expense.observation && ( <div className="relative group flex-shrink-0"> <BudgetIcons.MessageSquare size={14} className="text-gray-500 cursor-pointer" /> <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-gray-900 border border-gray-700 text-white text-sm rounded-lg py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 shadow-xl"> <p className="font-semibold mb-1">Observa√ß√£o:</p> <p className="whitespace-pre-wrap">{expense.observation}</p> </div> </div> )} </div>
                                                {isOverdue && dueDate && <div className="text-xs text-red-400 font-semibold mt-1">Vencido em: {dueDate.toLocaleDateString('pt-BR')}</div>}
                                            </td>
                                            <td className={`p-3 text-right font-semibold text-blue-400 transition-opacity ${isPaused ? 'opacity-60' : ''}`}>{formatCurrency(expense.installmentValue)}</td>
                                            <td className={`p-3 text-center text-gray-300 transition-opacity ${isPaused ? 'opacity-60' : ''}`}>
                                                {(() => {
                                                    if (expense.status === 'Vari√°vel') return <span>Pag. √önica</span>;
                                                    if (expense.status === 'Fixo') return isComplete ? <span>Pago</span> : (dueDate ? <span className="text-xs">Pr√≥x. Venc: {dueDate.toLocaleDateString('pt-BR')}</span> : <span className="text-xs text-gray-500">Sem data</span>);
                                                    if (expense.status === 'Fixa-Vari√°vel') {
                                                        const hasHistory = expense.paymentHistory && expense.paymentHistory.length > 0;
                                                        const average = hasHistory ? expense.paymentHistory.reduce((sum, p) => sum + p.amount, 0) / expense.paymentHistory.length : 0;
                                                        return ( <div> {dueDate && <span className="text-xs">Pr√≥x. Venc: {dueDate.toLocaleDateString('pt-BR')}</span>} {hasHistory && ( <div className="text-xs text-gray-500" title="Valor m√©dio pago"> M√©dia: {formatCurrency(average)} </div> )} </div> );
                                                    }
                                                    return ( <div> <span className="font-mono">{paidInstallments} / {expense.installments}</span> <div className="text-xs text-gray-500" title="Valor restante"> Falta: {formatCurrency(remainingValue)} </div> </div> );
                                                })()}
                                            </td>
                                            <td className={`p-3 text-center transition-opacity ${isPaused ? 'opacity-60' : ''}`}> <span className={`px-3 py-1 text-xs font-bold rounded-full ${ displayStatus === 'Pausado' ? 'bg-gray-600/50 text-gray-400' : displayStatus === 'Pago' ? 'bg-green-500/20 text-green-400' : displayStatus === 'Atrasado' ? 'bg-red-500/20 text-red-400' : displayStatus === 'Andamento' ? 'bg-yellow-500/20 text-yellow-400' : displayStatus === 'Fixa-Vari√°vel' ? 'bg-indigo-500/20 text-indigo-400' : displayStatus === 'Fixo' ? 'bg-blue-500/20 text-blue-400' : 'bg-gray-500/20 text-gray-300' }`}> {displayStatus} </span> </td>
                                            <td className="p-3"> <div className="flex justify-center items-center"> <div className={`transition-opacity ${isPaused ? 'opacity-60' : ''}`}> {!isComplete && ( <button onClick={() => { if (expense.status === 'Fixa-Vari√°vel') { onOpenPaymentModal(expense); } else { onMarkAsPaid(category.id, expense.id); } }} disabled={isPaused} className="p-2 text-green-400 hover:bg-green-500/20 rounded-md transition disabled:cursor-not-allowed disabled:text-gray-600" title="Marcar esta parcela como paga"> <BudgetIcons.CheckCircle size={18} /> </button> )} </div> <button onClick={() => openActionsModal(expense)} className="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition"> <BudgetIcons.MoreVertical size={18} /> </button> </div> </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={isExpenseModalOpen} onClose={() => setExpenseModalOpen(false)}> <ExpenseForm onSubmit={handleFormSubmit} onCancel={() => setExpenseModalOpen(false)} expenseData={editingExpense} /> </Modal>
                    <BudgetConfirmationModal isOpen={isConfirmationModalOpen} onClose={() => setConfirmationModalOpen(false)} onConfirm={confirmDelete} title="Excluir Despesa" message="Tem certeza que deseja excluir esta despesa?" />
                    <Modal isOpen={isActionModalOpen} onClose={closeActionsModal} maxWidth="max-w-sm">
                        {selectedExpenseForAction && (
                            <div className="text-white">
                                <h3 className="text-lg font-bold mb-4 text-center">A√ß√µes para "{selectedExpenseForAction.description}"</h3>
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => handleEditClick(selectedExpenseForAction)} className="w-full text-left flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-600 hover:text-white rounded-md transition"><BudgetIcons.Edit size={16} /> Editar Despesa</button>
                                    <button onClick={() => { onDuplicateExpense(category.id, selectedExpenseForAction.id); closeActionsModal(); }} className="w-full text-left flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-600 hover:text-white rounded-md transition"><BudgetIcons.Copy size={16} /> Duplicar</button>
                                    <button onClick={() => { onTogglePause(category.id, selectedExpenseForAction.id); closeActionsModal(); }} className="w-full text-left flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-600 hover:text-white rounded-md transition"> {selectedExpenseForAction.isPaused ? <BudgetIcons.Play size={16} /> : <BudgetIcons.Pause size={16} />} {selectedExpenseForAction.isPaused ? 'Reativar Despesa' : 'Pausar Despesa'} </button>
                                    {(selectedExpenseForAction.paidInstallments || 0) > 0 && ( <button onClick={() => { onUndoPayment(category.id, selectedExpenseForAction.id); closeActionsModal(); }} className="w-full text-left flex items-center gap-3 px-3 py-2 text-yellow-400 hover:bg-yellow-500/20 rounded-md transition"><BudgetIcons.Undo2 size={16} /> Desfazer Pagamento</button> )}
                                    <div className="w-full h-px bg-gray-600 my-1"></div>
                                    <button onClick={() => handleDeleteRequest(selectedExpenseForAction.id)} className="w-full text-left flex items-center gap-3 px-3 py-2 text-red-400 hover:bg-red-500/20 rounded-md transition"><BudgetIcons.Trash2 size={16} /> Excluir Despesa</button>
                                </div>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };

        const CategoryItem = ({ category, income, onUpdateBudget, onSelectCategory, onEdit, onDelete, isPreviewing, onToggleLock, dragProps }) => {
            const [inputValue, setInputValue] = useState('0,00');
            const [inputPercent, setInputPercent] = useState('0,0');
            const [editMode, setEditMode] = useState('value');

            useEffect(() => {
                const newBudgetValue = category.budgetedValue || 0;
                const newPercentage = income > 0 ? (newBudgetValue / income) * 100 : 0;
                setInputValue(newBudgetValue.toFixed(2).replace('.', ','));
                setInputPercent(newPercentage.toFixed(1).replace('.', ','));
            }, [category.budgetedValue, income]);

            const handleValueChange = (e) => { setInputValue(e.target.value); };
            const handlePercentageChange = (e) => { setInputPercent(e.target.value); };
            const handleBlur = (source) => {
                if (category.isLocked) return;
                if (source === 'value') { onUpdateBudget(category.id, inputValue, 'value'); } else { onUpdateBudget(category.id, inputPercent, 'percent'); }
            };

            const actualExpenses = category.expenses.filter(exp => !exp.isPaused).reduce((sum, exp) => sum + exp.installmentValue, 0);
            const remaining = (category.budgetedValue || 0) - actualExpenses;
            const isOverBudget = remaining < 0;
            const progressBarWidth = (category.budgetedValue || 0) > 0 ? Math.min((actualExpenses / (category.budgetedValue || 0)) * 100, 100) : 0;
            const isBeingDragged = dragProps.draggedItem?.id === category.id;
            const isDragTarget = dragProps.dragOverItem?.id === category.id;
            const dragItemType = dragProps.draggedItem?.type;

            return (
                <div draggable={!isPreviewing} onDragStart={() => dragProps.onDragStart({ id: category.id, type: 'category', group: category.group || null })} onDragEnd={() => dragProps.onDragEnd()} onDrop={(e) => { e.preventDefault(); dragProps.onDrop({ id: category.id, type: 'category', group: category.group || null }); }} onDragOver={(e) => { e.preventDefault(); dragProps.onDragEnter({ id: category.id, type: 'category', group: category.group || null }); }} onDragLeave={(e) => { e.preventDefault(); dragProps.onDragLeave(); }} className={`bg-gray-700/50 rounded-xl transition-all group relative p-4 ${!isPreviewing ? 'cursor-grab' : ''} ${isPreviewing ? 'opacity-70' : ''} ${category.isLocked ? 'border-2 border-yellow-500/50' : 'border-2 border-transparent'} ${isBeingDragged ? 'opacity-50' : 'opacity-100'}`}>
                    {isDragTarget && !isBeingDragged && dragItemType === 'category' && <div className="absolute top-0 left-0 right-0 h-1 bg-blue-500 rounded-full animate-pulse"></div>}
                    <div className="flex items-center justify-between">
                        <div onClick={() => !isPreviewing && onSelectCategory(category)} className={`flex items-center flex-grow mr-4 min-w-0 ${!isPreviewing ? 'cursor-pointer' : 'cursor-default'}`}>
                            <div className={`w-3 h-6 rounded-sm mr-4 flex-shrink-0 ${category.color}`}></div>
                            <BudgetIcons.Folder size={20} className="text-gray-400 mr-3 hidden sm:block flex-shrink-0" />
                            <span className="font-semibold text-white truncate">{category.name}</span>
                        </div>
                        <div className="flex items-center flex-shrink-0">
                            <button onClick={() => !isPreviewing && onToggleLock(category.id)} disabled={isPreviewing} className={`p-2 text-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed ${category.isLocked ? 'text-yellow-400 hover:text-yellow-300' : 'hover:text-white'}`}> {category.isLocked ? <BudgetIcons.Lock size={18} /> : <BudgetIcons.Unlock size={18} />} </button>
                            <button onClick={() => !isPreviewing && onEdit(category)} disabled={isPreviewing || category.isLocked} className="p-2 text-gray-400 hover:text-blue-400 transition disabled:opacity-50 disabled:cursor-not-allowed"><BudgetIcons.Edit size={18} /></button>
                            <button onClick={() => !isPreviewing && onDelete(category.id)} disabled={isPreviewing} className="p-2 text-gray-400 hover:text-red-500 transition disabled:opacity-50 disabled:cursor-not-allowed"><BudgetIcons.Trash2 size={18} /></button>
                            {!isPreviewing && <BudgetIcons.ChevronRight size={20} className="text-gray-500 ml-2 group-hover:text-white transition" onClick={() => onSelectCategory(category)} />}
                        </div>
                    </div>
                    <div className="mt-4 flex items-center gap-2 text-sm">
                        {editMode === 'value' ? ( <> <div className="relative flex-grow"> <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">R$</span> <input type="text" inputMode="decimal" value={inputValue} onBlur={() => handleBlur('value')} onChange={handleValueChange} disabled={isPreviewing || category.isLocked} className="w-full bg-gray-700 text-white rounded-lg p-2 pl-9 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-800" /> </div> <div className="flex-shrink-0 bg-gray-800/60 text-gray-300 font-semibold text-base rounded-lg px-4 py-[9px]" title="Porcentagem da receita total"> <span>{inputPercent}%</span> </div> </> ) : ( <> <div className="relative flex-grow"> <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">%</span> <input type="text" inputMode="decimal" value={inputPercent} onBlur={() => handleBlur('percent')} onChange={handlePercentageChange} disabled={isPreviewing || category.isLocked} className="w-full bg-gray-700 text-white rounded-lg p-2 pr-8 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-800" /> </div> <div className="flex-shrink-0 bg-gray-800/60 text-gray-300 font-semibold text-base rounded-lg px-4 py-[9px]" title="Valor or√ßado em Reais"> <span>{formatCurrency(parseFloat(inputValue.replace(',', '.')))}</span> </div> </> )}
                        <button onClick={() => setEditMode(prev => prev === 'value' ? 'percent' : 'value')} disabled={isPreviewing || category.isLocked} className="p-2 text-gray-400 bg-gray-700 rounded-lg hover:bg-gray-600 hover:text-blue-400 transition disabled:opacity-50 disabled:cursor-not-allowed" title="Alternar modo de edi√ß√£o"> <BudgetIcons.RefreshCw size={18} /> </button>
                    </div>
                    <div className="mt-3 text-xs flex justify-between text-gray-400"> <span>Gasto: {formatCurrency(actualExpenses)}</span> <span className={isOverBudget ? 'text-red-400 font-bold' : 'text-green-400'}> {isOverBudget ? `Estourado: ${formatCurrency(Math.abs(remaining))}` : `Sobra: ${formatCurrency(remaining)}`} </span> </div>
                    <div className="w-full bg-gray-600 rounded-full h-2.5 mt-2"> <div className={`h-2.5 rounded-full ${isOverBudget ? 'bg-red-500' : category.color}`} style={{ width: `${progressBarWidth}%` }} ></div> </div>
                    {isDragTarget && !isBeingDragged && dragItemType === 'category' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-blue-500 rounded-full animate-pulse"></div>}
                </div>
            );
        };

        const PresetConfirmationBar = ({ onConfirm, onCancel }) => {
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-gray-800/90 backdrop-blur-sm p-4 z-40 animate-fade-in">
                    <div className="container mx-auto max-w-5xl flex justify-between items-center">
                        <p className="text-white font-semibold">Gostou desta sugest√£o de or√ßamento?</p>
                        <div className="flex gap-4">
                            <button onClick={onCancel} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-transform transform hover:scale-105 shadow-lg"> <BudgetIcons.RefreshCw size={18} /> Cancelar / Escolher Outra </button>
                            <button onClick={onConfirm} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-500 transition-transform transform hover:scale-105 shadow-lg"> <BudgetIcons.Check size={20} /> Confirmar Sugest√£o </button>
                        </div>
                    </div>
                </div>
            );
        };

        const BudgetAdjustmentBar = ({ totalPercentage, onAdjust }) => {
            const isOver = totalPercentage > 100;
            const difference = Math.abs(100 - totalPercentage);
            const message = isOver ? `Or√ßamento ${difference.toFixed(1)}% acima do total.` : `Faltam ${difference.toFixed(1)}% para completar o or√ßamento.`;
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-gray-800/95 backdrop-blur-sm p-4 z-40 animate-fade-in border-t-2 border-yellow-500 shadow-2xl">
                    <div className="container mx-auto max-w-5xl flex flex-col sm:flex-row justify-between items-center gap-3">
                        <div className="flex items-center gap-3 text-yellow-300"> <BudgetIcons.AlertTriangle size={24} /> <p className="font-semibold text-white">{message}</p> </div>
                        <button onClick={onAdjust} className="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-transform transform hover:scale-105 shadow-lg"> <BudgetIcons.RefreshCw size={18} /> Ajustar Or√ßamento </button>
                    </div>
                </div>
            );
        };

        const CategoryList = ({ categories, income, onSelectCategory, onUpdateIncome, onUpdateCategoryBudget, onOpenCategoryModal, onDeleteCategoryRequest, onDeleteGroupRequest, onOpenPresetModal, onExport, onImport, tempPresetCategories, onConfirmPreset, onCancelPreset, onToggleLock, onMoveItem, onOpenEditGroupModal, undo, redo, canUndo, canRedo }) => {
            const isPreviewing = tempPresetCategories !== null;
            const displayCategories = isPreviewing ? tempPresetCategories : categories;
            const totalExpenses = displayCategories.reduce((total, category) => total + (category.expenses || []).filter(exp => !exp.isPaused).reduce((sum, exp) => sum + exp.installmentValue, 0), 0);
            const balance = income - totalExpenses;
            const isIncomeSet = income > 0;
            const [newIncome, setNewIncome] = useState(String(income));
            const [isEditingIncome, setIsEditingIncome] = useState(false);
            const incomeInputRef = useRef(null);
            const [collapsedGroups, setCollapsedGroups] = useState({});
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverItem, setDragOverItem] = useState(null);

            const dragProps = {
                draggedItem, dragOverItem, onDragStart: (item) => setDraggedItem(item), onDrop: (targetItem) => { if (draggedItem) { onMoveItem(draggedItem, targetItem); } setDraggedItem(null); setDragOverItem(null); }, onDragEnter: (item) => { if (draggedItem && draggedItem.id !== item.id) { setDragOverItem(item); } }, onDragLeave: () => setDragOverItem(null), onDragEnd: () => { setDraggedItem(null); setDragOverItem(null); }
            };

            const toggleGroupCollapse = (groupName) => { setCollapsedGroups(prev => ({ ...prev, [groupName]: !prev[groupName] })); };
            useEffect(() => { setNewIncome(String(income).replace('.', ',')); }, [income]);
            useEffect(() => { if (isEditingIncome) { incomeInputRef.current?.focus(); incomeInputRef.current?.select(); } }, [isEditingIncome]);
            const handleIncomeBlur = () => { const value = parseFloat(String(newIncome).replace(',', '.')); if(!isNaN(value) && value >= 0) { onUpdateIncome(value); } else { setNewIncome(String(income).replace('.', ',')); } setIsEditingIncome(false); };
            const handleIncomeKeyDown = (e) => { if (e.key === 'Enter') { handleIncomeBlur(); } else if (e.key === 'Escape') { setNewIncome(String(income).replace('.', ',')); setIsEditingIncome(false); } };

            const categoriesWithGroup = displayCategories.filter(c => c.group && c.group.trim() !== '');
            const categoriesWithoutGroup = displayCategories.filter(c => !c.group || c.group.trim() === '');
            const groupedCategories = categoriesWithGroup.reduce((acc, category) => { const groupName = category.group.trim(); if (!acc[groupName]) { acc[groupName] = []; } acc[groupName].push(category); return acc; }, {});

            return (
                <div className="space-y-8 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className={`bg-gray-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-all ${!isIncomeSet && !isPreviewing ? 'animate-pulse-border' : 'border-2 border-transparent'}`}>
                            <div className="p-3 bg-green-500/20 rounded-xl"><BudgetIcons.DollarSign className="text-green-400" size={28}/></div>
                            <div> <p className="text-gray-400 text-sm">Sua Receita</p> {isEditingIncome ? ( <input ref={incomeInputRef} type="text" inputMode="decimal" value={newIncome} onChange={(e) => setNewIncome(e.target.value)} onBlur={handleIncomeBlur} onKeyDown={handleIncomeKeyDown} className="text-2xl font-bold text-white bg-transparent w-full focus:outline-none focus:ring-1 focus:ring-blue-500 rounded-md px-1 -mx-1"/> ) : ( <div onClick={() => !isPreviewing && setIsEditingIncome(true)} className={`text-2xl font-bold text-white flex items-center group ${!isPreviewing ? 'cursor-pointer' : 'cursor-default'}`}> <span>{formatCurrency(income)}</span> {!isPreviewing && <BudgetIcons.Edit size={16} className="ml-2 text-gray-500 group-hover:text-white transition-colors opacity-0 group-hover:opacity-100" />} </div> )} </div>
                        </div>
                        <div className="bg-gray-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4"> <div className="p-3 bg-red-500/20 rounded-xl"><BudgetIcons.DollarSign className="text-red-400" size={28}/></div> <div> <p className="text-gray-400 text-sm">Total de Despesas</p> <p className="text-2xl font-bold text-white">{formatCurrency(totalExpenses)}</p> </div> </div>
                        <div className="bg-gray-800 p-6 rounded-2xl shadow-lg flex items-center space-x-4"> <div className={`p-3 rounded-xl ${balance >= 0 ? 'bg-blue-500/20' : 'bg-yellow-500/20'}`}><BudgetIcons.DollarSign className={`${balance >= 0 ? 'text-blue-400' : 'text-yellow-400'}`} size={28}/></div> <div> <p className="text-gray-400 text-sm">Saldo Restante</p> <p className={`text-2xl font-bold ${balance >= 0 ? 'text-white' : 'text-yellow-400'}`}>{formatCurrency(balance)}</p> </div> </div>
                    </div>
                    <div className="bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 className="text-xl font-bold text-white">Or√ßamento por Categoria</h2>
                            <div className="flex items-center gap-3 flex-wrap">
                                <button onClick={undo} disabled={!canUndo || isPreviewing} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed"><BudgetIcons.Undo2 size={20} />Desfazer</button>
                                <button onClick={redo} disabled={!canRedo || isPreviewing} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition disabled:opacity-50 disabled:cursor-not-allowed"><BudgetIcons.Redo2 size={20} />Refazer</button>
                                <button onClick={onImport} disabled={isPreviewing} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-transform transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"><BudgetIcons.Upload size={20} />Importar</button>
                                <button onClick={onExport} disabled={isPreviewing} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-transform transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"><BudgetIcons.Download size={20} />Exportar</button>
                                <button onClick={() => isIncomeSet && onOpenCategoryModal()} disabled={!isIncomeSet || isPreviewing} title={!isIncomeSet ? "Adicione sua receita primeiro." : isPreviewing ? "Confirme ou cancele a sugest√£o atual." : "Nova Categoria"} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-white transition-all transform shadow-lg ${isIncomeSet && !isPreviewing ? 'bg-blue-600 hover:bg-blue-500 hover:scale-105' : 'bg-gray-600 opacity-50 cursor-not-allowed'}`}><BudgetIcons.Plus size={20} />Nova</button>
                            </div>
                        </div>
                        {isPreviewing && ( <div className="bg-blue-900/50 border-2 border-dashed border-blue-700 text-blue-200 px-4 py-3 rounded-xl mb-6 text-center animate-fade-in flex items-center justify-center gap-3"> <BudgetIcons.Eye size={20} /><p className="font-bold">Veja essa sugest√£o de or√ßamento.</p> </div> )}
                        <div className="space-y-6">
                            {Object.keys(groupedCategories).length === 0 && categoriesWithoutGroup.length === 0 ? (
                                <div className="text-center py-10 px-4 border-2 border-dashed border-gray-700 rounded-xl">
                                    <BudgetIcons.Folder size={40} className="mx-auto text-gray-500" />
                                    <p className="mt-4 text-gray-300 font-semibold">Seu or√ßamento est√° vazio.</p>
                                    <p className="text-sm text-gray-400 mt-2">Comece definindo sua receita e depois crie categorias ou use um modelo.</p>
                                    <button onClick={() => isIncomeSet && onOpenPresetModal()} disabled={!isIncomeSet || isPreviewing} title={!isIncomeSet ? "Adicione sua receita primeiro." : isPreviewing ? "Confirme ou cancele a sugest√£o atual." : "Usar Modelo"} className={`mt-6 flex items-center gap-2 mx-auto px-5 py-2.5 rounded-lg text-white transition-all transform shadow-lg ${isIncomeSet && !isPreviewing ? 'bg-blue-600 hover:bg-blue-500 hover:scale-105' : 'bg-gray-600 opacity-50 cursor-not-allowed'}`}><BudgetIcons.Star size={20} />Usar Modelo de Or√ßamento</button>
                                </div>
                            ) : (
                                <>
                                    {Object.entries(groupedCategories).map(([groupName, categoriesInGroup]) => {
                                        const groupBudgetedValue = categoriesInGroup.reduce((sum, cat) => sum + (cat.budgetedValue || 0), 0);
                                        const groupExpenses = categoriesInGroup.reduce((sum, cat) => sum + (cat.expenses || []).filter(exp => !exp.isPaused).reduce((expSum, exp) => expSum + exp.installmentValue, 0), 0);
                                        const groupPercentage = income > 0 ? (groupBudgetedValue / income) * 100 : 0;
                                        const isCollapsed = collapsedGroups[groupName];
                                        const isGroupBeingDragged = dragProps.draggedItem?.id === groupName;
                                        const isGroupDragTarget = dragProps.dragOverItem?.id === groupName;
                                        const dragItemType = dragProps.draggedItem?.type;
                                        return (
                                            <div key={groupName} className="relative">
                                                {isGroupDragTarget && !isGroupBeingDragged && dragItemType === 'group' && <div className="absolute top-0 left-0 right-0 h-1 bg-blue-500 rounded-full animate-pulse"></div>}
                                                <div draggable={!isPreviewing} onDragStart={() => dragProps.onDragStart({ id: groupName, type: 'group' })} onDragEnd={() => dragProps.onDragEnd()} onDrop={(e) => { e.preventDefault(); dragProps.onDrop({ id: groupName, type: 'group' }); }} onDragOver={(e) => { e.preventDefault(); dragProps.onDragEnter({ id: groupName, type: 'group' }); }} onDragLeave={(e) => { e.preventDefault(); dragProps.onDragLeave(); }} className={`w-full flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 p-3 bg-gray-800/50 rounded-lg gap-2 text-left hover:bg-gray-700/70 transition-colors ${!isPreviewing ? 'cursor-grab' : ''} ${isGroupBeingDragged ? 'opacity-50' : ''}`} >
                                                    <div className="flex items-center flex-grow cursor-pointer" onClick={() => toggleGroupCollapse(groupName)}>
                                                        <BudgetIcons.Layers size={18} className="text-gray-400 mr-3" /><h3 className="text-lg font-semibold text-white uppercase tracking-wider">{groupName}</h3>
                                                        <BudgetIcons.ChevronDown size={20} className={`ml-3 text-gray-500 transition-transform transform ${isCollapsed ? '-rotate-90' : 'rotate-0'}`} />
                                                    </div>
                                                    <div className="flex items-center gap-2 text-sm w-full sm:w-auto justify-end">
                                                        <div><span className="text-gray-400">Gasto: </span><span className="font-semibold text-white">{formatCurrency(groupExpenses)}</span></div>
                                                        <div className="text-right"><span className="font-bold text-white">{formatCurrency(groupBudgetedValue)}</span><span className="ml-2 text-gray-400 font-mono">({groupPercentage.toFixed(1)}%)</span></div>
                                                        <button onClick={(e) => { e.stopPropagation(); onOpenEditGroupModal(groupName); }} disabled={isPreviewing} className="p-1 text-gray-500 hover:text-blue-400 transition disabled:opacity-50" title={`Editar o nome do grupo "${groupName}"`} > <BudgetIcons.Edit size={18} /> </button>
                                                        <button onClick={(e) => { e.stopPropagation(); onDeleteGroupRequest(groupName); }} disabled={isPreviewing} className="p-1 text-gray-500 hover:text-red-400 transition disabled:opacity-50" title={`Excluir o grupo "${groupName}"`} > <BudgetIcons.Trash2 size={18} /> </button>
                                                    </div>
                                                </div>
                                                {!isCollapsed && ( <div className="space-y-4 pl-4 border-l-2 border-gray-700/50 ml-3 animate-fade-in-down"> {categoriesInGroup.map(category => ( <CategoryItem key={category.id} category={category} income={income} onUpdateBudget={onUpdateCategoryBudget} onSelectCategory={onSelectCategory} onEdit={onOpenCategoryModal} onDelete={onDeleteCategoryRequest} isPreviewing={isPreviewing} onToggleLock={onToggleLock} dragProps={dragProps}/> ))} </div> )}
                                                {isGroupDragTarget && !isGroupBeingDragged && dragItemType === 'group' && <div className="absolute bottom-0 left-0 right-0 h-1 bg-blue-500 rounded-full animate-pulse"></div>}
                                            </div>
                                        );
                                    })}
                                    {categoriesWithoutGroup.length > 0 && ( <div className="space-y-4 pt-6"> {categoriesWithoutGroup.map(category => ( <CategoryItem key={category.id} category={category} income={income} onUpdateBudget={onUpdateCategoryBudget} onSelectCategory={onSelectCategory} onEdit={onOpenCategoryModal} onDelete={onDeleteCategoryRequest} isPreviewing={isPreviewing} onToggleLock={onToggleLock} dragProps={dragProps}/> ))} </div> )}
                                </>
                            )}
                        </div>
                    </div>
                    {isPreviewing && <PresetConfirmationBar onConfirm={onConfirmPreset} onCancel={onCancelPreset} />}
                </div>
            );
        };

        const BudgetApp = ({ autoIncome }) => {
            const { state: data, set: setData, undo, redo, canUndo, canRedo, setInitial: setInitialData } = useHistoryState(budgetInitialData);
            
            // AUTOMATION: If autoIncome provided and income is 0, update it.
            useEffect(() => {
                if (autoIncome > 0 && data.income === 0) {
                    setData({ ...data, income: autoIncome });
                }
            }, [autoIncome]);

            const [selectedCategory, setSelectedCategory] = useState(null);
            const [isCategoryModalOpen, setIsCategoryModalOpen] = useState(false);
            const [editingCategory, setEditingCategory] = useState(null);
            const [isDeleteConfirmOpen, setDeleteConfirmOpen] = useState(false);
            const [categoryToDelete, setCategoryToDelete] = useState(null);
            const [isDeleteGroupConfirmOpen, setDeleteGroupConfirmOpen] = useState(false);
            const [groupToDelete, setGroupToDelete] = useState(null);
            const [isPresetModalOpen, setIsPresetModalOpen] = useState(false);
            const [isImportConfirmOpen, setImportConfirmOpen] = useState(false);
            const [fileToImport, setFileToImport] = useState(null);
            const fileInputRef = useRef(null);
            const [tempPresetCategories, setTempPresetCategories] = useState(null);
            const [isPaymentModalOpen, setPaymentModalOpen] = useState(false);
            const [expenseToPay, setExpenseToPay] = useState(null);
            const [isEditGroupModalOpen, setEditGroupModalOpen] = useState(false);
            const [editingGroup, setEditingGroup] = useState(null);

            const existingGroups = [...new Set(data.categories.map(c => c.group).filter(g => g && g.trim() !== ''))];

            const handleOpenCategoryModal = (category = null) => { if (data.income <= 0 && !category) return; setEditingCategory(category); setIsCategoryModalOpen(true); };
            const handleCloseCategoryModal = () => { setEditingCategory(null); setIsCategoryModalOpen(false); };
            const handleSelectPreset = (preset) => { if (data.income <= 0) return; const newCategories = preset.categories.map(cat => ({ id: Date.now() + Math.random(), name: cat.name, color: cat.color, group: cat.group || '', budgetedValue: (data.income * cat.percentage) / 100, expenses: [], isLocked: false, })); setTempPresetCategories(newCategories); setIsPresetModalOpen(false); };
            const handleConfirmPreset = () => { setData({ ...data, categories: tempPresetCategories }); setTempPresetCategories(null); };
            const handleCancelPreset = () => { setTempPresetCategories(null); setIsPresetModalOpen(true); };
            const handleCategorySubmit = (categoryData) => { let newCategories; if (categoryData.id) { newCategories = data.categories.map(cat => cat.id === categoryData.id ? { ...cat, ...categoryData } : cat ); } else { const newCategory = { ...categoryData, id: Date.now(), budgetedValue: 0, expenses: [], isLocked: false, }; newCategories = [...data.categories, newCategory]; } setData({ ...data, categories: newCategories }); handleCloseCategoryModal(); };
            const handleDeleteCategoryRequest = (categoryId) => { setCategoryToDelete(categoryId); setDeleteConfirmOpen(true); };
            const confirmDeleteCategory = () => { if (categoryToDelete) { const newCategories = data.categories.filter(cat => cat.id !== categoryToDelete); setData({ ...data, categories: newCategories }); } setDeleteConfirmOpen(false); setCategoryToDelete(null); };
            const handleDeleteGroupRequest = (groupName) => { setGroupToDelete(groupName); setDeleteGroupConfirmOpen(true); };
            const confirmDeleteGroup = () => { if (groupToDelete) { const newCategories = data.categories.map(cat => { if (cat.group === groupToDelete) { return { ...cat, group: '' }; } return cat; }); setData({ ...data, categories: newCategories }); } setDeleteGroupConfirmOpen(false); setGroupToDelete(null); };
            const handleOpenEditGroupModal = (groupName) => { setEditingGroup(groupName); setEditGroupModalOpen(true); };
            const handleCloseEditGroupModal = () => { setEditingGroup(null); setEditGroupModalOpen(false); };
            const handleUpdateGroupName = (oldName, newName) => { const newCategories = data.categories.map(cat => { if (cat.group === oldName) { return { ...cat, group: newName }; } return cat; }); setData({ ...data, categories: newCategories }); handleCloseEditGroupModal(); };
            const handleSelectCategory = (category) => { setSelectedCategory(category); };
            const handleBackToCategories = () => { setSelectedCategory(null); };
            const handleUpdateIncome = (newIncome) => { const oldIncome = data.income; if (oldIncome === newIncome) return; const newCategories = data.categories.map(cat => { if (cat.isLocked || oldIncome <= 0) { return cat; } const percentage = (cat.budgetedValue || 0) / oldIncome; const newBudgetValue = newIncome * percentage; return { ...cat, budgetedValue: newBudgetValue }; }); setData({ income: newIncome, categories: newCategories }); };
            const handleToggleCategoryLock = (categoryId) => { const updater = (categories) => categories.map(cat => cat.id === categoryId ? { ...cat, isLocked: !cat.isLocked } : cat ); if (tempPresetCategories) { setTempPresetCategories(updater); } else { const newCategories = updater(data.categories); setData({ ...data, categories: newCategories }); } };
            const handleMoveItem = (draggedItem, targetItem) => { if (draggedItem.id === targetItem.id) return; const categories = tempPresetCategories ? tempPresetCategories : data.categories; let newCategories = Array.from(categories); if (draggedItem.type === 'category') { const draggedIndex = newCategories.findIndex(c => c.id === draggedItem.id); if (draggedIndex === -1) return; const [draggedCategory] = newCategories.splice(draggedIndex, 1); if (targetItem.type === 'category') { draggedCategory.group = targetItem.group; const targetIndex = newCategories.findIndex(c => c.id === targetItem.id); newCategories.splice(targetIndex, 0, draggedCategory); } else if (targetItem.type === 'group') { draggedCategory.group = targetItem.id; let targetIndex = newCategories.findIndex(c => c.group === targetItem.id); if (targetIndex !== -1) { newCategories.splice(targetIndex, 0, draggedCategory); } else { newCategories.push(draggedCategory); } } } else if (draggedItem.type === 'group' && targetItem.type === 'group') { const draggedGroupName = draggedItem.id; const targetGroupName = targetItem.id; const draggedGroupCategories = newCategories.filter(c => c.group === draggedGroupName); const otherCategories = newCategories.filter(c => c.group !== draggedGroupName); const targetIndex = otherCategories.findIndex(c => c.group === targetGroupName); if (targetIndex === -1) return; otherCategories.splice(targetIndex, 0, ...draggedGroupCategories); newCategories = otherCategories; } if (tempPresetCategories) { setTempPresetCategories(newCategories); } else { setData({ ...data, categories: newCategories }); } };
            const handleUpdateCategoryBudget = (editedCategoryId, value, source) => { const targetCategories = tempPresetCategories || data.categories; const sanitizedValue = String(value).replace(',', '.'); let newBudgetValue; if (source === 'percent') { newBudgetValue = data.income > 0 ? (data.income * parseFloat(sanitizedValue)) / 100 : 0; } else { newBudgetValue = parseFloat(sanitizedValue) || 0; } if (isNaN(newBudgetValue)) return; const newCategories = targetCategories.map(cat => cat.id === editedCategoryId ? { ...cat, budgetedValue: Math.max(0, newBudgetValue) } : cat ); if (tempPresetCategories) { setTempPresetCategories(newCategories); } else { setData({ ...data, categories: newCategories }); } };
            const handleAutoAdjustBudget = () => { const targetCategories = tempPresetCategories || data.categories; const unlockedCategories = targetCategories.filter(cat => !cat.isLocked); if (unlockedCategories.length === 0) return; const lockedBudget = targetCategories.filter(cat => cat.isLocked).reduce((sum, cat) => sum + (cat.budgetedValue || 0), 0); if (lockedBudget > data.income) { console.error("Ajuste imposs√≠vel: o valor das categorias bloqueadas excede a receita."); return; } const budgetToDistribute = data.income - lockedBudget; const totalBudgetOfUnlockable = unlockedCategories.reduce((sum, cat) => sum + (cat.budgetedValue || 0), 0); let adjustedCategories; if (totalBudgetOfUnlockable > 0) { adjustedCategories = targetCategories.map(cat => { if (cat.isLocked) return cat; const proportion = (cat.budgetedValue || 0) / totalBudgetOfUnlockable; return { ...cat, budgetedValue: Math.max(0, budgetToDistribute * proportion) }; }); } else { const adjustmentPerCategory = budgetToDistribute / unlockedCategories.length; adjustedCategories = targetCategories.map(cat => { if (cat.isLocked) return cat; return { ...cat, budgetedValue: Math.max(0, adjustmentPerCategory) }; }); } const finalTotal = adjustedCategories.reduce((sum, cat) => sum + (cat.budgetedValue || 0), 0); const roundingDifference = data.income - finalTotal; const firstUnlockableIndex = adjustedCategories.findIndex(c => !c.isLocked); if (firstUnlockableIndex !== -1 && Math.abs(roundingDifference) > 0.001) { adjustedCategories[firstUnlockableIndex].budgetedValue += roundingDifference; } if (tempPresetCategories) { setTempPresetCategories(adjustedCategories); } else { setData({ ...data, categories: adjustedCategories }); } };
            const updateCategoryAndSelection = (categoryId, expenseUpdater) => { const newCategories = data.categories.map(cat => { if (cat.id === categoryId) { return { ...cat, expenses: expenseUpdater(cat.expenses || []) }; } return cat; }); const updatedSelectedCategory = newCategories.find(cat => cat.id === categoryId); if (updatedSelectedCategory) { setSelectedCategory(updatedSelectedCategory); } setData({ ...data, categories: newCategories }); };
            const handleAddExpense = (categoryId, newExpense) => { updateCategoryAndSelection(categoryId, (expenses) => [...expenses, newExpense]); };
            const handleUpdateExpense = (categoryId, updatedExpense) => { updateCategoryAndSelection(categoryId, (expenses) => expenses.map(exp => exp.id === updatedExpense.id ? updatedExpense : exp) ); };
            const handleDeleteExpense = (categoryId, expenseId) => { updateCategoryAndSelection(categoryId, (expenses) => expenses.filter(exp => exp.id !== expenseId) ); };
            const handleDuplicateExpense = (categoryId, expenseId) => { const category = data.categories.find(c => c.id === categoryId); if (!category) return; const expenseToDuplicate = category.expenses.find(e => e.id === expenseId); if (!expenseToDuplicate) return; const duplicatedExpense = { ...expenseToDuplicate, id: Date.now(), description: `${expenseToDuplicate.description} (C√≥pia)`, paidInstallments: 0, paymentHistory: expenseToDuplicate.status === 'Fixa-Vari√°vel' ? [] : undefined, }; updateCategoryAndSelection(categoryId, (expenses) => [...expenses, duplicatedExpense]); };
            const handleMarkAsPaid = (categoryId, expenseId) => { updateCategoryAndSelection(categoryId, (expenses) => expenses.map(exp => { if (exp.id === expenseId && (exp.paidInstallments || 0) < exp.installments) { return { ...exp, paidInstallments: (exp.paidInstallments || 0) + 1 }; } return exp; }) ); };
            const handleToggleExpensePause = (categoryId, expenseId) => { updateCategoryAndSelection(categoryId, (expenses) => expenses.map(exp => exp.id === expenseId ? { ...exp, isPaused: !exp.isPaused } : exp ) ); };
            const handleOpenPaymentModal = (expense) => { setExpenseToPay(expense); setPaymentModalOpen(true); };
            const handleConfirmPayment = (paidAmount) => { if (!expenseToPay) return; const categoryId = selectedCategory.id; updateCategoryAndSelection(categoryId, (expenses) => expenses.map(exp => { if (exp.id === expenseToPay.id) { const newHistory = [...(exp.paymentHistory || []), { date: new Date().toISOString(), amount: paidAmount }]; return { ...exp, paidInstallments: (exp.paidInstallments || 0) + 1, installmentValue: paidAmount, paymentHistory: newHistory, }; } return exp; }) ); setPaymentModalOpen(false); setExpenseToPay(null); };
            const handleUndoPayment = (categoryId, expenseId) => { updateCategoryAndSelection(categoryId, (expenses) => expenses.map(exp => { if (exp.id === expenseId && (exp.paidInstallments || 0) > 0) { const paidCount = exp.paidInstallments || 0; if (exp.status === 'Fixa-Vari√°vel') { const newHistory = [...(exp.paymentHistory || [])]; newHistory.pop(); const lastPaymentValue = newHistory.length > 0 ? newHistory[newHistory.length - 1].amount : exp.totalValue; return { ...exp, paidInstallments: paidCount - 1, paymentHistory: newHistory, installmentValue: lastPaymentValue, }; } return { ...exp, paidInstallments: paidCount - 1 }; } return exp; }) ); };
            const handleExportData = () => { const now = new Date(); const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`; const filename = `orcamento_${timestamp}.json`; const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent( JSON.stringify(data, null, 2) )}`; const link = document.createElement("a"); link.href = jsonString; link.download = filename; link.click(); };
            const handleImportClick = () => { fileInputRef.current?.click(); };
            const importData = (jsonString) => { try { const importedData = JSON.parse(jsonString); if (typeof importedData.income === 'number' && Array.isArray(importedData.categories)) { setInitialData(importedData); } else { console.error("Estrutura do JSON inv√°lida"); } } catch (error) { console.error("Falha ao analisar o JSON", error); } };
            const handleFileSelect = (event) => { const file = event.target.files[0]; if (file && file.type === "application/json") { const reader = new FileReader(); reader.onload = (e) => { const text = e.target.result; if (data.income === 0 && data.categories.length === 0) { importData(text); } else { setFileToImport(text); setImportConfirmOpen(true); } }; reader.readAsText(file); } event.target.value = null; };
            const confirmImportData = () => { if (fileToImport) { importData(fileToImport); } setImportConfirmOpen(false); setFileToImport(null); };
            const categoriesForDisplay = tempPresetCategories || data.categories;
            const totalBudgeted = categoriesForDisplay.reduce((sum, cat) => sum + (cat.budgetedValue || 0), 0);
            const totalPercentage = data.income > 0 ? (totalBudgeted / data.income) * 100 : 0;
            const isBudgetUnbalanced = Math.abs(100 - totalPercentage) >= 0.1 && categoriesForDisplay.length > 0;

            return (
                <div className="bg-gray-900 min-h-screen font-sans text-gray-200 pb-40">
                    <div className="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
                        <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleFileSelect} />
                        <header className="mb-8">
                            <h1 className="text-3xl sm:text-4xl font-bold text-white text-center">Controle de Or√ßamento Pessoal</h1>
                            <p className="text-center text-gray-400 mt-2">Controle suas finan√ßas de forma simples e visual.</p>
                        </header>
                        <main>
                            {selectedCategory ? ( <ExpenseList category={{...selectedCategory, expenses: selectedCategory.expenses || []}} onBack={handleBackToCategories} onUpdateExpense={handleUpdateExpense} onDeleteExpense={handleDeleteExpense} onAddExpense={handleAddExpense} onMarkAsPaid={handleMarkAsPaid} onUndoPayment={handleUndoPayment} onOpenPaymentModal={handleOpenPaymentModal} onTogglePause={handleToggleExpensePause} onDuplicateExpense={handleDuplicateExpense} /> ) : ( <CategoryList categories={data.categories} income={data.income} onSelectCategory={handleSelectCategory} onUpdateIncome={handleUpdateIncome} onUpdateCategoryBudget={handleUpdateCategoryBudget} onOpenCategoryModal={handleOpenCategoryModal} onDeleteCategoryRequest={handleDeleteCategoryRequest} onDeleteGroupRequest={handleDeleteGroupRequest} onOpenPresetModal={() => setIsPresetModalOpen(true)} onExport={handleExportData} onImport={handleImportClick} tempPresetCategories={tempPresetCategories} onConfirmPreset={handleConfirmPreset} onCancelPreset={handleCancelPreset} onToggleLock={handleToggleCategoryLock} onMoveItem={handleMoveItem} onOpenEditGroupModal={handleOpenEditGroupModal} undo={undo} redo={redo} canUndo={canUndo} canRedo={canRedo} /> )}
                        </main>
                        <footer className="text-center mt-12 text-gray-500 text-sm"> <p>Desenvolvido para facilitar sua vida financeira.</p> </footer>
                        <BudgetModal isOpen={isCategoryModalOpen} onClose={handleCloseCategoryModal}> <CategoryForm onSubmit={handleCategorySubmit} onCancel={handleCloseCategoryModal} categoryData={editingCategory} existingGroups={existingGroups} /> </BudgetModal>
                        <PaymentAmountModal isOpen={isPaymentModalOpen} onClose={() => setPaymentModalOpen(false)} onSubmit={handleConfirmPayment} expense={expenseToPay} />
                        <BudgetConfirmationModal isOpen={isDeleteConfirmOpen} onClose={() => setDeleteConfirmOpen(false)} onConfirm={confirmDeleteCategory} title="Excluir Categoria" message="Tem certeza que deseja excluir esta categoria e todas as suas despesas? Esta a√ß√£o n√£o pode ser desfeita." />
                        <BudgetConfirmationModal isOpen={isDeleteGroupConfirmOpen} onClose={() => setDeleteGroupConfirmOpen(false)} onConfirm={confirmDeleteGroup} title="Excluir Grupo" message={`Tem certeza que deseja excluir o grupo "${groupToDelete}"? As categorias dentro dele n√£o ser√£o exclu√≠das, apenas ficar√£o sem grupo.`} />
                        <BudgetConfirmationModal isOpen={isImportConfirmOpen} onClose={() => setImportConfirmOpen(false)} onConfirm={confirmImportData} title="Importar Dados" message="Isto ir√° substituir todos os dados atuais. Tem certeza que deseja continuar?" />
                        <PresetModal isOpen={isPresetModalOpen} onClose={() => setIsPresetModalOpen(false)} onSelectPreset={handleSelectPreset} />
                        <EditGroupModal isOpen={isEditGroupModalOpen} onClose={handleCloseEditGroupModal} onSubmit={handleUpdateGroupName} groupName={editingGroup} />
                    </div>
                    {isBudgetUnbalanced && !tempPresetCategories && <BudgetAdjustmentBar totalPercentage={totalPercentage} onAdjust={handleAutoAdjustBudget} />}
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL (Main App) ---

        function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [incomes, setIncomes] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [simIncomes, setSimIncomes] = useState([]);
            const [simExpenses, setSimExpenses] = useState([]);
            const [view, setView] = useState('dashboard'); 
            
            const [formType, setFormType] = useState('income');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            // REMOVED category state
            const [responsible, setResponsible] = useState('Eu');
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [editingRecord, setEditingRecord] = useState(null);
            const [activeTab, setActiveTab] = useState('summary');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const fileInputRef = useRef(null);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isTourOpen, setIsTourOpen] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [sortConfigs, setSortConfigs] = useState({ summary: { key: 'month', direction: 'descending' }, reserve: { key: 'monthKey', direction: 'descending' }, incomes: { key: 'month', direction: 'descending' }, expenses: { key: 'month', direction: 'descending' } });
            const [showFullSummary, setShowFullSummary] = useState(false);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [showDepletionModal, setShowDepletionModal] = useState(false);
            const [depletionModalShownThisSession, setDepletionModalShownThisSession] = useState(false);
            const [showRedoButton, setShowRedoButton] = useState(false);
            const [showLeanCalculator, setShowLeanCalculator] = useState(false);
            const [showAdjustReserveModal, setShowAdjustReserveModal] = useState(false);

            const isSimulation = view === 'simulation';
            const isBudget = view === 'budget';
            const participants = useMemo(() => userProfile?.participants || ['Eu'], [userProfile]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setUser(user);
                    if (!user) {
                        setIsLoading(false);
                        setDataLoaded(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) {
                    setIncomes([]);
                    setExpenses([]);
                    setUserProfile(null);
                    setDataLoaded(false);
                    return;
                }

                let profileData = null;
                const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                const unsubProfile = onSnapshot(profileRef, (docSnap) => {
                    profileData = docSnap.exists() ? docSnap.data() : { tourCompleted: false };
                    
                    // Garantir que participants exista
                    if (!profileData.participants) {
                        profileData.participants = ['Eu'];
                    }

                    setUserProfile(profileData);<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle Financeiro Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            setDoc, 
            getDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        window.firebase = {
             initializeApp,
             getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut,
             getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, PieChart, Pie, Cell } = Recharts;

        // --- Configura√ß√£o e Inicializa√ß√£o do Firebase (SDK v9+) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCjRdWFxR07ryhlI4bB8XJjBoxqXjw2LBE",
            authDomain: "guardecontrolefinanceiro.firebaseapp.com",
            projectId: "guardecontrolefinanceiro",
            storageBucket: "guardecontrolefinanceiro.appspot.com",
            messagingSenderId: "930219640587",
            appId: "1:930219640587:web:eca78fa4a2fb62960a040e",
            measurementId: "G-9D98TPEQ7V"
        };
        
        const {
            initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
            GoogleAuthProvider, signInWithPopup, signOut, getFirestore, collection, doc, onSnapshot,
            addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        } = window.firebase;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.appId || 'default-app-id';

        // --- Cores para Gr√°ficos ---
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658'];

        // --- √çcones SVG ---
        const TrashIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-400 hover:text-red-300"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> );
        const EditIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-400 hover:text-blue-300"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> );
        const ShieldIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> );
        const ExportIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> );
        const ImportIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 5 17 10"></polyline><line x1="12" y1="5" x2="12" y2="19"></line></svg> );
        const UndoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg> );
        const RedoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"></path></svg> );
        const HelpIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> );
        const LogoutIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> );
        const GoogleIcon = () => ( <svg className="w-5 h-5 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 109.8 512 0 402.2 0 261.8 0 122.4 109.8 13.6 244 13.6c70.3 0 129.8 27.8 174.3 71.9l-64.8 64.8C327.5 112.5 289.1 90.9 244 90.9c-86.1 0-156.2 69.1-156.2 154.9s70.1 154.9 156.2 154.9c94.2 0 135.3-72.2 140.8-109.9H244V261.8h244z"></path></svg> );
        const SortAscIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-blue-400"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z"></path></svg> );
        const SortDescIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-blue-400"><path d="M12 16l-6-6 1.41-1.41L12 13.17l4.59-4.58L18 10l-6 6z"></path></svg> );
        const NeutralSortIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity"><path d="m7 15 5 5 5-5"></path><path d="m7 9 5-5 5 5"></path></svg> );
        const AlertTriangleIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
        const ResetIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2M20 19v-4h-4"/></svg> );
        const CalculatorIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg> );
        const AdjustIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> );
        const InfoIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block ml-1 text-yellow-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg> );
        const UsersIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg> );
        const SettingsIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-300 hover:text-white transition-colors"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> );

        const SortIndicator = ({ sortConfig, columnKey }) => { if (sortConfig.key === columnKey) { return sortConfig.direction === 'ascending' ? <SortAscIcon /> : <SortDescIcon />; } return <NeutralSortIcon />; };
        
        // --- COMPONENTES ---

        const AuthModal = ({ auth, db }) => {
            const [isLoginView, setIsLoginView] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuthSuccess = async (userCredential) => {
                const user = userCredential.user;
                const userRef = doc(db, "users", user.uid);
                const userData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    lastLoginAt: serverTimestamp(),
                };
                await setDoc(userRef, userData, { merge: true });
            };

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    let userCredential;
                    if (isLoginView) {
                        userCredential = await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const userRef = doc(db, "users", userCredential.user.uid);
                        await setDoc(userRef, { plan: 'free', createdAt: serverTimestamp() }, { merge: true });
                    }
                    await handleAuthSuccess(userCredential);
                } catch (err) {
                    setError(getFriendlyAuthError(err.code));
                }
                setLoading(false);
            };

            const handleGoogleSignIn = async () => {
                setLoading(true);
                setError('');
                try {
                    const provider = new GoogleAuthProvider();
                    const result = await signInWithPopup(auth, provider);
                    const userRef = doc(db, "users", result.user.uid);
                    const docSnap = await getDoc(userRef);
                    if (!docSnap.exists()) {
                        await setDoc(userRef, { plan: 'free', createdAt: serverTimestamp() }, { merge: true });
                    }
                    await handleAuthSuccess(result);
                } catch (err) {
                    setError(getFriendlyAuthError(err.code));
                }
                setLoading(false);
            };
            
            const getFriendlyAuthError = (code) => {
                switch (code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'E-mail ou senha inv√°lidos.';
                    case 'auth/email-already-in-use':
                        return 'Este e-mail j√° est√° em uso.';
                    case 'auth/weak-password':
                        return 'A senha deve ter pelo menos 6 caracteres.';
                    case 'auth/invalid-email':
                        return 'O formato do e-mail √© inv√°lido.';
                    default:
                        return 'Ocorreu um erro. Por favor, tente novamente.';
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 flex justify-center items-center z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                        <h2 className="text-3xl font-bold text-gray-100 mb-2 text-center">{isLoginView ? 'Bem-vindo de volta!' : 'Crie sua conta'}</h2>
                        <p className="text-gray-400 text-center mb-6">{isLoginView ? 'Insira suas credenciais para acessar.' : 'Cadastre-se para come√ßar a controlar suas finan√ßas.'}</p>
                        {error && <div className="bg-red-900/50 border border-red-500 text-red-400 px-4 py-3 rounded-lg mb-4" role="alert">{error}</div>}
                        <form onSubmit={handleAuthAction}>
                            <div className="space-y-4">
                                <input type="email" placeholder="E-mail" value={email} onChange={e => setEmail(e.target.value)} required className="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                <input type="password" placeholder="Senha" value={password} onChange={e => setPassword(e.target.value)} required className="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                            </div>
                            <button type="submit" disabled={loading} className="w-full mt-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-colors disabled:bg-blue-800 disabled:cursor-not-allowed">
                                {loading ? 'Processando...' : (isLoginView ? 'Entrar' : 'Cadastrar')}
                            </button>
                        </form>
                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-600"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-gray-800 text-gray-500">OU</span></div></div>
                        <button onClick={handleGoogleSignIn} disabled={loading} className="w-full flex justify-center items-center py-3 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors border border-gray-600 disabled:bg-gray-800 disabled:cursor-not-allowed">
                            <GoogleIcon />
                            {isLoginView ? 'Entrar com o Google' : 'Cadastrar com o Google'}
                        </button>
                        <p className="mt-6 text-center text-sm text-gray-400">
                            {isLoginView ? 'N√£o tem uma conta?' : 'J√° tem uma conta?'}
                            <button onClick={() => { setIsLoginView(!isLoginView); setError(''); }} className="font-medium text-blue-400 hover:text-blue-300 ml-1">
                                {isLoginView ? 'Cadastre-se' : 'Entrar'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        };

        const OnboardingModal = ({ onSave, onCancel }) => {
            const [initialAverage, setInitialAverage] = useState('');
            const [months, setMonths] = useState('');

            const handleSave = () => {
                const avg = parseFloat(initialAverage);
                const numMonths = parseInt(months, 10);
                if (isNaN(avg) || avg <= 0 || isNaN(numMonths) || numMonths <= 0 || numMonths > 120) {
                     alert("Por favor, insira valores v√°lidos (M√©dia > 0, Meses entre 1 e 120).");
                    return;
                }
                onSave(avg, numMonths);
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-lg text-center">
                        <h2 className="text-2xl font-bold text-gray-100 mb-4">Configura√ß√£o Inicial</h2>
                        <p className="text-gray-400 mb-6">Para que o "Saldo Sugerido" funcione bem, precisamos de uma base. Como voc√™ prefere come√ßar?</p>
                        <div className="space-y-4">
                            <button onClick={onCancel} className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-colors">
                                Come√ßar do Zero
                            </button>
                            <div className="relative my-4">
                                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-600"></div></div>
                                <div className="relative flex justify-center text-sm"><span className="px-2 bg-gray-800 text-gray-500">OU</span></div>
                            </div>
                            <div className="bg-gray-700/50 p-4 rounded-lg text-left">
                                <p className="text-gray-300 mb-2 font-semibold">J√° tem um controle financeiro?</p>
                                <p className="text-sm text-gray-400 mb-4">Informe sua m√©dia de saldo mensal e por quantos meses voc√™ a calculou.</p>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                    <div className="md:col-span-2">
                                        <label htmlFor="avg-input" className="block text-sm font-medium text-gray-400 mb-1">Sua M√©dia de Saldo (R$)</label>
                                        <input 
                                            id="avg-input"
                                            type="number" 
                                            step="0.01" 
                                            value={initialAverage}
                                            onChange={(e) => setInitialAverage(e.target.value)}
                                            placeholder="Ex: 4500.50" 
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                        />
                                    </div>
                                    <div>
                                         <label htmlFor="months-input" className="block text-sm font-medium text-gray-400 mb-1">N¬∫ de Meses</label>
                                        <input 
                                            id="months-input"
                                            type="number"
                                            value={months}
                                            onChange={(e) => setMonths(e.target.value)}
                                            placeholder="Ex: 6" 
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                        />
                                    </div>
                                </div>
                                <button onClick={handleSave} className="mt-4 w-full px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-500 transition-colors">
                                    Salvar M√©dia Inicial
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const AdjustReserveModal = ({ isOpen, onClose, currentCalculatedReserve, onConfirm, currentMonthBalance, suggestedBalance }) => {
            const [realReserve, setRealReserve] = useState('');
            const [deficit, setDeficit] = useState(0);
            const [adjustmentType, setAdjustmentType] = useState('correction'); // 'correction' or 'movement'

            useEffect(() => {
                if (isOpen) {
                    setRealReserve('');
                    setAdjustmentType('correction');
                    // Calculate deficit if current balance is below suggested
                    // Note: We use the balance BEFORE any potential reserve transfer here to show the gap.
                    const gap = suggestedBalance - currentMonthBalance;
                    setDeficit(gap > 0 ? gap : 0);
                }
            }, [isOpen, currentMonthBalance, suggestedBalance]);

            const handleConfirm = () => {
                const value = parseFloat(realReserve);
                if (isNaN(value)) {
                    alert("Por favor, insira um valor v√°lido.");
                    return;
                }
                onConfirm(value, adjustmentType);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-sm">
                        <h2 className="text-xl font-bold text-gray-100 mb-4">Ajustar Reserva Manualmente</h2>
                        <div className="space-y-4">
                            <div>
                                <p className="text-sm text-gray-400 mb-1">Valor Calculado pelo App:</p>
                                <p className="text-xl font-bold text-gray-300">{currentCalculatedReserve.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                            </div>
                            
                            {deficit > 0 && parseFloat(realReserve) !== 0 && (
                                <div className="bg-yellow-900/40 border border-yellow-600/50 p-3 rounded-lg text-sm">
                                    <p className="font-bold text-yellow-400 mb-1">Aten√ß√£o!</p>
                                    <p className="text-gray-300 mb-2">
                                        Seu saldo atual est√° abaixo do sugerido. Faltam <span className="font-bold">{deficit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>.
                                    </p>
                                    <p className="text-gray-400 text-xs">
                                        Ao confirmar, esse valor ser√° automaticamente <strong>retirado da reserva</strong> para cobrir a meta (registrado como "Resgate").
                                    </p>
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-purple-300 mb-1">Qual o valor REAL da reserva hoje?</label>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    value={realReserve}
                                    onChange={(e) => setRealReserve(e.target.value)}
                                    className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="Ex: 5000.00"
                                />
                            </div>
                            
                            {parseFloat(realReserve) === 0 ? (
                                <div className="bg-red-900/40 border border-red-600/50 p-3 rounded-lg text-sm mt-2 animate-pulse">
                                    <p className="font-bold text-red-400 mb-1">Reiniciar Reserva?</p>
                                    <p className="text-gray-300 text-xs">
                                        Definir como <strong>0</strong> ir√° apagar todos os ajustes manuais e resgates autom√°ticos anteriores, permitindo recalcular e reajustar do zero.
                                    </p>
                                </div>
                            ) : (
                                realReserve && (
                                    <div className="bg-gray-700/50 p-3 rounded-lg space-y-2">
                                        <p className="text-sm font-medium text-gray-300">Qual a origem da diferen√ßa?</p>
                                        <div className="space-y-2">
                                            <label className="flex items-start cursor-pointer">
                                                <input 
                                                    type="radio" 
                                                    name="adjustmentType" 
                                                    value="correction"
                                                    checked={adjustmentType === 'correction'}
                                                    onChange={() => setAdjustmentType('correction')}
                                                    className="mt-1 mr-2 text-purple-500 focus:ring-purple-500"
                                                />
                                                <span className="text-sm text-gray-400">
                                                    <span className="block text-white font-medium">Apenas Corre√ß√£o / Saldo Antigo</span>
                                                    <span className="text-xs">O dinheiro j√° estava l√° (ou n√£o estava), apenas esqueci de anotar. (N√£o afeta relat√≥rios de Renda)</span>
                                                </span>
                                            </label>
                                            <label className="flex items-start cursor-pointer">
                                                <input 
                                                    type="radio" 
                                                    name="adjustmentType" 
                                                    value="movement"
                                                    checked={adjustmentType === 'movement'}
                                                    onChange={() => setAdjustmentType('movement')}
                                                    className="mt-1 mr-2 text-purple-500 focus:ring-purple-500"
                                                />
                                                <span className="text-sm text-gray-400">
                                                    <span className="block text-white font-medium">Nova Movimenta√ß√£o Real</span>
                                                    <span className="text-xs">Ganhei ou gastei esse dinheiro hoje. (Afeta relat√≥rios como Entrada/Sa√≠da)</span>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                )
                            )}

                            {deficit > 0 && realReserve && parseFloat(realReserve) !== 0 && (
                                <div className="text-xs text-gray-500 mt-1 border-t border-gray-700 pt-2">
                                    <p>C√°lculo Final:</p>
                                    <p>Reserva Informada: {parseFloat(realReserve).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                    <p className="text-red-400">- Cobertura de Saldo: {deficit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                    <p className="font-bold text-purple-400">= Nova Reserva no App: {(parseFloat(realReserve) - deficit).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                </div>
                            )}

                            <button onClick={handleConfirm} className={`w-full mt-4 py-2 text-white font-bold rounded-lg transition-colors ${parseFloat(realReserve) === 0 ? 'bg-red-600 hover:bg-red-500' : 'bg-purple-600 hover:bg-purple-500'}`}>
                                {parseFloat(realReserve) === 0 ? 'Confirmar Reset' : 'Confirmar e Ajustar'}
                            </button>
                            <button onClick={onClose} className="w-full py-2 text-gray-400 hover:text-white transition-colors text-sm">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, participants, onSaveParticipants }) => {
            const [tempParticipants, setTempParticipants] = useState(participants || ['Eu']);
            const [newParticipant, setNewParticipant] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setTempParticipants(participants || ['Eu']);
                    setNewParticipant('');
                }
            }, [isOpen, participants]);

            const handleAdd = () => {
                if (newParticipant.trim() && !tempParticipants.includes(newParticipant.trim())) {
                    setTempParticipants([...tempParticipants, newParticipant.trim()]);
                    setNewParticipant('');
                }
            };

            const handleRemove = (index) => {
                if (tempParticipants.length > 1) {
                    const newList = tempParticipants.filter((_, i) => i !== index);
                    setTempParticipants(newList);
                } else {
                    alert("√â necess√°rio ter pelo menos um participante.");
                }
            };

            const handleSave = () => {
                onSaveParticipants(tempParticipants);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-sm">
                        <h2 className="text-xl font-bold text-gray-100 mb-4">Configura√ß√µes</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-300 mb-2">Participantes</label>
                                <div className="space-y-2 mb-3 max-h-40 overflow-y-auto">
                                    {tempParticipants.map((p, index) => (
                                        <div key={index} className="flex justify-between items-center bg-gray-700 px-3 py-2 rounded">
                                            <span>{p}</span>
                                            <button onClick={() => handleRemove(index)} className="text-red-400 hover:text-red-300">
                                                <TrashIcon />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={newParticipant} 
                                        onChange={(e) => setNewParticipant(e.target.value)} 
                                        placeholder="Nome"
                                        className="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button onClick={handleAdd} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
                                        Add
                                    </button>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button onClick={onClose} className="px-4 py-2 text-gray-400 hover:text-white">Cancelar</button>
                                <button onClick={handleSave} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500 font-bold">Salvar</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LeanTimesCalculatorModal = ({ isOpen, onClose, currentMonthIncome, currentMonthBalance, currentReserve, onApply }) => {
            const [nextMonthIncome, setNextMonthIncome] = useState('');
            const [suggestedLimit, setSuggestedLimit] = useState(null);
            const [baseType, setBaseType] = useState('income'); // 'income' or 'balance'
            const [reserveWithdrawal, setReserveWithdrawal] = useState(0);

            useEffect(() => {
                if (isOpen) {
                    setNextMonthIncome('');
                    setSuggestedLimit(null);
                    setReserveWithdrawal(0);
                    setBaseType('income');
                }
            }, [isOpen]);

            const baseValue = baseType === 'income' ? currentMonthIncome : currentMonthBalance;

            const calculate = () => {
                const nextInc = parseFloat(nextMonthIncome);
                if (isNaN(nextInc) || nextInc < 0) {
                    alert("Por favor, insira um valor v√°lido para a receita prevista.");
                    return;
                }
                
                const limit = (baseValue + currentReserve + nextInc) / 2;
                setSuggestedLimit(limit);

                const withdrawal = limit - baseValue;
                setReserveWithdrawal(withdrawal);
            };

            const handleApply = () => {
                if (reserveWithdrawal > 0) {
                    onApply(reserveWithdrawal); // Passing the withdrawal amount directly
                    onClose();
                } else {
                    alert("O valor calculado n√£o exige retirada da reserva (voc√™ est√° economizando!). Nenhum ajuste necess√°rio.");
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-lg">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-100 flex items-center gap-2">
                                <CalculatorIcon />
                                Calculadora "Vacas Magras"
                            </h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">&times;</button>
                        </div>
                        
                        <p className="text-gray-400 mb-6 text-sm">
                            Calcule um teto de gastos seguro para tempos dif√≠ceis.
                        </p>

                        <div className="space-y-4 mb-6">
                            {/* Base Value Selection */}
                            <div className="bg-gray-700/50 p-3 rounded-lg">
                                <p className="text-sm font-medium text-gray-300 mb-2">1. Escolha a base de c√°lculo para este m√™s:</p>
                                <div className="flex gap-4">
                                    <label className="flex items-center cursor-pointer">
                                        <input 
                                            type="radio" 
                                            name="baseType" 
                                            checked={baseType === 'income'} 
                                            onChange={() => setBaseType('income')}
                                            className="mr-2 text-blue-500 focus:ring-blue-500"
                                        />
                                        <span className={`text-sm ${baseType === 'income' ? 'text-white' : 'text-gray-400'}`}>
                                            Total Entradas ({currentMonthIncome.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })})
                                        </span>
                                    </label>
                                    <label className="flex items-center cursor-pointer">
                                        <input 
                                            type="radio" 
                                            name="baseType" 
                                            checked={baseType === 'balance'} 
                                            onChange={() => setBaseType('balance')}
                                            className="mr-2 text-blue-500 focus:ring-blue-500"
                                        />
                                        <span className={`text-sm ${baseType === 'balance' ? 'text-white' : 'text-gray-400'}`}>
                                            Saldo Atual ({currentMonthBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })})
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-gray-700/50 p-3 rounded-lg">
                                    <p className="text-xs text-gray-400">Reserva Atual</p>
                                    <p className="text-lg font-bold text-purple-400">{currentReserve.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-400 mb-1">Previs√£o Pr√≥ximo M√™s</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={nextMonthIncome}
                                        onChange={(e) => setNextMonthIncome(e.target.value)}
                                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>

                            <button onClick={calculate} className="w-full py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-colors">
                                Calcular Limite
                            </button>
                        </div>

                        {suggestedLimit !== null && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="bg-green-900/40 border border-green-600/50 p-4 rounded-lg text-center">
                                    <p className="text-gray-300 text-sm mb-1">Seu Teto de Gastos Sugerido:</p>
                                    <p className="text-3xl font-bold text-green-400">{suggestedLimit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                    <p className="text-xs text-gray-400 mt-2 italic">F√≥rmula: (Base + Reserva + Pr√≥ximo) / 2</p>
                                </div>

                                {reserveWithdrawal > 0 ? (
                                    <div className="bg-yellow-900/40 border border-yellow-600/50 p-4 rounded-lg text-center">
                                        <p className="text-gray-300 text-sm mb-1">Necess√°rio retirar da Reserva:</p>
                                        <p className="text-xl font-bold text-yellow-400">{reserveWithdrawal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                        <button 
                                            onClick={handleApply}
                                            className="mt-3 w-full py-2 bg-yellow-700 hover:bg-yellow-600 text-white text-sm font-semibold rounded transition-colors">
                                            Confirmar e Descontar da Reserva
                                        </button>
                                    </div>
                                ) : (
                                    <div className="bg-blue-900/40 border border-blue-600/50 p-3 rounded-lg text-center">
                                        <p className="text-gray-300 text-sm">Este plano n√£o exige retirada da reserva. Voc√™ conseguir√° economizar!</p>
                                    </div>
                                )}
                            </div>
                        )}
                        
                         <div className="mt-6 text-right">
                             <button onClick={onClose} className="text-sm text-gray-400 hover:text-white underline">Fechar</button>
                         </div>
                    </div>
                </div>
            );
        };

        const Tour = ({ steps, isOpen, onClose }) => { 
            const [currentStepIndex, setCurrentStepIndex] = useState(0); 
            const [style, setStyle] = useState({}); 

            useEffect(() => { 
                if (!isOpen) return; 
                const currentStep = steps[currentStepIndex]; 
                const targetElement = document.querySelector(currentStep.target); 
                if (targetElement) { 
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                    const targetRect = targetElement.getBoundingClientRect(); 
                    targetElement.classList.add('tour-highlight'); 
                    const popoverStyle = { 
                        position: 'absolute', 
                        top: `${targetRect.bottom + window.scrollY + 10}px`, 
                        left: `${targetRect.left + window.scrollX}px`, 
                        maxWidth: '350px', 
                        transform: 'translateX(0)', 
                    }; 
                    if (targetRect.left + 350 > window.innerWidth) { 
                        popoverStyle.left = `${targetRect.right + window.scrollX - 350}px`; 
                    } 
                    if (targetRect.top < 200) { 
                        popoverStyle.top = `${targetRect.bottom + window.scrollY + 10}px`; 
                    } else { 
                        popoverStyle.top = `${targetRect.top + window.scrollY - 10}px`; 
                        popoverStyle.transform = 'translateY(-100%)'; 
                    } 
                    setStyle(popoverStyle); 
                } else { 
                    setStyle({ 
                        position: 'fixed', 
                        top: '50%', 
                        left: '50%', 
                        transform: 'translate(-50%, -50%)', 
                        maxWidth: '350px', 
                    }); 
                } 
                return () => { 
                    if (targetElement) { 
                        targetElement.classList.remove('tour-highlight'); 
                    } 
                }; 
            }, [currentStepIndex, isOpen, steps]); 

            if (!isOpen) return null; 

            const handleNext = () => currentStepIndex < steps.length - 1 ? setCurrentStepIndex(currentStepIndex + 1) : onClose(); 
            const handlePrev = () => currentStepIndex > 0 && setCurrentStepIndex(currentStepIndex - 1); 
            const currentStep = steps[currentStepIndex]; 

            return ( 
                <> 
                    <div className="fixed inset-0 bg-black/70 z-40" onClick={onClose}></div> 
                    <div style={style} className="bg-gray-700 text-gray-200 rounded-lg shadow-2xl p-5 z-50 transition-all duration-300"> 
                        <h3 className="text-xl font-bold text-blue-400 mb-2">{currentStep.title}</h3> 
                        <p className="text-sm mb-4">{currentStep.content}</p> 
                        <div className="flex justify-between items-center"> 
                            <span className="text-xs text-gray-400">Passo {currentStepIndex + 1} de {steps.length}</span> 
                            <div className="flex gap-2"> 
                                <button onClick={onClose} className="text-xs px-3 py-1 rounded hover:bg-gray-600 transition-colors">Pular</button> 
                                {currentStepIndex > 0 && <button onClick={handlePrev} className="px-4 py-1 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors">Anterior</button>} 
                                <button onClick={handleNext} className="px-4 py-1 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-colors"> {currentStepIndex === steps.length - 1 ? 'Concluir' : 'Pr√≥ximo'} </button> 
                            </div> 
                        </div> 
                    </div> 
                    <style>{`.tour-highlight { position: relative; z-index: 50; border-radius: 8px; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7); transition: box-shadow 0.3s ease-in-out; }`}</style> 
                </> 
            ); 
        };

        const RecordsTable = ({ title, records, onDelete, onEdit, type, sortConfig, requestSort, isSimulation, participants }) => {
            const showResponsible = participants && participants.length > 1;

            return (
            <div className="bg-gray-800/50 p-6 rounded-b-xl rounded-r-xl shadow-inner"> 
                <h3 className="text-xl font-semibold text-gray-200 mb-4">{title}</h3> 
                {records.length > 0 ? ( 
                    <div className="overflow-x-auto max-h-[400px]"> 
                        <table className="w-full text-left"> 
                            <thead> 
                                <tr className="border-b-2 border-gray-700 bg-gray-700/50 sticky top-0"> 
                                    <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('month')}> 
                                        <div className="flex items-center justify-start group"> <span>M√™s</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="month" /></span> </div> 
                                    </th> 
                                    <th className={`p-3 text-sm font-semibold text-gray-400 cursor-pointer hover:bg-gray-700/70 ${showResponsible ? 'w-1/3' : 'w-1/2'}`} onClick={() => requestSort('description')}> 
                                        <div className="flex items-center justify-start group"> <span>Descri√ß√£o</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="description" /></span> </div> 
                                    </th> 
                                     {showResponsible && (
                                         <th className="p-3 text-sm font-semibold text-gray-400 w-1/6 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('responsible')}>
                                             <div className="flex items-center justify-start group"><span>Resp.</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="responsible" /></span></div>
                                         </th>
                                     )}
                                    <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('amount')}> 
                                        <div className="flex items-center justify-end group"> <span>Valor</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="amount" /></span> </div> 
                                    </th> 
                                    <th className="p-3 text-sm font-semibold text-gray-400 text-center">A√ß√µes</th> 
                                </tr> 
                            </thead> 
                            <tbody> 
                                {records.map((record) => ( 
                                    <tr key={record.id} className={`border-b border-gray-700 hover:bg-gray-700/70 ${record.isSimulated ? 'italic text-cyan-400' : ''}`}> 
                                        <td className="p-3 text-gray-300 capitalize">{new Date(record.year, record.month).toLocaleString('pt-BR', { month: 'short' }).replace('.','')}</td> 
                                        <td className="p-3">{record.description} {record.isSimulated && <span className="text-xs text-cyan-500">(Simula√ß√£o)</span>}</td> 
                                        {showResponsible && (
                                            <td className="p-3 text-gray-300 text-xs">
                                                <span className={`px-2 py-1 rounded-full ${record.responsible === 'Eu' ? 'bg-blue-900/50 text-blue-300' : 'bg-gray-700 text-gray-300'}`}>
                                                    {record.responsible || 'Eu'}
                                                </span>
                                            </td>
                                        )}
                                        <td className={`p-3 font-medium text-right ${type === 'income' ? 'text-green-400' : 'text-red-400'}`}> {record.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> 
                                        <td className="p-3 text-center"> 
                                            <div className="flex justify-center items-center gap-3"> 
                                                <button onClick={() => onEdit(record, type)} className="p-1 rounded-full hover:bg-blue-800/50 transition-colors"> <EditIcon /> </button> 
                                                <button onClick={() => onDelete(record.id, type)} className="p-1 rounded-full hover:bg-red-800/50 transition-colors"> <TrashIcon /> </button> 
                                            </div> 
                                        </td> 
                                    </tr> 
                                ))} 
                            </tbody> 
                        </table> 
                    </div> 
                ) : ( 
                    <p className="text-gray-500 text-center py-4">Nenhum registro encontrado.</p> 
                )} 
            </div> 
            );
        };

        const EditModal = ({ record, onSave, onCancel, onError, participants }) => { 
            const [newDescription, setNewDescription] = useState(record.description); 
            const [newAmount, setNewAmount] = useState(record.amount); 
            const [newResponsible, setNewResponsible] = useState(record.responsible || (participants && participants[0]) || 'Eu');
            
            const handleSave = () => { 
                // CORRE√á√ÉO: Permitir valor 0. A verifica√ß√£o anterior (!newAmount) bloqueava o 0.
                if (!newDescription.trim() || newAmount === '' || newAmount === null || isNaN(parseFloat(newAmount))) { 
                    onError("Por favor, preencha a descri√ß√£o e um valor v√°lido."); 
                    return; 
                } 
                onSave(record.id, record.type, { 
                    ...record, 
                    description: newDescription, 
                    amount: parseFloat(newAmount),
                    responsible: newResponsible
                }); 
            }; 
            
            const showResponsible = participants && participants.length > 1;

            return ( 
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50"> 
                    <div className="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md"> 
                        <h2 className="text-2xl font-bold text-gray-100 mb-4">Editar Registro</h2> 
                        <div className="space-y-4"> 
                            <div> 
                                <label htmlFor="edit-description" className="block text-sm font-medium text-gray-400 mb-1">Descri√ß√£o</label> 
                                <input id="edit-description" type="text" value={newDescription} onChange={(e) => setNewDescription(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> 
                            </div> 
                            {showResponsible && (
                                <div>
                                    <label htmlFor="edit-responsible" className="block text-sm font-medium text-gray-400 mb-1">Respons√°vel</label>
                                    <select 
                                        id="edit-responsible" 
                                        value={newResponsible} 
                                        onChange={(e) => setNewResponsible(e.target.value)} 
                                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        {participants.map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                </div>
                            )}
                            <div> 
                                <label htmlFor="edit-amount" className="block text-sm font-medium text-gray-400 mb-1">Valor (R$)</label> 
                                <input id="edit-amount" type="number" step="0.01" value={newAmount} onChange={(e) => setNewAmount(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> 
                            </div> 
                        </div> 
                        <div className="mt-6 flex justify-end gap-4"> 
                            <button onClick={onCancel} className="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors">Cancelar</button> 
                            <button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-colors">Salvar</button> 
                        </div> 
                    </div> 
                </div> 
            ); 
        };

        const FinancialEvolutionChart = ({ data }) => { 
            const [visibility, setVisibility] = useState({ balance: true, saldoSugerido: true, expense: true, stabilityReserve: true, avgIncome: false }); 
            const handleLegendClick = (e) => { const { dataKey } = e; setVisibility(prev => ({ ...prev, [dataKey]: !prev[dataKey] })); }; 
            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); 
            const formatCompactCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', notation: 'compact' }).format(value); 
            
            return ( 
                <div id="financial-chart" className="bg-gray-800 p-6 rounded-xl shadow-md"> 
                    <h2 className="text-2xl font-semibold text-gray-200 mb-4">Evolu√ß√£o Financeira (√öltimos 12 Meses)</h2> 
                    <div style={{ width: '100%', height: 350 }}> 
                        <ResponsiveContainer> 
                            <ComposedChart data={data} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}> 
                                <CartesianGrid strokeDasharray="3 3" stroke="#4A5568" /> 
                                <XAxis dataKey="monthName" stroke="#A0AEC0" /> 
                                <YAxis stroke="#A0AEC0" tickFormatter={formatCompactCurrency} /> 
                                <Tooltip contentStyle={{ backgroundColor: '#2D3748', border: '1px solid #4A5568', color: '#E2E8F0' }} formatter={(value, name) => [formatCurrency(value), name]} /> 
                                <Legend onClick={handleLegendClick} wrapperStyle={{ color: '#E2E8F0', cursor: 'pointer' }} /> 
                                
                                <Line type="monotone" dataKey="balance" name="Renda L√≠quida Mensal" stroke="#48BB78" strokeWidth={2} hide={!visibility.balance} /> 
                                <Line type="monotone" dataKey="saldoSugerido" name="Saldo Sugerido" stroke="#4299E1" strokeDasharray="5 5" strokeWidth={2} hide={!visibility.saldoSugerido} /> 
                                <Line type="monotone" dataKey="avgIncome" name="M√©dia de Entradas (12m)" stroke="#9F7AEA" strokeDasharray="3 3" strokeWidth={2} hide={visibility.avgIncome === false} /> 
                                <Line type="monotone" dataKey="expense" name="Sa√≠da Mensal" stroke="#F56565" strokeWidth={2} hide={!visibility.expense} /> 
                                <Line type="monotone" dataKey="stabilityReserve" name="Reserva de Estabilidade" stroke="#A0AEC0" strokeWidth={2} hide={!visibility.stabilityReserve} /> 
                            </ComposedChart> 
                        </ResponsiveContainer> 
                    </div> 
                </div> 
            ); 
        };

        const MonthlyBalanceHistoryTable = ({ data, isLoading, sortConfig, requestSort }) => ( 
            <div className="bg-gray-800/50 p-6 rounded-b-xl rounded-r-xl shadow-inner"> 
                <h2 className="text-xl font-semibold text-gray-200 mb-4">Hist√≥rico de Saldo Mensal ({new Date().getFullYear()})</h2> 
                <div className="overflow-y-auto" style={{maxHeight: '350px'}}> 
                    <table className="w-full text-left"> 
                        <thead className="sticky top-0 bg-gray-800"> 
                            <tr className="border-b-2 border-gray-700 bg-gray-700/50"> 
                                <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('month')}> 
                                    <div className="flex items-center justify-start group"> <span>M√™s</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="month" /></span> </div> 
                                </th> 
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('income')}> 
                                    <div className="flex items-center justify-end group"> <span>Entradas</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="income" /></span> </div> 
                                </th> 
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('expense')}> 
                                    <div className="flex items-center justify-end group"> <span>Sa√≠das</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="expense" /></span> </div> 
                                </th> 
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('balance')}> 
                                    <div className="flex items-center justify-end group"> <span>Saldo do M√™s</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="balance" /></span> </div> 
                                </th> 
                            </tr> 
                        </thead> 
                        <tbody> 
                            {data.map((monthData) => ( 
                                <tr key={monthData.month} className="border-b border-gray-700 hover:bg-gray-700/70"> 
                                    <td className="p-3 text-gray-300 capitalize">{monthData.monthName}</td> 
                                    <td className="p-3 text-green-400 font-medium text-right"> {monthData.income.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> 
                                    <td className="p-3 text-red-400 font-medium text-right"> {monthData.expense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> 
                                    <td className={`p-3 font-bold text-right ${monthData.balance >= 0 ? 'text-blue-400' : 'text-yellow-400'}`}> {monthData.balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> 
                                </tr> 
                            ))} 
                            {data.length === 0 && !isLoading && ( 
                                <tr> 
                                    <td colSpan="4" className="text-center text-gray-500 py-4"> Nenhuma atividade registrada para este ano. </td> 
                                </tr> 
                            )} 
                        </tbody> 
                    </table> 
                </div> 
            </div> 
        );

        const ContributionAnalysis = ({ contributionData, individualAverages }) => {
            const chartData = contributionData.map(d => ({ name: d.name, value: d.value }));

            return (
                <div className="bg-gray-800/50 p-6 rounded-b-xl rounded-r-xl shadow-inner space-y-8">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="bg-gray-700/30 p-4 rounded-xl flex flex-col items-center">
                            <h3 className="text-lg font-semibold text-gray-300 mb-4">Contribui√ß√£o de Renda (Este Ano)</h3>
                            {chartData.length > 0 ? (
                                <ResponsiveContainer width="100%" height={250}>
                                    <PieChart>
                                        <Pie
                                            data={chartData}
                                            cx="50%"
                                            cy="50%"
                                            innerRadius={60}
                                            outerRadius={80}
                                            fill="#8884d8"
                                            paddingAngle={5}
                                            dataKey="value"
                                        >
                                            {chartData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                            ))}
                                        </Pie>
                                        <Tooltip formatter={(value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value)} />
                                        <Legend />
                                    </PieChart>
                                </ResponsiveContainer>
                            ) : (
                                <p className="text-gray-500 my-10">Sem dados de renda para este ano.</p>
                            )}
                        </div>

                        <div className="space-y-4">
                            <h3 className="text-lg font-semibold text-gray-300 mb-2">M√©dias de Entradas (√öltimos 12 Meses)</h3>
                            {individualAverages.map((item, index) => (
                                <div key={item.name} className="bg-gray-700/50 p-4 rounded-lg border border-gray-600 flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[index % COLORS.length] }}></div>
                                        <span className="font-medium text-gray-200">{item.name}</span>
                                    </div>
                                    <div className="text-right">
                                         <span className="block text-xl font-bold text-green-400">
                                            {item.avg.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                            <span className="text-xs text-gray-500 font-normal ml-1">/m√™s</span>
                                        </span>
                                        <span className="text-xs text-gray-400">({item.monthsCount} meses ativos)</span>
                                    </div>
                                </div>
                            ))}
                            <p className="text-xs text-gray-500 mt-2">
                                * M√©dia calculada apenas sobre os meses com contribui√ß√£o.
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const StabilityReserveHistoryTable = ({ data, sortConfig, requestSort }) => ( 
            <div className="bg-gray-800/50 p-6 rounded-b-xl rounded-r-xl shadow-inner"> 
                <h2 className="text-xl font-semibold text-gray-200 mb-4">Hist√≥rico da Reserva de Estabilidade</h2> 
                <div className="overflow-y-auto" style={{maxHeight: '350px'}}> 
                    <table className="w-full text-left"> 
                        <thead className="sticky top-0 bg-gray-800"> 
                            <tr className="border-b-2 border-gray-700 bg-gray-700/50"> 
                                <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('monthKey')}> 
                                    <div className="flex items-center justify-start group"> <span>M√™s</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="monthKey" /></span> </div> 
                                </th> 
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('amountAdded')}> 
                                    <div className="flex items-center justify-end group"> <span>Valor Guardado</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="amountAdded" /></span> </div> 
                                </th> 
                                <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer hover:bg-gray-700/70" onClick={() => requestSort('totalReserve')}> 
                                    <div className="flex items-center justify-end group"> <span>Total na Reserva</span> <span className="ml-2"><SortIndicator sortConfig={sortConfig} columnKey="totalReserve" /></span> </div> 
                                </th> 
                            </tr> 
                        </thead> 
                        <tbody> 
                            {data.map((monthData) => ( 
                                <tr key={monthData.monthKey} className="border-b border-gray-700 hover:bg-gray-700/70"> 
                                    <td className="p-3 text-gray-300 capitalize">
                                        {monthData.monthName}
                                        {monthData.hasAdjustment && (
                                            <span title="Houve um ajuste manual no saldo da reserva neste m√™s." className="cursor-help">
                                                <InfoIcon />
                                            </span>
                                        )}
                                    </td> 
                                    <td className={`p-3 font-medium text-right ${ monthData.amountAdded > 0 ? 'text-green-400' : monthData.amountAdded < 0 ? 'text-red-400' : 'text-gray-400' }`}> {monthData.amountAdded.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> 
                                    <td className="p-3 text-purple-400 font-bold text-right"> {monthData.totalReserve.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} </td> 
                                </tr> 
                            ))} 
                            {data.length === 0 && ( 
                                <tr> 
                                    <td colSpan="3" className="text-center text-gray-500 py-4"> Dados insuficientes para calcular o hist√≥rico. </td> 
                                </tr> 
                            )} 
                        </tbody> 
                    </table> 
                </div> 
            </div> 
        );

        const useSortableData = (items, config) => { 
            return useMemo(() => { 
                if (!config) return items; 
                const sortedItems = [...items]; 
                sortedItems.sort((a, b) => { 
                    if (a[config.key] < b[config.key]) { return config.direction === 'ascending' ? -1 : 1; } 
                    if (a[config.key] > b[config.key]) { return config.direction === 'ascending' ? 1 : -1; } 
                    return 0; 
                }); 
                return sortedItems; 
            }, [items, config]); 
        };
        
        // --- COMPONENTE PRINCIPAL ---

        function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [incomes, setIncomes] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [simIncomes, setSimIncomes] = useState([]);
            const [simExpenses, setSimExpenses] = useState([]);
            const [view, setView] = useState('dashboard'); 
            
            const [formType, setFormType] = useState('income');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            // REMOVED category state
            const [responsible, setResponsible] = useState('Eu');
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [editingRecord, setEditingRecord] = useState(null);
            const [activeTab, setActiveTab] = useState('summary');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const fileInputRef = useRef(null);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isTourOpen, setIsTourOpen] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [sortConfigs, setSortConfigs] = useState({ summary: { key: 'month', direction: 'descending' }, reserve: { key: 'monthKey', direction: 'descending' }, incomes: { key: 'month', direction: 'descending' }, expenses: { key: 'month', direction: 'descending' } });
            const [showFullSummary, setShowFullSummary] = useState(false);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [showDepletionModal, setShowDepletionModal] = useState(false);
            const [depletionModalShownThisSession, setDepletionModalShownThisSession] = useState(false);
            const [showRedoButton, setShowRedoButton] = useState(false);
            const [showLeanCalculator, setShowLeanCalculator] = useState(false);
            const [showAdjustReserveModal, setShowAdjustReserveModal] = useState(false);

            const isSimulation = view === 'simulation';
            const isBudget = view === 'budget';
            const participants = useMemo(() => userProfile?.participants || ['Eu'], [userProfile]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setUser(user);
                    if (!user) {
                        setIsLoading(false);
                        setDataLoaded(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) {
                    setIncomes([]);
                    setExpenses([]);
                    setUserProfile(null);
                    setDataLoaded(false);
                    return;
                }

                let profileData = null;
                const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                const unsubProfile = onSnapshot(profileRef, (docSnap) => {
                    profileData = docSnap.exists() ? docSnap.data() : { tourCompleted: false };
                    
                    // Garantir que participants exista
                    if (!profileData.participants) {
                        profileData.participants = ['Eu'];
                    }

                    setUserProfile(profileData);

                    if (dataLoaded) {
                        const isNewUser = !profileData.tourCompleted;
                         if (isNewUser) {
                            setIsTourOpen(true);
                        } else if (!profileData.initialDataSeeded && incomes.length === 0 && expenses.length === 0) {
                            setShowOnboarding(true);
                        }
                    }
                });

                const incomesCol = collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`);
                const unsubIncomes = onSnapshot(incomesCol, (snapshot) => {
                    const incomeData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setIncomes(incomeData);
                    if (!dataLoaded) setDataLoaded(true);
                });

                const expensesCol = collection(db, `/artifacts/${appId}/users/${user.uid}/expenses`);
                const unsubExpenses = onSnapshot(expensesCol, (snapshot) => {
                    const expenseData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setExpenses(expenseData);
                    if (!dataLoaded) setDataLoaded(true);
                });
                
                return () => { unsubProfile(); unsubIncomes(); unsubExpenses(); };
            }, [user, dataLoaded]); 
            
             const handleTourClose = async () => {
                setIsTourOpen(false);
                if (user && userProfile && !userProfile.tourCompleted) {
                    const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                    await setDoc(profileRef, { tourCompleted: true }, { merge: true });
                    
                    if (incomes.length === 0 && expenses.length === 0 && !userProfile.initialDataSeeded) {
                        setShowOnboarding(true);
                    }
                }
            };

            const handleSaveParticipants = async (newParticipants) => {
                if (user) {
                    try {
                        const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                        await setDoc(profileRef, { participants: newParticipants }, { merge: true });
                        setSuccess("Participantes atualizados com sucesso!");
                        
                        // Reset responsible if it was removed
                        if (!newParticipants.includes(responsible)) {
                            setResponsible(newParticipants[0] || 'Eu');
                        }
                    } catch (error) {
                        console.error("Error saving participants:", error);
                        setError("Erro ao salvar participantes.");
                    }
                }
            };
            
            useEffect(() => {
                if (userProfile && dataLoaded) {
                    const hasOnlySeedData = userProfile.initialDataSeeded && incomes.length > 0 && incomes.every(inc => inc.description.startsWith('M√©dia inicial')) && expenses.length === 0;
                    const hasNoData = userProfile.initialDataSeeded && incomes.length === 0 && expenses.length === 0;
                    setShowRedoButton(hasOnlySeedData || hasNoData);
                } else {
                    setShowRedoButton(false);
                }
            }, [incomes, expenses, userProfile, dataLoaded]);

            useEffect(() => { if (error) { const timer = setTimeout(() => setError(''), 5000); return () => clearTimeout(timer); } }, [error]);
            useEffect(() => { if (success) { const timer = setTimeout(() => setSuccess(''), 5000); return () => clearTimeout(timer); } }, [success]);
            
            const addActionToHistory = useCallback((action) => {
                if(isSimulation) return;
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(action);
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
            }, [history, historyIndex, isSimulation]);

            const handleAddRecord = async (e) => { 
                e.preventDefault(); 
                // Verifica se amount √© string vazia ou n√£o √© n√∫mero. Se for 0, passa.
                if (!description.trim() || amount === '' || amount === null || isNaN(parseFloat(amount))) { 
                    setError("Por favor, preencha a descri√ß√£o e um valor v√°lido."); return; 
                } 
                setError(''); 
                
                // If only 1 participant, force set responsible to that person
                const currentResponsible = participants.length > 1 ? responsible : participants[0];

                const newRecord = { 
                    description, 
                    amount: parseFloat(amount), 
                    responsible: currentResponsible,
                    month: parseInt(month), 
                    year: parseInt(year), 
                    createdAt: new Date() 
                }; 
                
                if(isSimulation){ 
                    const simId = `sim-${Date.now()}`; 
                    const recordWithSimFlag = {...newRecord, id: simId, isSimulated: true}; 
                    if (formType === 'income') setSimIncomes(prev => [...prev, recordWithSimFlag]); 
                    else setSimExpenses(prev => [...prev, recordWithSimFlag]); 
                    setSuccess("Transa√ß√£o simulada adicionada."); 
                } else { 
                    if (!db || !user) { setError("A conex√£o com o banco de dados n√£o est√° pronta."); return; } 
                    const collectionName = formType === 'income' ? 'incomes' : 'expenses'; 
                    try { 
                        const colRef = collection(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`); 
                        const docRef = await addDoc(colRef, newRecord); 
                        addActionToHistory({ type: 'ADD', collection: collectionName, docId: docRef.id, data: newRecord }); 
                        setSuccess(`Registro de ${formType === 'income' ? 'entrada' : 'sa√≠da'} adicionado com sucesso!`); 
                    } catch (err) { 
                        setError("Ocorreu um erro ao salvar o registro."); 
                    } 
                } 
                setDescription(''); 
                setAmount(''); 
            };

            const handleDeleteRecord = async (id, type) => { 
                if(isSimulation){ 
                    if(type === 'income') setSimIncomes(prev => prev.filter(r => r.id !== id)); 
                    else setSimExpenses(prev => prev.filter(r => r.id !== id)); 
                    return; 
                } 
                if (!db || !user) return; 
                const collectionName = type === 'income' ? 'incomes' : 'expenses'; 
                const recordToDelete = (type === 'income' ? incomes : expenses).find(r => r.id === id); 
                if (!recordToDelete) { setError("Registro n√£o encontrado para apagar."); return; } 
                try { 
                    const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, id); 
                    await deleteDoc(docRef); 
                    addActionToHistory({ type: 'DELETE', collection: collectionName, docId: id, data: recordToDelete }); 
                    setSuccess("Registro apagado com sucesso."); 
                } catch (err) { 
                    setError("Ocorreu um erro ao apagar o registro."); 
                } 
            };

            const handleUpdateRecord = async (id, type, updatedData) => { 
                if(isSimulation){ 
                    const updateSim = (prev) => prev.map(r => r.id === id ? updatedData : r); 
                    if(type === 'income') setSimIncomes(updateSim); 
                    else setSimExpenses(updateSim); 
                    setEditingRecord(null); 
                    return; 
                } 
                if (!db || !user) return; 
                const collectionName = type === 'income' ? 'incomes' : 'expenses'; 
                const originalRecord = (type === 'income' ? incomes : expenses).find(r => r.id === id); 
                if (!originalRecord) { setError("Registro n√£o encontrado para atualizar."); return; } 
                try { 
                    const {isSimulated, id: recordId, ...dataToSave} = updatedData; 
                    const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, id); 
                    await updateDoc(docRef, dataToSave); 
                    addActionToHistory({ type: 'UPDATE', collection: collectionName, docId: id, oldData: { description: originalRecord.description, amount: originalRecord.amount }, newData: dataToSave }); 
                    setEditingRecord(null); 
                    setSuccess("Registro atualizado com sucesso."); 
                } catch (err) { 
                    setError("Ocorreu um erro ao atualizar o registro."); 
                } 
            };

            const handleUndo = async () => { 
                if (historyIndex < 0 || isSimulation) return; 
                const actionToUndo = history[historyIndex]; 
                const { type, collection: collectionName, docId, data, oldData } = actionToUndo; 
                try { 
                    const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, docId); 
                    if (type === 'ADD') { await deleteDoc(docRef); } 
                    else if (type === 'DELETE') { const { id, ...dataToRestore } = data; await setDoc(docRef, dataToRestore); } 
                    else if (type === 'UPDATE') { await updateDoc(docRef, oldData); } 
                    setHistoryIndex(prev => prev - 1); 
                    setSuccess("A√ß√£o desfeita com sucesso."); 
                } catch (err) { 
                    setError("Falha ao desfazer a a√ß√£o."); 
                } 
            };

            const handleRedo = async () => { 
                if (historyIndex >= history.length - 1 || isSimulation) return; 
                const newIndex = historyIndex + 1; 
                const actionToRedo = history[newIndex]; 
                const { type, collection: collectionName, docId, data, newData } = actionToRedo; 
                try { 
                    const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`, docId); 
                    if (type === 'ADD') { await setDoc(docRef, data); } 
                    else if (type === 'DELETE') { await deleteDoc(docRef); } 
                    else if (type === 'UPDATE') { await updateDoc(docRef, newData); } 
                    setHistoryIndex(newIndex); 
                    setSuccess("A√ß√£o refeita com sucesso."); 
                } catch (err) { 
                    setError("Falha ao refazer a a√ß√£o."); 
                } 
            };

            const handleExportData = () => { 
                if (incomes.length === 0 && expenses.length === 0) { setError("N√£o h√° dados para exportar."); return; } 
                const convertTimestamp = (data) => data.map(doc => { const { id, ...rest } = doc; if (rest.createdAt && typeof rest.createdAt.toDate === 'function') { rest.createdAt = rest.createdAt.toDate().toISOString(); } return rest; }); 
                const dataToExport = { incomes: convertTimestamp(incomes), expenses: convertTimestamp(expenses), }; 
                const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(dataToExport, null, 2))}`; 
                const link = document.createElement("a"); link.href = jsonString; link.download = `dados_financeiros_${new Date().toISOString().slice(0, 10)}.json`; link.click(); 
                setSuccess('Dados exportados com sucesso!'); 
            };

            const handleImportClick = () => { fileInputRef.current.click(); };
            
            const handleFileChange = async (event) => { 
                const file = event.target.files[0]; 
                if (!file) return; 
                if (file.type !== "application/json") { setError("Por favor, selecione um arquivo .json v√°lido."); return; } 
                const reader = new FileReader(); 
                reader.onload = async (e) => { 
                    try { 
                        const data = JSON.parse(e.target.result); 
                        if (!data.incomes || !data.expenses || !Array.isArray(data.incomes) || !Array.isArray(data.expenses)) { throw new Error("Formato de arquivo inv√°lido."); } 
                        setIsLoading(true); 
                        const createRecordIdentifier = (rec) => { const date = rec.createdAt?.toDate ? rec.createdAt.toDate() : new Date(rec.createdAt); return `${rec.description?.trim()}|${rec.amount}|${date.toISOString()}`; }; 
                        const existingIncomes = new Set(incomes.map(createRecordIdentifier)); 
                        const existingExpenses = new Set(expenses.map(createRecordIdentifier)); 
                        let importedCount = 0; let skippedCount = 0; 
                        const incomeCollectionRef = collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`); 
                        for (const record of data.incomes) { 
                            const newRecord = { ...record, createdAt: record.createdAt ? new Date(record.createdAt) : new Date() }; 
                            const identifier = createRecordIdentifier(newRecord); 
                            if (!existingIncomes.has(identifier)) { await addDoc(incomeCollectionRef, newRecord); importedCount++; } else { skippedCount++; } 
                        } 
                        const expenseCollectionRef = collection(db, `/artifacts/${appId}/users/${user.uid}/expenses`); 
                        for (const record of data.expenses) { 
                            const newRecord = { ...record, createdAt: record.createdAt ? new Date(record.createdAt) : new Date() }; 
                            const identifier = createRecordIdentifier(newRecord); 
                            if (!existingExpenses.has(identifier)) { await addDoc(expenseCollectionRef, newRecord); importedCount++; } else { skippedCount++; } 
                        } 
                        setSuccess(`Importa√ß√£o conclu√≠da! ${importedCount} registros adicionados, ${skippedCount} duplicados ignorados.`); 
                        setHistory([]); setHistoryIndex(-1); 
                    } catch (err) { 
                        setError(`Erro ao importar dados: ${err.message}`); 
                    } finally { 
                        if(fileInputRef.current) { fileInputRef.current.value = ""; } 
                        setIsLoading(false); 
                    } 
                }; 
                reader.readAsText(file); 
            };

            const handleRequestSort = (tab, key) => { 
                setSortConfigs(prevConfigs => { 
                    const currentConfig = prevConfigs[tab]; 
                    let direction = 'ascending'; 
                    if (currentConfig.key === key && currentConfig.direction === 'ascending') { direction = 'descending'; } 
                    return { ...prevConfigs, [tab]: { key, direction } }; 
                }); 
            };
            
            const handleSaveInitialAverage = async (avg, months) => {
                 if (user) {
                    const incomesColRef = collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`);
                    const promises = [];
                    const currentDate = new Date();

                    for (let i = 0; i < months; i++) {
                        const pastDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - (i + 1), 1);
                        
                        const seedRecord = {
                            description: `M√©dia inicial (M√™s ${i + 1}/${months})`,
                            amount: avg,
                            month: pastDate.getMonth(),
                            year: pastDate.getFullYear(),
                            createdAt: new Date()
                        };
                        promises.push(addDoc(incomesColRef, seedRecord));
                    }

                    try {
                        await Promise.all(promises);

                        const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                        await setDoc(profileRef, { initialDataSeeded: true, tourCompleted: true }, { merge: true });

                        setShowOnboarding(false);
                    } catch (err) {
                        setError("N√£o foi poss√≠vel salvar os dados iniciais. Tente novamente.");
                    }
                }
            };
            
            const handleStartFromZero = async () => {
                 if(user) {
                    const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                    await setDoc(profileRef, { initialDataSeeded: true, tourCompleted: true }, { merge: true });
                    setShowOnboarding(false);
                 }
            };

            const handleRedoInitialAverage = async () => {
                if (!user) return;

                try {
                    setIsLoading(true);
                    const seedRecords = incomes.filter(inc => inc.description.startsWith('M√©dia inicial'));
                    
                    const deletePromises = seedRecords.map(record => {
                        const docRef = doc(db, `/artifacts/${appId}/users/${user.uid}/incomes`, record.id);
                        return deleteDoc(docRef);
                    });

                    await Promise.all(deletePromises);

                    const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                    await setDoc(profileRef, { initialDataSeeded: false }, { merge: true });
                    
                } catch (err) {
                    setError("Ocorreu um erro ao reiniciar a configura√ß√£o.");
                } finally {
                    setIsLoading(false);
                }
            };

            // Logic to apply reserve adjustment (and possibly cover deficit)
            const handleManualReserveAdjustment = async (userInputValue, adjustmentType) => {
                if (!user) return;
                
                // --- RESET LOGIC (New) ---
                if (userInputValue === 0) {
                     if (!confirm("Tem certeza que deseja zerar? Isso apagar√° todos os hist√≥ricos de ajustes manuais e resgates de reserva para reiniciar a contagem.")) {
                         return;
                     }
                     try {
                         setIsLoading(true);
                         // Identifica registros para apagar
                         const recordsToDelete = [];
                         incomes.forEach(doc => {
                             if (doc.isReserveAdjustment || doc.isTransferFromReserve) recordsToDelete.push({ col: 'incomes', id: doc.id });
                         });
                         expenses.forEach(doc => {
                             if (doc.isReserveAdjustment) recordsToDelete.push({ col: 'expenses', id: doc.id });
                         });
                         
                         // Executa dele√ß√£o em lote
                         await Promise.all(recordsToDelete.map(r => deleteDoc(doc(db, `/artifacts/${appId}/users/${user.uid}/${r.col}`, r.id))));
                         
                         setSuccess("Hist√≥rico de ajustes e resgates reiniciado. Voc√™ pode ajustar o valor novamente agora.");
                         setShowAdjustReserveModal(false);
                     } catch (err) {
                         console.error(err);
                         setError("Erro ao reiniciar reserva.");
                     } finally {
                         setIsLoading(false);
                     }
                     return;
                }
                // -------------------------

                const currentDate = new Date();
                const now = new Date();
                
                // Get strictly INCOME (from work/sales), excluding any reserve transfers
                const currentMonthIncome = filteredIncomes // filteredIncomes excludes 'isReserveAdjustment' AND 'isTransferFromReserve' if we update logic below
                    .filter(i => i.month === now.getMonth() && i.year === now.getFullYear())
                    .reduce((sum, i) => sum + i.amount, 0);
                
                const currentMonthExpense = filteredExpenses
                    .filter(e => e.month === now.getMonth() && e.year === now.getFullYear())
                    .reduce((sum, e) => sum + e.amount, 0);
                
                // Balance before transfers
                const currentMonthBalance = currentMonthIncome - currentMonthExpense;
                
                // Target: Suggested Balance
                const suggested = calculateMovingAverage(now.getFullYear(), now.getMonth());
                
                // Deficit GAP
                const deficit = Math.max(0, suggested - currentMonthBalance);
                
                let incomeToAdd = 0;
                
                if (deficit > 0) {
                    incomeToAdd = deficit;
                }

                try {
                    // Step 1: Add Transfer Record (Cover Deficit)
                    if (incomeToAdd > 0) {
                        const incomeRecord = {
                            description: "Resgate da Reserva (Cobrir Meta)",
                            amount: incomeToAdd,
                            month: currentDate.getMonth(),
                            year: currentDate.getFullYear(),
                            createdAt: new Date(),
                            isReserveAdjustment: false, 
                            isTransferFromReserve: true 
                        };
                        const incomeCol = collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`);
                        const docRef = await addDoc(incomeCol, incomeRecord);
                        
                        addActionToHistory({
                            type: 'ADD',
                            collection: 'incomes',
                            docId: docRef.id,
                            data: incomeRecord
                        });
                    }

                    // Step 2: Adjust Reserve to match user input
                    const adjustmentAmount = userInputValue - finalStabilityReserve - incomeToAdd;
                    
                    let collectionName = 'incomes';
                    let finalAmount = adjustmentAmount;
                    
                    if (adjustmentAmount < 0) {
                        collectionName = 'expenses';
                        finalAmount = Math.abs(adjustmentAmount);
                    }
                    
                    const adjustmentRecord = {
                        description: `Ajuste Manual (${adjustmentType === 'correction' ? 'Corre√ß√£o' : 'Movimenta√ß√£o'})`,
                        amount: finalAmount,
                        month: currentDate.getMonth(),
                        year: currentDate.getFullYear(),
                        createdAt: new Date(),
                        isReserveAdjustment: true 
                    };

                    const adjCol = collection(db, `/artifacts/${appId}/users/${user.uid}/${collectionName}`);
                    const docRefAdj = await addDoc(adjCol, adjustmentRecord);
                    
                    addActionToHistory({
                        type: 'ADD',
                        collection: collectionName,
                        docId: docRefAdj.id,
                        data: adjustmentRecord
                    });
                    
                    setSuccess("Reserva ajustada com sucesso!");
                    setShowAdjustReserveModal(false);
                } catch (err) {
                    console.error(err);
                    setError("Erro ao salvar ajuste.");
                }
            };
            
            const handleLeanCalculatorApply = (withdrawalAmount) => {
                 const performLeanUpdate = async () => {
                     if (!user) return;
                     try {
                        const currentDate = new Date();
                        // 1. Add Income (Transfer)
                        const incomeRecord = {
                            description: "Resgate (Vacas Magras)",
                            amount: withdrawalAmount,
                            month: currentDate.getMonth(),
                            year: currentDate.getFullYear(),
                            createdAt: new Date(),
                            isReserveAdjustment: false,
                            isTransferFromReserve: true
                        };
                        const incRef = await addDoc(collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`), incomeRecord);
                        
                        addActionToHistory({
                            type: 'ADD',
                            collection: 'incomes',
                            docId: incRef.id,
                            data: incomeRecord
                        });

                        // 2. Adjust Reserve down
                        const adjustmentAmount = -2 * withdrawalAmount;
                        
                        const adjRecord = {
                            description: "Sa√≠da p/ Cobertura (Vacas Magras)",
                            amount: Math.abs(adjustmentAmount),
                            month: currentDate.getMonth(),
                            year: currentDate.getFullYear(),
                            createdAt: new Date(),
                            isReserveAdjustment: true // Hidden
                        };
                        // Negative adjustment -> Expense
                        const expRef = await addDoc(collection(db, `/artifacts/${appId}/users/${user.uid}/expenses`), adjRecord);
                        
                        addActionToHistory({
                            type: 'ADD',
                            collection: 'expenses',
                            docId: expRef.id,
                            data: adjRecord
                        });
                        
                        setSuccess("Plano de Vacas Magras aplicado!");
                     } catch(err) {
                         setError("Erro ao aplicar plano.");
                     }
                 };
                 performLeanUpdate();
            };
            
            // --- Hooks de C√°lculo (Memoiza√ß√£o) ---
            const combinedIncomes = useMemo(() => isSimulation ? [...incomes, ...simIncomes] : incomes, [incomes, simIncomes, isSimulation]);
            const combinedExpenses = useMemo(() => isSimulation ? [...expenses, ...simExpenses] : expenses, [expenses, simExpenses, isSimulation]);

            // NOVO: Determina a "Data Atual" do contexto. 
            // No Dashboard normal, √© HOJE.
            // Na Simula√ß√£o, se houver lan√ßamentos futuros, a "Data Atual" avan√ßa para mostrar o impacto futuro.
            const contextDate = useMemo(() => {
                const now = new Date();
                if (!isSimulation) return now;

                let maxTimestamp = now.getTime();
                [...combinedIncomes, ...combinedExpenses].forEach(r => {
                    // Considera o primeiro dia do m√™s do registro
                    const d = new Date(r.year, r.month, 1);
                    if (d.getTime() > maxTimestamp) maxTimestamp = d.getTime();
                });
                return new Date(maxTimestamp);
            }, [isSimulation, combinedIncomes, combinedExpenses]);

            // Filter out reserve adjustments from visible tables and totals
            const filteredIncomes = useMemo(() => combinedIncomes.filter(i => i.year === filterYear && !i.isReserveAdjustment && !i.isTransferFromReserve), [combinedIncomes, filterYear]);
            
            // Transfers Only
            const reserveTransfers = useMemo(() => combinedIncomes.filter(i => i.year === filterYear && i.isTransferFromReserve), [combinedIncomes, filterYear]);
            
            const filteredExpenses = useMemo(() => combinedExpenses.filter(e => e.year === filterYear && !e.isReserveAdjustment), [combinedExpenses, filterYear]);
            
            const totalRealIncome = useMemo(() => filteredIncomes.reduce((sum, i) => sum + i.amount, 0), [filteredIncomes]);
            const totalTransfers = useMemo(() => reserveTransfers.reduce((sum, i) => sum + i.amount, 0), [reserveTransfers]);
            
            // Total Available for Month = Real Income + Transfers
            const totalAvailable = totalRealIncome + totalTransfers;
            
            const totalExpenses = useMemo(() => filteredExpenses.reduce((sum, e) => sum + e.amount, 0), [filteredExpenses]);
            
            // CORRE√á√ÉO: Saldo = Income - Expense (ignorando transfer√™ncias na visualiza√ß√£o da tabela para manter consist√™ncia matem√°tica)
            const balance = useMemo(() => totalRealIncome - totalExpenses, [totalRealIncome, totalExpenses]);
            
            // Nova fun√ß√£o para calcular M√©dia M√≥vel para um m√™s espec√≠fico
            const calculateMovingAverage = useCallback((targetYear, targetMonth) => {
                const targetDate = new Date(targetYear, targetMonth, 1);
                // Janela de 12 meses terminando no m√™s atual (target)
                const windowStart = new Date(targetDate);
                windowStart.setMonth(windowStart.getMonth() - 11);
                
                // Exclude reserve adjustments from average calculation
                // AND exclude transfers (we want average of REAL income/capacity)
                const relevantIncomes = combinedIncomes.filter(i => {
                    const d = new Date(i.year, i.month, 1);
                    return d >= windowStart && d <= targetDate && !i.isReserveAdjustment && !i.isTransferFromReserve;
                });
                
                const relevantExpenses = combinedExpenses.filter(e => {
                    const d = new Date(e.year, e.month, 1);
                    return d >= windowStart && d <= targetDate && !e.isReserveAdjustment;
                });
                
                const activeMonths = new Set([...relevantIncomes, ...relevantExpenses].map(t => `${t.year}-${t.month}`));
                const numMonthsWithData = activeMonths.size > 0 ? activeMonths.size : 1;
                
                const totalIncome = relevantIncomes.reduce((sum, i) => sum + i.amount, 0);
                const totalExpense = relevantExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                return (totalIncome - totalExpense) / numMonthsWithData;
            }, [combinedIncomes, combinedExpenses]);

            // Nova fun√ß√£o para calcular M√©dia M√≥vel de ENTRADAS para um m√™s espec√≠fico
            const calculateMovingIncomeAverage = useCallback((targetYear, targetMonth) => {
                const targetDate = new Date(targetYear, targetMonth, 1);
                const windowStart = new Date(targetDate);
                windowStart.setMonth(windowStart.getMonth() - 11);
                
                const relevantIncomes = combinedIncomes.filter(i => {
                    const d = new Date(i.year, i.month, 1);
                    return d >= windowStart && d <= targetDate && !i.isReserveAdjustment && !i.isTransferFromReserve;
                });
                
                // We use expenses just to determine active months to be fair? 
                // Or strictly active income months? Let's use same active month set logic for consistency.
                const relevantExpenses = combinedExpenses.filter(e => {
                    const d = new Date(e.year, e.month, 1);
                    return d >= windowStart && d <= targetDate && !e.isReserveAdjustment;
                });
                
                const activeMonths = new Set([...relevantIncomes, ...relevantExpenses].map(t => `${t.year}-${t.month}`));
                const numMonthsWithData = activeMonths.size > 0 ? activeMonths.size : 1;
                
                const totalIncome = relevantIncomes.reduce((sum, i) => sum + i.amount, 0);
                
                return totalIncome / numMonthsWithData;
            }, [combinedIncomes, combinedExpenses]);

            // Esta m√©dia atual (usada no Card) AGORA SEGUE O CONTEXTO (Hoje ou Futuro Simulado)
            const currentTwelveMonthAverage = useMemo(() => {
                return calculateMovingAverage(contextDate.getFullYear(), contextDate.getMonth());
            }, [calculateMovingAverage, contextDate]);

            // NOVO: C√°lculo das m√©dias separadas de Entrada e Sa√≠da para os √∫ltimos 12 meses (baseado no contextDate)
            const last12MonthsSummary = useMemo(() => {
                // Janela: [contextDate - 11 meses] at√© [contextDate]
                const windowStart = new Date(contextDate.getFullYear(), contextDate.getMonth() - 11, 1);
                // Limite superior inclusivo (m√™s do contextDate)
                const windowEnd = new Date(contextDate.getFullYear(), contextDate.getMonth() + 1, 0); // Fim do m√™s
                
                const relevantIncomes = combinedIncomes.filter(i => {
                    const d = new Date(i.year, i.month, 1);
                    return d >= windowStart && d <= windowEnd && !i.isReserveAdjustment && !i.isTransferFromReserve;
                });

                const relevantExpenses = combinedExpenses.filter(e => {
                    const d = new Date(e.year, e.month, 1);
                    return d >= windowStart && d <= windowEnd && !e.isReserveAdjustment;
                });

                const activeMonths = new Set([...relevantIncomes, ...relevantExpenses].map(t => `${t.year}-${t.month}`));
                const numMonths = activeMonths.size > 0 ? activeMonths.size : 1;

                const totalIncome = relevantIncomes.reduce((sum, i) => sum + i.amount, 0);
                const totalExpense = relevantExpenses.reduce((sum, e) => sum + e.amount, 0);

                return {
                    avgIncome: totalIncome / numMonths,
                    avgExpense: totalExpense / numMonths
                };
            }, [combinedIncomes, combinedExpenses, contextDate]);
            
            // Dados de contribui√ß√£o para a nova Aba
            const contributionData = useMemo(() => {
                // Filtrar entradas dos √∫ltimos 12 meses (baseado no contextDate)
                const windowStart = new Date(contextDate.getFullYear(), contextDate.getMonth() - 11, 1);
                const windowEnd = new Date(contextDate.getFullYear(), contextDate.getMonth() + 1, 0);
                
                const data = {};
                
                combinedIncomes.forEach(inc => {
                    const d = new Date(inc.year, inc.month, 1);
                     if (d >= windowStart && d <= windowEnd && !inc.isReserveAdjustment && !inc.isTransferFromReserve) {
                        const who = inc.responsible || 'Eu';
                        if (!data[who]) data[who] = 0;
                        data[who] += inc.amount;
                    }
                });
                
                return Object.entries(data).map(([name, value]) => ({ name, value }));
            }, [combinedIncomes, contextDate]);
            
            const individualAverages = useMemo(() => {
                 const windowStart = new Date(contextDate.getFullYear(), contextDate.getMonth() - 11, 1);
                 const windowEnd = new Date(contextDate.getFullYear(), contextDate.getMonth() + 1, 0);
                 
                 const grouping = {}; // Soma total por pessoa
                 const activeMonthsPerPerson = {}; // Meses ativos por pessoa
                 
                 combinedIncomes.forEach(inc => {
                    const d = new Date(inc.year, inc.month, 1);
                     if (d >= windowStart && d <= windowEnd && !inc.isReserveAdjustment && !inc.isTransferFromReserve) {
                        const who = inc.responsible || 'Eu';
                        
                        // Soma valor
                        if (!grouping[who]) grouping[who] = 0;
                        grouping[who] += inc.amount;

                        // Registra m√™s ativo
                        const monthKey = `${inc.year}-${inc.month}`;
                        if (!activeMonthsPerPerson[who]) activeMonthsPerPerson[who] = new Set();
                        activeMonthsPerPerson[who].add(monthKey);
                    }
                 });
                 
                 return Object.entries(grouping).map(([name, total]) => {
                     const monthsActive = activeMonthsPerPerson[name] ? activeMonthsPerPerson[name].size : 1;
                     const divisor = monthsActive > 0 ? monthsActive : 1;
                     return { name, avg: total / divisor, monthsCount: monthsActive };
                 });
            }, [combinedIncomes, contextDate]);

            const stabilityReserveHistory = useMemo(() => { 
                const monthlyNetIncomes = {}; 
                const adjustmentFlags = {}; // Rastreia meses com ajuste manual

                // Include adjustments in reserve calculation!
                combinedIncomes.forEach(record => { 
                    const key = `${record.year}-${String(record.month).padStart(2, '0')}`; 
                    if (!monthlyNetIncomes[key]) monthlyNetIncomes[key] = 0; 
                    monthlyNetIncomes[key] += record.amount; 
                    if (record.isReserveAdjustment) adjustmentFlags[key] = true;
                }); 
                combinedExpenses.forEach(record => { 
                    const key = `${record.year}-${String(record.month).padStart(2, '0')}`; 
                    if (!monthlyNetIncomes[key]) monthlyNetIncomes[key] = 0; 
                    monthlyNetIncomes[key] -= record.amount; 
                    if (record.isReserveAdjustment) adjustmentFlags[key] = true;
                }); 
                
                const sortedMonthKeys = Object.keys(monthlyNetIncomes).sort(); 
                if (sortedMonthKeys.length === 0) { return []; } 
                
                const history = []; 
                let runningReserve = 0; 
                
                for (const monthKey of sortedMonthKeys) { 
                    const [currentYear, currentMonthIndex] = monthKey.split('-').map(Number); 
                    const avgBalanceForThisMonth = calculateMovingAverage(currentYear, currentMonthIndex);

                    const previousReserve = runningReserve; 
                    const currentMonthBalance = monthlyNetIncomes[monthKey] || 0; 
                    const difference = currentMonthBalance - avgBalanceForThisMonth; 
                    runningReserve += difference; 
                    if (runningReserve < 0) { runningReserve = 0; } 
                    const amountAdded = runningReserve - previousReserve;
                    const monthName = new Date(currentYear, currentMonthIndex).toLocaleString('pt-BR', { month: 'short' }).replace('.',''); 
                    
                    history.push({ 
                        monthKey: monthKey, 
                        monthName: monthName, 
                        amountAdded: amountAdded, 
                        totalReserve: runningReserve, 
                        movingAverageUsed: avgBalanceForThisMonth,
                        hasAdjustment: adjustmentFlags[monthKey] 
                    }); 
                } 
                return history; 
            }, [combinedIncomes, combinedExpenses, calculateMovingAverage]);
            
            const finalStabilityReserve = useMemo(() => { return stabilityReserveHistory.length > 0 ? stabilityReserveHistory[stabilityReserveHistory.length - 1].totalReserve : 0; }, [stabilityReserveHistory]);
            
            // NOVO: An√°lise de Liquidez para o Card de Saldo Sugerido
            const liquidityAnalysis = useMemo(() => {
                const now = isSimulation ? contextDate : new Date();
                
                // 1. Reserva do M√™s Anterior (Dinheiro que j√° estava em caixa antes deste m√™s come√ßar)
                // Precisamos achar o registro hist√≥rico do m√™s anterior.
                // A lista stabilityReserveHistory pode n√£o estar ordenada por data na busca, ent√£o convertemos datas.
                const prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth()).padStart(2, '0')}`;
                
                // Busca no hist√≥rico (que cont√©m o total acumulado m√™s a m√™s)
                const prevReserveEntry = stabilityReserveHistory.find(h => h.monthKey === prevKey);
                const prevReserve = prevReserveEntry ? prevReserveEntry.totalReserve : 0;

                // 2. Saldo L√≠quido do M√™s Atual (Renda Real - Despesas)
                // Calculamos direto dos arrays combinados para n√£o depender do filtro de ano da tabela
                const currentMonthIncomes = combinedIncomes
                    .filter(i => i.month === now.getMonth() && i.year === now.getFullYear() && !i.isReserveAdjustment && !i.isTransferFromReserve)
                    .reduce((sum, i) => sum + i.amount, 0);
                
                const currentMonthExpenses = combinedExpenses
                    .filter(e => e.month === now.getMonth() && e.year === now.getFullYear() && !e.isReserveAdjustment)
                    .reduce((sum, e) => sum + e.amount, 0);

                const currentNetBalance = currentMonthIncomes - currentMonthExpenses;

                // 3. Liquidez Total Dispon√≠vel = O que sobrou deste m√™s + O que eu j√° tinha guardado
                const totalLiquidity = currentNetBalance + prevReserve;

                // 4. Compara√ß√£o
                const suggestion = currentTwelveMonthAverage;
                
                // Se a liquidez for menor que a sugest√£o, o usu√°rio fisicamente n√£o tem como atingir a sugest√£o sem ficar negativo/divida.
                // Ent√£o limitamos a exibi√ß√£o.
                // Nota: Se totalLiquidity for negativo, mostra negativo mesmo.
                const isLimited = totalLiquidity < suggestion;

                return {
                    isLimited,
                    displayValue: isLimited ? totalLiquidity : suggestion,
                    originalSuggestion: suggestion,
                    totalLiquidity
                };
            }, [stabilityReserveHistory, combinedIncomes, combinedExpenses, currentTwelveMonthAverage, contextDate, isSimulation]);

            const monthlySummary = useMemo(() => { 
                const summary = Array.from({ length: 12 }, (_, i) => ({ month: i, monthName: new Date(filterYear, i).toLocaleString('pt-BR', { month: 'short' }).replace('.', ''), income: 0, expense: 0, balance: 0, transfers: 0 })); 
                filteredIncomes.forEach(income => { summary[income.month].income += income.amount; }); 
                reserveTransfers.forEach(t => { summary[t.month].transfers += t.amount; });
                filteredExpenses.forEach(expense => { summary[expense.month].expense += expense.amount; }); 
                
                // CORRE√á√ÉO: Saldo = Income - Expense (ignorando transfer√™ncias na visualiza√ß√£o da tabela para manter consist√™ncia matem√°tica)
                summary.forEach(monthData => { monthData.balance = monthData.income - monthData.expense; }); 
                return summary; 
            }, [filteredIncomes, reserveTransfers, filteredExpenses, filterYear]);
            
            // Dados para o Card de Receita atual (para passar pro modal)
            const currentMonthIncomeForModal = useMemo(() => {
                const now = new Date();
                return filteredIncomes 
                    .filter(i => i.month === now.getMonth() && i.year === now.getFullYear())
                    .reduce((sum, i) => sum + i.amount, 0);
            }, [filteredIncomes]);

            const currentMonthBalanceForModal = useMemo(() => {
                const now = new Date();
                const income = filteredIncomes
                    .filter(i => i.month === now.getMonth() && i.year === now.getFullYear())
                    .reduce((sum, i) => sum + i.amount, 0);
                const transfers = reserveTransfers
                    .filter(i => i.month === now.getMonth() && i.year === now.getFullYear())
                    .reduce((sum, i) => sum + i.amount, 0);
                const expense = filteredExpenses
                    .filter(e => e.month === now.getMonth() && e.year === now.getFullYear())
                    .reduce((sum, e) => sum + e.amount, 0);
                return (income + transfers) - expense;
            }, [filteredIncomes, reserveTransfers, filteredExpenses]);

            const chartData = useMemo(() => { 
                const data = [];
                
                // Mapeia hist√≥rico de reserva para acesso r√°pido
                const reserveMap = new Map();
                const sortedHistory = [...stabilityReserveHistory].sort((a, b) => a.monthKey.localeCompare(b.monthKey));
                
                // Loop para os √∫ltimos 12 meses (do mais antigo para o atual/simulado) com base no contextDate
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(contextDate.getFullYear(), contextDate.getMonth() - i, 1);
                    const month = d.getMonth();
                    const year = d.getFullYear();
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    const label = d.toLocaleString('pt-BR', { month: 'short' }).replace('.','') + '/' + year.toString().slice(2);

                    // Calc Values for this specific month
                    const income = combinedIncomes
                        .filter(r => r.month === month && r.year === year && !r.isReserveAdjustment && !r.isTransferFromReserve)
                        .reduce((sum, r) => sum + r.amount, 0);
                    
                    const transfers = combinedIncomes
                        .filter(r => r.month === month && r.year === year && r.isTransferFromReserve)
                        .reduce((sum, r) => sum + r.amount, 0);

                    const expense = combinedExpenses
                        .filter(r => r.month === month && r.year === year && !r.isReserveAdjustment)
                        .reduce((sum, r) => sum + r.amount, 0);
                    
                    const displayBalance = income - expense; 

                    // Averages at that point in time
                    const saldoSugerido = calculateMovingAverage(year, month);
                    const avgIncome = calculateMovingIncomeAverage(year, month);

                    // Reserve at that point in time
                    let reserveVal = 0;
                    const relevantHistoryEntry = sortedHistory.filter(h => h.monthKey <= monthKey).pop();
                    if (relevantHistoryEntry) {
                        reserveVal = relevantHistoryEntry.totalReserve;
                    }

                    data.push({
                        monthName: label,
                        balance: displayBalance,
                        expense,
                        saldoSugerido,
                        avgIncome,
                        stabilityReserve: reserveVal
                    });
                }
                return data;
            }, [stabilityReserveHistory, combinedIncomes, combinedExpenses, calculateMovingAverage, calculateMovingIncomeAverage, contextDate]); 
            
            const monthlyBalanceHistory = useMemo(() => monthlySummary.filter(m => m.income > 0 || m.transfers > 0 || m.expense > 0), [monthlySummary]);
            
            const sortedMonthlyBalanceHistory = useSortableData(monthlyBalanceHistory, sortConfigs.summary);
            const sortedStabilityReserveHistory = useSortableData(stabilityReserveHistory, sortConfigs.reserve);
            const sortedFilteredIncomes = useSortableData(filteredIncomes, sortConfigs.incomes);
            const sortedFilteredExpenses = useSortableData(filteredExpenses, sortConfigs.expenses);

            const canUndo = historyIndex >= 0 && !isSimulation;
            const canRedo = historyIndex < history.length - 1 && !isSimulation;
            const tourSteps = [
                { target: '#add-record-form', title: 'Bem-vindo(a)!', content: 'Comece por aqui! Use este formul√°rio para adicionar suas entradas e sa√≠das. Ele estar√° sempre vis√≠vel para acesso r√°pido.' },
                { target: '#summary-cards', title: 'Seu Painel Principal', content: 'Aqui voc√™ v√™ o mais importante: sua Reserva de Estabilidade e o Saldo Sugerido para o m√™s.' },
                { target: '#summary-toggle', title: 'Ver Detalhes do Ano', content: 'Quer ver o total de entradas, sa√≠das, m√©dias mensais e o saldo do ano? Clique aqui para expandir e ver o resumo completo.'},
                { target: '#financial-chart', title: 'Evolu√ß√£o Financeira', content: 'Este gr√°fico mostra o seu progresso m√™s a m√™s. Clique nas legendas para focar no que √© mais importante.' },
                { target: '#action-buttons', title: 'Ferramentas', content: 'Precisa importar ou exportar dados? Cometeu um erro e quer desfazer? Use as ferramentas neste painel.' }
            ];

            if (isLoading && !dataLoaded) { return <div className="bg-gray-900 text-gray-300 min-h-screen flex justify-center items-center"><p>Carregando...</p></div>; }
            if (!user) { return <AuthModal auth={auth} db={db} />; }

            return (
                <div className="bg-gray-900 text-gray-300 min-h-screen font-sans">
                    {showOnboarding && <OnboardingModal onSave={handleSaveInitialAverage} onCancel={handleStartFromZero} />}
                    <LeanTimesCalculatorModal 
                        isOpen={showLeanCalculator}
                        onClose={() => setShowLeanCalculator(false)}
                        currentMonthIncome={currentMonthIncomeForModal}
                        currentMonthBalance={currentMonthBalanceForModal}
                        currentReserve={finalStabilityReserve}
                        onApply={handleLeanCalculatorApply}
                    />
                    <AdjustReserveModal
                        isOpen={showAdjustReserveModal}
                        onClose={() => setShowAdjustReserveModal(false)}
                        currentCalculatedReserve={finalStabilityReserve}
                        onConfirm={handleManualReserveAdjustment}
                        currentMonthBalance={currentMonthBalanceForModal}
                        suggestedBalance={currentTwelveMonthAverage}
                    />
                    <SettingsModal
                        isOpen={showSettingsModal}
                        onClose={() => setShowSettingsModal(false)}
                        participants={participants}
                        onSaveParticipants={handleSaveParticipants}
                    />
                    <Tour steps={tourSteps} isOpen={isTourOpen} onClose={handleTourClose} />
                    {editingRecord && ( <EditModal record={editingRecord} onSave={handleUpdateRecord} onCancel={() => { setEditingRecord(null); setError(''); }} onError={setError} participants={participants} /> )}
                    
                    <header className="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-20">
                                <div className="flex items-center gap-8">
                                    <h1 className="text-2xl font-bold text-gray-100 hidden sm:block">Controle Financeiro</h1>
                                     <div className="border-b border-gray-700 flex flex-wrap">
                                        <button onClick={() => {setView('dashboard'); setSimIncomes([]); setSimExpenses([]);}} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ view === 'dashboard' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Dashboard </button>
                                        <button onClick={() => setView('simulation')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ view === 'simulation' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Simula√ß√£o </button>
                                        <button onClick={() => setView('budget')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ view === 'budget' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Or√ßamento </button>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <p className="text-sm text-gray-400 hidden md:block">
                                        {user.email || user.displayName || 'Usu√°rio An√¥nimo'}
                                    </p>
                                    <button onClick={() => setShowSettingsModal(true)} className="flex items-center justify-center p-2 bg-gray-700 text-white font-semibold rounded-full hover:bg-gray-600 transition-colors" title="Configura√ß√µes">
                                        <SettingsIcon />
                                    </button>
                                    <button onClick={() => signOut(auth)} className="flex items-center justify-center p-2 bg-red-600/80 text-white font-semibold rounded-full hover:bg-red-500 transition-colors" title="Sair">
                                        <LogoutIcon />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                        {isSimulation && (
                            <div className="bg-cyan-900/50 border border-cyan-700 text-cyan-300 px-4 py-3 rounded-lg relative mb-6 text-center" role="alert">
                                <strong>Modo Simula√ß√£o:</strong> As altera√ß√µes feitas aqui n√£o ser√£o salvas permanentemente.
                            </div>
                        )}
                        {error && <div className="bg-red-900/50 border border-red-500 text-red-400 px-4 py-3 rounded-lg relative mb-6" role="alert">{error}</div>}
                        {success && <div className="bg-green-900/50 border border-green-500 text-green-400 px-4 py-3 rounded-lg relative mb-6" role="alert">{success}</div>}

                        {isBudget && (
                            <div className="bg-gray-800 p-6 rounded-xl shadow-md mb-8 animate-fade-in">
                                <h2 className="text-2xl font-semibold text-gray-200 mb-4">Plano de Or√ßamento</h2>
                                <p className="text-gray-400">Espa√ßo destinado √† configura√ß√£o do seu or√ßamento mensal.</p>
                            </div>
                        )}

                        {!isBudget && (
                            <div className="grid grid-cols-1 lg:grid-cols-12 lg:gap-8">
                                
                                {/* Coluna Principal (Esquerda) */}
                                <div className="lg:col-span-8 space-y-8">
                                    <div id="summary-cards" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                        <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                                            <h2 className="text-2xl font-semibold text-gray-200">Resumo de {filterYear}</h2>
                                            <div className="flex items-center gap-2">
                                                <label htmlFor="filterYear" className="text-sm font-medium text-gray-400">Filtrar por Ano:</label>
                                                <input id="filterYear" type="number" value={filterYear} onChange={(e) => setFilterYear(parseInt(e.target.value))} className="w-32 px-3 py-1 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div 
                                                id="monthly-salary-card" 
                                                className={`relative group p-4 rounded-lg border transition-colors duration-300 ${
                                                    liquidityAnalysis.isLimited 
                                                        ? 'bg-orange-900/40 border-orange-600/50' // Estilo de Alerta/Limitado
                                                        : (currentTwelveMonthAverage >= 0 ? 'bg-blue-900/50 border-blue-700' : 'bg-yellow-900/50 border-yellow-700')
                                                }`}
                                            >
                                                 <h3 className={`flex items-center gap-2 text-lg font-semibold ${liquidityAnalysis.isLimited ? 'text-orange-300' : (currentTwelveMonthAverage >= 0 ? 'text-blue-300' : 'text-yellow-300')}`}>
                                                    <span role="img" aria-label="Sugest√£o">{liquidityAnalysis.isLimited ? '‚ö†Ô∏è' : 'üí°'}</span>
                                                    Saldo Sugerido ({isSimulation && contextDate > new Date() ? 'Simulado' : 'Hoje'})
                                                 </h3>
                                                 
                                                 {/* Tooltip Explicativo */}
                                                 <span className="absolute -top-12 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-gray-800 text-gray-200 text-xs rounded p-2 w-80 text-center z-20 shadow-xl border border-gray-600 pointer-events-none">
                                                     {liquidityAnalysis.isLimited ? (
                                                         <>
                                                            <span className="block font-bold text-orange-400 mb-1">Valor Ajustado √† Realidade</span>
                                                            A m√©dia sugerida seria <strong>{liquidityAnalysis.originalSuggestion.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong>, mas seu saldo atual somado √† reserva n√£o atinge esse valor. Exibindo o m√°ximo dispon√≠vel em caixa.
                                                         </>
                                                     ) : (
                                                         "Este √© o seu saldo m√©dio dos √∫ltimos 12 meses. Use como guia para seus gastos mensais."
                                                     )}
                                                 </span>

                                                 <p className={`text-3xl font-bold mt-2 ${liquidityAnalysis.isLimited ? 'text-orange-400' : (currentTwelveMonthAverage >= 0 ? 'text-blue-400' : 'text-yellow-400')}`}>
                                                     {liquidityAnalysis.displayValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                                 </p>
                                                 
                                                 {liquidityAnalysis.isLimited && (
                                                     <p className="text-xs text-orange-300/80 mt-1 flex items-center gap-1">
                                                         Limitado por: Renda + Reserva
                                                     </p>
                                                 )}
                                             </div>
                                            <div className="bg-purple-900/50 p-4 rounded-lg border border-purple-700">
                                                <h3 className="text-lg font-semibold text-purple-300 flex items-center justify-between relative group">
                                                    <div className="flex items-center gap-2">
                                                        <ShieldIcon /> Reserva de Estabilidade
                                                    </div>
                                                    <button onClick={() => setShowAdjustReserveModal(true)} title="Ajustar Saldo Manualmente" className="text-purple-400 hover:text-white transition-colors">
                                                        <AdjustIcon />
                                                    </button>
                                                    <span className="absolute -top-2 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity bg-gray-600 text-white text-xs rounded py-1 px-2 w-72 pointer-events-none">
                                                        Calculada m√™s a m√™s: Saldo Anterior + (Saldo do M√™s - M√©dia de Saldo dos 12 meses anteriores). A reserva √© zerada se ficar negativa.
                                                    </span>
                                                </h3>
                                                <p className="text-3xl font-bold text-purple-400 mt-2">{finalStabilityReserve.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                            </div>

                                            {showFullSummary && (
                                                <>
                                                    <div className="bg-green-900/50 p-4 rounded-lg border border-green-700"> 
                                                        <h3 className="text-lg font-semibold text-green-300">Total de Entradas (Renda)</h3> 
                                                        <p className="text-3xl font-bold text-green-400 mt-2">{totalRealIncome.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p> 
                                                    </div>
                                                    
                                                    <div className="bg-red-900/50 p-4 rounded-lg border border-red-700"> <h3 className="text-lg font-semibold text-red-300">Total de Sa√≠das</h3> <p className="text-3xl font-bold text-red-400 mt-2">{totalExpenses.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p> </div>
                                                    
                                                    <div className="bg-green-900/50 p-4 rounded-lg border border-green-700/50">
                                                        <h3 className="text-base font-semibold text-green-300/80">M√©dia de Entradas (12m)</h3>
                                                        <p className="text-2xl font-bold text-green-400/90 mt-2">{last12MonthsSummary.avgIncome.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                                    </div>
                                                    <div className="bg-red-900/50 p-4 rounded-lg border border-red-700/50">
                                                        <h3 className="text-base font-semibold text-red-300/80">M√©dia de Sa√≠das (12m)</h3>
                                                        <p className="text-2xl font-bold text-red-400/90 mt-2">{last12MonthsSummary.avgExpense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                                    </div>

                                                    <div className={`md:col-span-2 p-4 rounded-lg border ${balance >= 0 ? 'bg-blue-900/50 border-blue-700' : 'bg-yellow-900/50 border-yellow-700'}`}> 
                                                        <h3 className={`text-lg font-semibold ${balance >= 0 ? 'text-blue-300' : 'text-yellow-300'}`}>Saldo Final do Ano (Dispon√≠vel)</h3> 
                                                        <p className={`text-3xl font-bold mt-2 ${balance >= 0 ? 'text-blue-400' : 'text-yellow-400'}`}>{balance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p> 
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                        
                                        <div id="summary-toggle" className="text-center mt-6 border-t border-gray-700 pt-4">
                                            <button onClick={() => setShowFullSummary(!showFullSummary)} className="text-sm font-medium text-blue-400 hover:text-blue-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-3 py-1">
                                                {showFullSummary ? 'Ocultar Detalhes do Ano' : 'Mostrar Detalhes do Ano'}
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <FinancialEvolutionChart data={chartData} />

                                    <div id="detailed-reports" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                        <h2 className="text-2xl font-semibold text-gray-200 mb-4">Relat√≥rios Detalhados</h2>
                                        <div className="border-b border-gray-700 flex flex-wrap">
                                            <button onClick={() => setActiveTab('summary')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'summary' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Resumo Mensal </button>
                                            <button onClick={() => setActiveTab('reserve')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'reserve' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Reserva de Estabilidade </button>
                                            <button onClick={() => setActiveTab('incomes')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'incomes' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Entradas </button>
                                            <button onClick={() => setActiveTab('expenses')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'expenses' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Sa√≠das </button>
                                            {participants.length > 1 && (
                                                <button onClick={() => setActiveTab('couple')} className={`py-2 px-4 text-sm sm:text-base font-semibold transition-colors duration-300 border-b-2 ${ activeTab === 'couple' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300 hover:border-blue-300' }`} > Vis√£o Casal </button>
                                            )}
                                        </div>
                                        <div className="mt-4"> 
                                            {isLoading && !user ? (<p className="text-gray-500 text-center py-4">Carregando dados...</p>) : ( <> 
                                                {activeTab === 'summary' && <MonthlyBalanceHistoryTable data={sortedMonthlyBalanceHistory} isLoading={isLoading} sortConfig={sortConfigs.summary} requestSort={(key) => handleRequestSort('summary', key)} />} 
                                                {activeTab === 'reserve' && <StabilityReserveHistoryTable data={sortedStabilityReserveHistory} sortConfig={sortConfigs.reserve} requestSort={(key) => handleRequestSort('reserve', key)} />} 
                                                {activeTab === 'incomes' && <RecordsTable title={`Detalhes de Entradas (${filterYear})`} records={sortedFilteredIncomes} onDelete={handleDeleteRecord} onEdit={(record, type) => setEditingRecord({...record, type})} type="income" sortConfig={sortConfigs.incomes} requestSort={(key) => handleRequestSort('incomes', key)} isSimulation={isSimulation} participants={participants} />} 
                                                {activeTab === 'expenses' && <RecordsTable title={`Detalhes de Sa√≠das (${filterYear})`} records={sortedFilteredExpenses} onDelete={handleDeleteRecord} onEdit={(record, type) => setEditingRecord({...record, type})} type="expense" sortConfig={sortConfigs.expenses} requestSort={(key) => handleRequestSort('expenses', key)} isSimulation={isSimulation} />} 
                                                {activeTab === 'couple' && participants.length > 1 && <ContributionAnalysis contributionData={contributionData} individualAverages={individualAverages} />}
                                            </> )} 
                                        </div>
                                    </div>
                                </div>

                                {/* Coluna de A√ß√µes (Direita) */}
                                <div className="lg:col-span-4 space-y-8 lg:sticky top-24 h-screen">
                                    <div id="add-record-form" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                        <h3 className="text-xl font-semibold text-gray-200 mb-4">Adicionar Transa√ß√£o</h3>
                                        <div className="mb-4 border-b border-gray-700 flex"> <button onClick={() => setFormType('income')} className={`py-2 px-4 text-lg font-semibold transition-colors duration-300 ${formType === 'income' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400 hover:text-green-400'}`}> Entrada </button> <button onClick={() => setFormType('expense')} className={`py-2 px-4 text-lg font-semibold transition-colors duration-300 ${formType === 'expense' ? 'text-red-400 border-b-2 border-red-400' : 'text-gray-400 hover:text-red-400'}`}> Sa√≠da </button> </div>
                                        <form onSubmit={handleAddRecord} className="space-y-4">
                                            <div> <label htmlFor="description" className="block text-sm font-medium text-gray-400 mb-1">Descri√ß√£o</label> <input id="description" type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder={formType === 'income' ? 'Ex: Sal√°rio, Venda' : 'Ex: Aluguel, Compras'} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div>
                                            {participants.length > 1 && (
                                                <div>
                                                    <label htmlFor="responsible" className="block text-sm font-medium text-gray-400 mb-1">Respons√°vel</label>
                                                    <input 
                                                        id="responsible" 
                                                        list="responsible-options-add"
                                                        value={responsible} 
                                                        onChange={(e) => setResponsible(e.target.value)} 
                                                        className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        placeholder="Quem?"
                                                    />
                                                    <datalist id="responsible-options-add">
                                                        {participants.map(p => <option key={p} value={p}>{p}</option>)}
                                                    </datalist>
                                                </div>
                                            )}
                                            <div> <label htmlFor="amount" className="block text-sm font-medium text-gray-400 mb-1">Valor (R$)</label> <input id="amount" type="number" step="0.01" value={amount} onChange={(e) => setAmount(e.target.value)} placeholder="1500.00" className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div>
                                            <div className="flex gap-4"> <div className="flex-1"> <label htmlFor="month" className="block text-sm font-medium text-gray-400 mb-1">M√™s</label> <select id="month" value={month} onChange={(e) => setMonth(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> {Array.from({length: 12}, (_, i) => <option key={i} value={i}>{new Date(0, i).toLocaleString('pt-BR', { month: 'long' })}</option>)} </select> </div> <div className="flex-1"> <label htmlFor="year" className="block text-sm font-medium text-gray-400 mb-1">Ano</label> <input id="year" type="number" value={year} onChange={(e) => setYear(e.target.value)} className="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/> </div> </div>
                                            <button type="submit" className={`w-full text-white font-bold py-3 px-4 rounded-lg transition duration-300 focus:outline-none focus:ring-2 focus:ring-opacity-50 ${formType === 'income' ? 'bg-green-600 hover:bg-green-500 focus:ring-green-500' : 'bg-red-600 hover:bg-red-500 focus:ring-red-500'}`}> Adicionar {formType === 'income' ? 'Entrada' : 'Sa√≠da'} </button>
                                        </form>
                                    </div>
                                    <div id="action-buttons" className="bg-gray-800 p-6 rounded-xl shadow-md">
                                        <h3 className="text-xl font-semibold text-gray-200 mb-4">Ferramentas</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <button 
                                                onClick={() => setShowLeanCalculator(true)}
                                                className="col-span-2 flex items-center justify-center text-sm px-4 py-2 bg-yellow-700/80 text-white font-semibold rounded-lg hover:bg-yellow-600 transition-colors border border-yellow-600/50">
                                                <CalculatorIcon />
                                                Modo Vacas Magras
                                            </button>
                                            
                                            {showRedoButton && (
                                                <button 
                                                    onClick={handleRedoInitialAverage}
                                                    className="col-span-2 flex items-center justify-center text-sm px-4 py-2 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-500 transition-colors">
                                                    <ResetIcon />
                                                    Refazer M√©dia Inicial
                                                </button>
                                            )}
                                            <button onClick={handleImportClick} disabled={isSimulation} className="flex items-center justify-center text-sm px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-colors disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"> <ImportIcon /> Importar </button>
                                            <button onClick={handleExportData} disabled={isSimulation} className="flex items-center justify-center text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"> <ExportIcon /> Exportar </button>
                                            <button onClick={handleUndo} disabled={!canUndo} className="flex items-center justify-center text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"> <UndoIcon /> Desfazer </button>
                                            <button onClick={handleRedo} disabled={!canRedo} className="flex items-center justify-center text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500 transition-colors disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed"> <RedoIcon /> Refazer </button>
                                            <button onClick={() => setIsTourOpen(true)} className="col-span-2 flex items-center justify-center text-sm px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-500 transition-colors"> <HelpIcon /> Ajuda & Tour Guiado </button>
                                            <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                         <footer className="text-center mt-12 py-8 text-sm text-gray-500 border-t border-gray-800">
                            <div className="flex flex-col items-center justify-center">
                                <p className="mb-2">Desenvolvido por:</p>
                                <img src="https://i.postimg.cc/dVgn73g8/Monocromatica-Horizontal.png" alt="Logo do Desenvolvedor" className="h-8 opacity-50" />
                            </div>
                        </footer>
                    </main>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
