<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle Financeiro Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">
    <div id="root"></div>

    <!-- SDKs do Firebase (Versão Modular v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            setDoc, 
            getDoc,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        window.firebase = {
             initializeApp,
             getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut,
             getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, PieChart, Pie, Cell } = Recharts;

        // --- Configuração e Inicialização do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCjRdWFxR07ryhlI4bB8XJjBoxqXjw2LBE",
            authDomain: "guardecontrolefinanceiro.firebaseapp.com",
            projectId: "guardecontrolefinanceiro",
            storageBucket: "guardecontrolefinanceiro.appspot.com",
            messagingSenderId: "930219640587",
            appId: "1:930219640587:web:eca78fa4a2fb62960a040e",
            measurementId: "G-9D98TPEQ7V"
        };
        
        const {
            initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
            GoogleAuthProvider, signInWithPopup, signOut, getFirestore, collection, doc, onSnapshot,
            addDoc, deleteDoc, updateDoc, setDoc, getDoc, serverTimestamp
        } = window.firebase;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = firebaseConfig.appId || 'default-app-id';

        // --- Cores para Gráficos ---
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658'];

        // --- Ícones SVG ---
        const TrashIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-400 hover:text-red-300"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> );
        const EditIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-400 hover:text-blue-300"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> );
        const ShieldIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-purple-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg> );
        const AdjustIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg> );
        const SettingsIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-300 hover:text-white transition-colors"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> );
        const LogoutIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> );
        const GoogleIcon = () => ( <svg className="w-5 h-5 mr-2" viewBox="0 0 488 512" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 109.8 512 0 402.2 0 261.8 0 122.4 109.8 13.6 244 13.6c70.3 0 129.8 27.8 174.3 71.9l-64.8 64.8C327.5 112.5 289.1 90.9 244 90.9c-86.1 0-156.2 69.1-156.2 154.9s70.1 154.9 156.2 154.9c94.2 0 135.3-72.2 140.8-109.9H244V261.8h244z"></path></svg> );
        const MailIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg> );
        const SortAscIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" className="ml-1 inline"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z"></path></svg> );
        const SortDescIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" className="ml-1 inline"><path d="M12 16l-6-6 1.41-1.41L12 13.17l4.59-4.58L18 10l-6 6z"></path></svg> );
        const NeutralSortIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="ml-1 inline opacity-30"><path d="m7 15 5 5 5-5"></path><path d="m7 9 5-5 5 5"></path></svg> );
        const CalculatorIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg> );

        const SortIndicator = ({ sortConfig, columnKey }) => { 
            if (sortConfig.key === columnKey) { return sortConfig.direction === 'ascending' ? <SortAscIcon /> : <SortDescIcon />; } 
            return <NeutralSortIcon />; 
        };

        // --- HOOKS GLOBAIS ---
        const useSortableData = (items, config) => { 
            return useMemo(() => { 
                if (!config) return items; 
                const sortedItems = [...items]; 
                sortedItems.sort((a, b) => { 
                    if (a[config.key] < b[config.key]) { return config.direction === 'ascending' ? -1 : 1; } 
                    if (a[config.key] > b[config.key]) { return config.direction === 'ascending' ? 1 : -1; } 
                    return 0; 
                }); 
                return sortedItems; 
            }, [items, config]); 
        };
        
        // --- COMPONENTES AUXILIARES ---

        const AuthModal = ({ auth, db }) => {
            const [isLoginView, setIsLoginView] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuthSuccess = async (userCredential) => {
                const user = userCredential.user;
                const userRef = doc(db, "users", user.uid);
                await setDoc(userRef, { uid: user.uid, email: user.email, lastLoginAt: serverTimestamp() }, { merge: true });
            };

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try {
                    let userCredential;
                    if (isLoginView) userCredential = await signInWithEmailAndPassword(auth, email, password);
                    else {
                        userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await setDoc(doc(db, "users", userCredential.user.uid), { plan: 'free', createdAt: serverTimestamp() }, { merge: true });
                    }
                    await handleAuthSuccess(userCredential);
                } catch (err) { setError('E-mail ou senha inválidos.'); }
                setLoading(false);
            };

            const handleGoogleSignIn = async () => {
                setLoading(true); setError('');
                try {
                    const provider = new GoogleAuthProvider();
                    const result = await signInWithPopup(auth, provider);
                    await handleAuthSuccess(result);
                } catch (err) { setError('Falha no login.'); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-gray-900 flex justify-center items-center z-50">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
                        <h2 className="text-3xl font-bold text-gray-100 mb-6 text-center">{isLoginView ? 'Entrar' : 'Criar Conta'}</h2>
                        {error && <div className="bg-red-900/50 border border-red-500 text-red-400 px-4 py-2 rounded-lg mb-4 text-center text-sm">{error}</div>}
                        <form onSubmit={handleAuthAction} className="space-y-4">
                            <input type="email" placeholder="E-mail" value={email} onChange={e => setEmail(e.target.value)} required className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"/>
                            <input type="password" placeholder="Senha" value={password} onChange={e => setPassword(e.target.value)} required className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"/>
                            <button type="submit" disabled={loading} className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 disabled:opacity-50">{loading ? 'A processar...' : (isLoginView ? 'Entrar' : 'Registar')}</button>
                        </form>
                        <div className="my-6 flex items-center"><div className="flex-1 border-t border-gray-600"></div><span className="px-2 text-gray-500 text-xs">OU</span><div className="flex-1 border-t border-gray-600"></div></div>
                        <button onClick={handleGoogleSignIn} className="w-full py-3 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 flex justify-center items-center border border-gray-600"><GoogleIcon /> Google</button>
                        <p className="mt-6 text-center text-sm text-gray-400">{isLoginView ? 'Novo por aqui?' : 'Já tem conta?'} <button onClick={() => setIsLoginView(!isLoginView)} className="text-blue-400 font-medium ml-1">Clique aqui</button></p>
                    </div>
                </div>
            );
        };

        const RecordsTable = ({ title, records, onDelete, onEdit, type, sortConfig, requestSort, participants }) => {
            const showResponsible = participants && participants.length > 1;
            return (
                <div className="bg-gray-800/50 p-6 rounded-xl shadow-inner animate-fade-in"> 
                    <h3 className="text-xl font-semibold text-gray-200 mb-4">{title}</h3> 
                    {records.length > 0 ? ( 
                        <div className="overflow-x-auto max-h-[400px]"> 
                            <table className="w-full text-left"> 
                                <thead className="sticky top-0 bg-gray-800"> 
                                    <tr className="border-b-2 border-gray-700 bg-gray-700/50"> 
                                        <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer" onClick={() => requestSort('month')}>Mês <SortIndicator sortConfig={sortConfig} columnKey="month" /></th> 
                                        <th className="p-3 text-sm font-semibold text-gray-400 cursor-pointer" onClick={() => requestSort('description')}>Descrição <SortIndicator sortConfig={sortConfig} columnKey="description" /></th> 
                                        {showResponsible && <th className="p-3 text-sm font-semibold text-gray-400">Resp.</th>}
                                        <th className="p-3 text-sm font-semibold text-gray-400 text-right cursor-pointer" onClick={() => requestSort('amount')}>Valor <SortIndicator sortConfig={sortConfig} columnKey="amount" /></th> 
                                        <th className="p-3 text-sm font-semibold text-gray-400 text-center">Ações</th> 
                                    </tr> 
                                </thead> 
                                <tbody> 
                                    {records.map((record) => ( 
                                        <tr key={record.id} className="border-b border-gray-700 hover:bg-gray-700/70 transition-colors"> 
                                            <td className="p-3 text-gray-300 capitalize">{new Date(record.year, record.month).toLocaleString('pt-BR', { month: 'short' }).replace('.','')}</td> 
                                            <td className="p-3">{record.description} {record.isSimulated && <span className="text-xs text-cyan-500 italic">(Simulação)</span>}</td> 
                                            {showResponsible && <td className="p-3"><span className="px-2 py-0.5 bg-gray-700 rounded-full text-[10px]">{record.responsible || 'Eu'}</span></td>}
                                            <td className={`p-3 font-medium text-right ${type === 'income' ? 'text-green-400' : 'text-red-400'}`}>{record.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td> 
                                            <td className="p-3 flex justify-center gap-2"> 
                                                <button onClick={() => onEdit(record, type)} className="p-1 hover:bg-blue-800/50 rounded-full"><EditIcon /></button> 
                                                <button onClick={() => onDelete(record.id, type)} className="p-1 hover:bg-red-800/50 rounded-full"><TrashIcon /></button> 
                                            </td> 
                                        </tr> 
                                    ))} 
                                </tbody> 
                            </table> 
                        </div> 
                    ) : <p className="text-gray-500 text-center py-4">Nenhum registo encontrado.</p>} 
                </div> 
            );
        };

        const BudgetPage = () => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [service, setService] = useState('Consultoria Financeira');
            const [message, setMessage] = useState('');
            const [sent, setSent] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                setSent(true);
                setTimeout(() => setSent(false), 5000);
                setName(''); setEmail(''); setMessage('');
            };

            return (
                <div className="bg-gray-800 p-8 rounded-xl shadow-md max-w-2xl mx-auto animate-fade-in border border-gray-700">
                    <h2 className="text-2xl font-bold text-gray-100 mb-2 flex items-center"><MailIcon /> Solicitar Orçamento Personalizado</h2>
                    <p className="text-gray-400 mb-8 italic text-sm">Organize o seu futuro com uma análise financeira profissional.</p>
                    {sent ? (
                        <div className="bg-green-900/50 border border-green-500 text-green-300 p-4 rounded-lg text-center mb-6">Mensagem enviada com sucesso! Entraremos em contacto brevemente.</div>
                    ) : (
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label className="block text-xs font-medium text-gray-400 mb-1">NOME COMPLETO</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} required className="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-blue-500"/></div>
                                <div><label className="block text-xs font-medium text-gray-400 mb-1">E-MAIL</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-blue-500"/></div>
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-gray-400 mb-1">SERVIÇO PRETENDIDO</label>
                                <select value={service} onChange={(e) => setService(e.target.value)} className="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg outline-none">
                                    <option>Consultoria Financeira Pessoal</option>
                                    <option>Planeamento para Casais</option>
                                    <option>Análise de Investimentos</option>
                                    <option>Organização de Dívidas</option>
                                </select>
                            </div>
                            <div><label className="block text-xs font-medium text-gray-400 mb-1">A SUA MENSAGEM</label><textarea value={message} onChange={(e) => setMessage(e.target.value)} required rows="4" className="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-blue-500" placeholder="Como podemos ajudar..."></textarea></div>
                            <button type="submit" className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 transition-colors shadow-lg uppercase tracking-wider">Enviar Solicitação</button>
                        </form>
                    )}
                </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---

        function App() {
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [incomes, setIncomes] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [simIncomes, setSimIncomes] = useState([]);
            const [simExpenses, setSimExpenses] = useState([]);
            const [view, setView] = useState('dashboard'); 
            
            const [formType, setFormType] = useState('income');
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [responsible, setResponsible] = useState('Eu');
            const [month, setMonth] = useState(new Date().getMonth());
            const [year, setYear] = useState(new Date().getFullYear());
            const [filterYear, setFilterYear] = useState(new Date().getFullYear());
            const [editingRecord, setEditingRecord] = useState(null);
            const [activeTab, setActiveTab] = useState('summary');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const fileInputRef = useRef(null);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [isTourOpen, setIsTourOpen] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [sortConfigs, setSortConfigs] = useState({ summary: { key: 'month', direction: 'descending' }, reserve: { key: 'monthKey', direction: 'descending' }, incomes: { key: 'month', direction: 'descending' }, expenses: { key: 'month', direction: 'descending' } });
            const [showFullSummary, setShowFullSummary] = useState(false);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [dataLoaded, setDataLoaded] = useState(false);
            const [showAdjustReserveModal, setShowAdjustReserveModal] = useState(false);

            const isSimulation = view === 'simulation';

            // --- Firebase Listeners ---
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setUser(user);
                    if (!user) { setIsLoading(false); setDataLoaded(false); }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const profileRef = doc(db, `/artifacts/${appId}/users/${user.uid}/profile/settings`);
                const unsubProfile = onSnapshot(profileRef, (docSnap) => {
                    const profileData = docSnap.exists() ? docSnap.data() : { tourCompleted: false };
                    if (!profileData.participants) profileData.participants = ['Eu'];
                    setUserProfile(profileData);
                    if (dataLoaded) {
                         if (!profileData.tourCompleted) setIsTourOpen(true);
                         else if (!profileData.initialDataSeeded && incomes.length === 0 && expenses.length === 0) setShowOnboarding(true);
                    }
                });
                const unsubIncomes = onSnapshot(collection(db, `/artifacts/${appId}/users/${user.uid}/incomes`), (snapshot) => {
                    setIncomes(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    if (!dataLoaded) setDataLoaded(true);
                });
                const unsubExpenses = onSnapshot(collection(db, `/artifacts/${appId}/users/${user.uid}/expenses`), (snapshot) => {
                    setExpenses(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    if (!dataLoaded) setDataLoaded(true);
                });
                return () => { unsubProfile(); unsubIncomes(); unsubExpenses(); };
            }, [user, dataLoaded]);

            // --- Lógica de Negócio ---
            const participants = useMemo(() => userProfile?.participants || ['Eu'], [userProfile]);
            const combinedIncomes = useMemo(() => isSimulation ? [...incomes, ...simIncomes] : incomes, [incomes, simIncomes, isSimulation]);
            const combinedExpenses = useMemo(() => isSimulation ? [...expenses, ...simExpenses] : expenses, [expenses, simExpenses, isSimulation]);

            const contextDate = useMemo(() => {
                const now = new Date();
                if (!isSimulation) return now;
                let maxT = now.getTime();
                [...combinedIncomes, ...combinedExpenses].forEach(r => { const d = new Date(r.year, r.month, 1); if (d.getTime() > maxT) maxT = d.getTime(); });
                return new Date(maxT);
            }, [isSimulation, combinedIncomes, combinedExpenses]);

            const filteredIncomes = useMemo(() => combinedIncomes.filter(i => i.year === filterYear && !i.isReserveAdjustment && !i.isTransferFromReserve), [combinedIncomes, filterYear]);
            const reserveTransfers = useMemo(() => combinedIncomes.filter(i => i.year === filterYear && i.isTransferFromReserve), [combinedIncomes, filterYear]);
            const filteredExpenses = useMemo(() => combinedExpenses.filter(e => e.year === filterYear && !e.isReserveAdjustment), [combinedExpenses, filterYear]);

            const totalRealIncome = useMemo(() => filteredIncomes.reduce((sum, i) => sum + i.amount, 0), [filteredIncomes]);
            const totalExpenses = useMemo(() => filteredExpenses.reduce((sum, e) => sum + e.amount, 0), [filteredExpenses]);
            const balance = useMemo(() => totalRealIncome - totalExpenses, [totalRealIncome, totalExpenses]);

            const calculateMovingAverage = useCallback((y, m) => {
                const targetD = new Date(y, m, 1);
                const winStart = new Date(targetD); winStart.setMonth(winStart.getMonth() - 11);
                const relIncomes = combinedIncomes.filter(i => { const d = new Date(i.year, i.month, 1); return d >= winStart && d <= targetD && !i.isReserveAdjustment && !i.isTransferFromReserve; });
                const relExpenses = combinedExpenses.filter(e => { const d = new Date(e.year, e.month, 1); return d >= winStart && d <= targetD && !e.isReserveAdjustment; });
                const activeM = new Set([...relIncomes, ...relExpenses].map(t => `${t.year}-${t.month}`));
                const count = activeM.size > 0 ? activeM.size : 1;
                return (relIncomes.reduce((s, i) => s + i.amount, 0) - relExpenses.reduce((s, e) => s + e.amount, 0)) / count;
            }, [combinedIncomes, combinedExpenses]);

            const calculateMovingIncomeAverage = useCallback((y, m) => {
                const targetD = new Date(y, m, 1);
                const winStart = new Date(targetD); winStart.setMonth(winStart.getMonth() - 11);
                const relIncomes = combinedIncomes.filter(i => { const d = new Date(i.year, i.month, 1); return d >= winStart && d <= targetD && !i.isReserveAdjustment && !i.isTransferFromReserve; });
                const activeM = new Set([...relIncomes].map(t => `${t.year}-${t.month}`));
                const count = activeM.size > 0 ? activeM.size : 1;
                return relIncomes.reduce((s, i) => s + i.amount, 0) / count;
            }, [combinedIncomes]);

            const currentTwelveMonthAverage = useMemo(() => calculateMovingAverage(contextDate.getFullYear(), contextDate.getMonth()), [calculateMovingAverage, contextDate]);

            const stabilityReserveHistory = useMemo(() => {
                const monthlyNets = {}; const adjFlags = {};
                combinedIncomes.forEach(r => { const k = `${r.year}-${String(r.month).padStart(2, '0')}`; monthlyNets[k] = (monthlyNets[k] || 0) + r.amount; if (r.isReserveAdjustment) adjFlags[k] = true; });
                combinedExpenses.forEach(r => { const k = `${r.year}-${String(r.month).padStart(2, '0')}`; monthlyNets[k] = (monthlyNets[k] || 0) - r.amount; if (r.isReserveAdjustment) adjFlags[k] = true; });
                const keys = Object.keys(monthlyNets).sort(); if (keys.length === 0) return [];
                const hist = []; let runRes = 0;
                for (const k of keys) {
                    const [y, m] = k.split('-').map(Number); const avg = calculateMovingAverage(y, m);
                    const prev = runRes; runRes += (monthlyNets[k] || 0) - avg;
                    if (runRes < 0) runRes = 0;
                    hist.push({ monthKey: k, monthName: new Date(y, m).toLocaleString('pt-BR', { month: 'short' }).replace('.',''), amountAdded: runRes - prev, totalReserve: runRes, hasAdjustment: adjFlags[k] });
                } return hist;
            }, [combinedIncomes, combinedExpenses, calculateMovingAverage]);

            const finalStabilityReserve = useMemo(() => stabilityReserveHistory.length > 0 ? stabilityReserveHistory[stabilityReserveHistory.length - 1].totalReserve : 0, [stabilityReserveHistory]);

            const liquidityAnalysis = useMemo(() => {
                const now = isSimulation ? contextDate : new Date();
                const prevD = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const prevK = `${prevD.getFullYear()}-${String(prevD.getMonth()).padStart(2, '0')}`;
                const prevR = stabilityReserveHistory.find(h => h.monthKey === prevK)?.totalReserve || 0;
                const currMIn = combinedIncomes.filter(i => i.month === now.getMonth() && i.year === now.getFullYear() && !i.isReserveAdjustment && !i.isTransferFromReserve).reduce((s, i) => s + i.amount, 0);
                const currMEx = combinedExpenses.filter(e => e.month === now.getMonth() && e.year === now.getFullYear() && !e.isReserveAdjustment).reduce((s, e) => s + e.amount, 0);
                const totalLiq = (currMIn - currMEx) + prevR;
                return { isLimited: totalLiq < currentTwelveMonthAverage, displayValue: totalLiq < currentTwelveMonthAverage ? totalLiq : currentTwelveMonthAverage };
            }, [stabilityReserveHistory, combinedIncomes, combinedExpenses, currentTwelveMonthAverage, contextDate, isSimulation]);

            const monthlySummary = useMemo(() => {
                const summary = Array.from({ length: 12 }, (_, i) => ({ month: i, monthName: new Date(filterYear, i).toLocaleString('pt-BR', { month: 'short' }).replace('.', ''), income: 0, expense: 0, balance: 0, transfers: 0 }));
                filteredIncomes.forEach(i => { summary[i.month].income += i.amount; });
                reserveTransfers.forEach(t => { summary[t.month].transfers += t.amount; });
                filteredExpenses.forEach(e => { summary[e.month].expense += e.amount; });
                summary.forEach(m => { m.balance = m.income - m.expense; });
                return summary;
            }, [filteredIncomes, reserveTransfers, filteredExpenses, filterYear]);

            const monthlyBalanceHistory = useMemo(() => monthlySummary.filter(m => m.income > 0 || m.transfers > 0 || m.expense > 0), [monthlySummary]);

            // --- Sorting Hooks ---
            const sortedMonthlyBalanceHistory = useSortableData(monthlyBalanceHistory, sortConfigs.summary);
            const sortedStabilityReserveHistory = useSortableData(stabilityReserveHistory, sortConfigs.reserve);
            const sortedFilteredIncomes = useSortableData(filteredIncomes, sortConfigs.incomes);
            const sortedFilteredExpenses = useSortableData(filteredExpenses, sortConfigs.expenses);

            const chartData = useMemo(() => {
                const data = []; const sortedH = [...stabilityReserveHistory].sort((a, b) => a.monthKey.localeCompare(b.monthKey));
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(contextDate.getFullYear(), contextDate.getMonth() - i, 1); const m = d.getMonth(); const y = d.getFullYear(); const k = `${y}-${String(m).padStart(2, '0')}`;
                    const inc = combinedIncomes.filter(r => r.month === m && r.year === y && !r.isReserveAdjustment && !r.isTransferFromReserve).reduce((s, r) => s + r.amount, 0);
                    const exp = combinedExpenses.filter(r => r.month === m && r.year === y && !r.isReserveAdjustment).reduce((s, r) => s + r.amount, 0);
                    const res = sortedH.filter(h => h.monthKey <= k).pop()?.totalReserve || 0;
                    data.push({ monthName: d.toLocaleString('pt-BR', { month: 'short' }).replace('.','') + '/' + y.toString().slice(2), balance: inc - exp, expense: exp, saldoSugerido: calculateMovingAverage(y, m), avgIncome: calculateMovingIncomeAverage(y, m), stabilityReserve: res });
                } return data;
            }, [stabilityReserveHistory, combinedIncomes, combinedExpenses, calculateMovingAverage, calculateMovingIncomeAverage, contextDate]);

            // --- Event Handlers ---
            const handleAddRecord = async (e) => {
                e.preventDefault();
                if (!description.trim() || !amount || isNaN(parseFloat(amount))) { setError("Preencha descrição e valor."); return; }
                setError('');
                const rec = { description, amount: parseFloat(amount), responsible: participants.length > 1 ? responsible : participants[0], month: parseInt(month), year: parseInt(year), createdAt: new Date() };
                if (isSimulation) {
                    const simId = `sim-${Date.now()}`; const recSim = {...rec, id: simId, isSimulated: true};
                    if (formType === 'income') setSimIncomes(p => [...p, recSim]); else setSimExpenses(p => [...p, recSim]);
                    setSuccess("Simulação adicionada.");
                } else {
                    const colName = formType === 'income' ? 'incomes' : 'expenses';
                    try {
                        const ref = await addDoc(collection(db, `/artifacts/${appId}/users/${user.uid}/${colName}`), rec);
                        addActionToHistory({ type: 'ADD', collection: colName, docId: ref.id, data: rec });
                        setSuccess("Registo adicionado.");
                    } catch (err) { setError("Erro ao guardar no Firebase."); }
                }
                setDescription(''); setAmount('');
            };

            const handleDeleteRecord = async (id, type) => {
                if (isSimulation) {
                    if (type === 'income') setSimIncomes(p => p.filter(r => r.id !== id)); else setSimExpenses(p => p.filter(r => r.id !== id));
                    return;
                }
                const colName = type === 'income' ? 'incomes' : 'expenses';
                const rec = (type === 'income' ? incomes : expenses).find(r => r.id === id);
                try {
                    await deleteDoc(doc(db, `/artifacts/${appId}/users/${user.uid}/${colName}`, id));
                    addActionToHistory({ type: 'DELETE', collection: colName, docId: id, data: rec });
                } catch (err) { setError("Erro ao apagar."); }
            };

            const handleUpdateRecord = async (id, type, data) => {
                if (isSimulation) {
                    const up = (p) => p.map(r => r.id === id ? data : r);
                    if (type === 'income') setSimIncomes(up); else setSimExpenses(up);
                    setEditingRecord(null); return;
                }
                const colName = type === 'income' ? 'incomes' : 'expenses';
                const old = (type === 'income' ? incomes : expenses).find(r => r.id === id);
                try {
                    const {id: rid, ...saveData} = data;
                    await updateDoc(doc(db, `/artifacts/${appId}/users/${user.uid}/${colName}`, id), saveData);
                    addActionToHistory({ type: 'UPDATE', collection: colName, docId: id, oldData: { description: old.description, amount: old.amount }, newData: saveData });
                    setEditingRecord(null);
                } catch (err) { setError("Erro ao atualizar."); }
            };

            const addActionToHistory = useCallback((action) => {
                if (isSimulation) return;
                const newHist = history.slice(0, historyIndex + 1); newHist.push(action);
                setHistory(newHist); setHistoryIndex(newHist.length - 1);
            }, [history, historyIndex, isSimulation]);

            const handleUndo = async () => {
                if (historyIndex < 0) return;
                const act = history[historyIndex];
                const ref = doc(db, `/artifacts/${appId}/users/${user.uid}/${act.collection}`, act.docId);
                try {
                    if (act.type === 'ADD') await deleteDoc(ref);
                    else if (act.type === 'DELETE') { const {id, ...rest} = act.data; await setDoc(ref, rest); }
                    else if (act.type === 'UPDATE') await updateDoc(ref, act.oldData);
                    setHistoryIndex(p => p - 1); setSuccess("Ação desfeita.");
                } catch (err) { setError("Falha ao desfazer."); }
            };

            const handleRequestSort = (t, k) => {
                setSortConfigs(prev => {
                    const curr = prev[t]; let dir = 'ascending';
                    if (curr.key === k && curr.direction === 'ascending') dir = 'descending';
                    return { ...prev, [t]: { key: k, direction: dir } };
                });
            };

            const handleManualReserveAdjustment = async (val, type) => {
                if (!user) return;
                const rec = { description: `Ajuste manual (${type})`, amount: val - finalStabilityReserve, month: contextDate.getMonth(), year: contextDate.getFullYear(), createdAt: new Date(), isReserveAdjustment: true };
                const col = rec.amount > 0 ? 'incomes' : 'expenses';
                rec.amount = Math.abs(rec.amount);
                try { await addDoc(collection(db, `/artifacts/${appId}/users/${user.uid}/${col}`), rec); setSuccess("Ajustado."); setShowAdjustReserveModal(false); }
                catch(e) { setError("Erro no ajuste."); }
            };

            const handleExportData = () => {
                const data = { incomes, expenses };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `dados_${new Date().toISOString().slice(0,10)}.json`; a.click();
            };

            if (isLoading && !dataLoaded) return <div className="bg-gray-900 text-gray-300 min-h-screen flex justify-center items-center"><p>A carregar...</p></div>;
            if (!user) return <AuthModal auth={auth} db={db} />;

            return (
                <div className="bg-gray-900 text-gray-300 min-h-screen font-sans">
                    {editingRecord && <EditModal record={editingRecord} onSave={handleUpdateRecord} onCancel={() => setEditingRecord(null)} onError={setError} participants={participants} />}
                    
                    <header className="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-20 border-b border-gray-800">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
                            <div className="flex items-center gap-8">
                                <h1 className="text-xl font-bold text-gray-100 hidden sm:block">Controlo Financeiro</h1>
                                <nav className="flex gap-2">
                                    <button onClick={() => setView('dashboard')} className={`py-2 px-4 text-xs font-semibold border-b-2 transition-all uppercase tracking-wider ${ view === 'dashboard' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300' }`} >Dashboard</button>
                                    <button onClick={() => setView('simulation')} className={`py-2 px-4 text-xs font-semibold border-b-2 transition-all uppercase tracking-wider ${ view === 'simulation' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300' }`} >Simulação</button>
                                    <button onClick={() => setView('budget')} className={`py-2 px-4 text-xs font-semibold border-b-2 transition-all uppercase tracking-wider ${ view === 'budget' ? 'text-blue-400 border-blue-400' : 'text-gray-400 border-transparent hover:text-blue-300' }`} >Orçamento</button>
                                </nav>
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setShowSettingsModal(true)} className="p-2 bg-gray-700 rounded-full hover:bg-gray-600"><SettingsIcon /></button>
                                <button onClick={() => signOut(auth)} className="p-2 bg-red-600/80 rounded-full hover:bg-red-500 transition-colors"><LogoutIcon /></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                        {view === 'budget' ? <BudgetPage /> : (
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                <div className="lg:col-span-8 space-y-8">
                                    <div id="summary-cards" className="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700 animate-fade-in">
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-semibold">Resumo de {filterYear}</h2>
                                            <input type="number" value={filterYear} onChange={e => setFilterYear(parseInt(e.target.value))} className="w-24 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm outline-none focus:ring-1 focus:ring-blue-500"/>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className={`p-4 rounded-lg border ${liquidityAnalysis.isLimited ? 'bg-orange-900/30 border-orange-600/50' : 'bg-blue-900/30 border-blue-700'}`}>
                                                <h3 className="text-xs font-medium uppercase tracking-widest opacity-60 mb-1">Saldo Sugerido</h3>
                                                <p className="text-2xl font-bold">{liquidityAnalysis.displayValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                            </div>
                                            <div className="p-4 rounded-lg border bg-purple-900/30 border-purple-700">
                                                <h3 className="text-xs font-medium uppercase tracking-widest opacity-60 mb-1 flex justify-between">Reserva de Estabilidade <button onClick={() => setShowAdjustReserveModal(true)}><AdjustIcon /></button></h3>
                                                <p className="text-2xl font-bold">{finalStabilityReserve.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                                        <h2 className="text-xl font-semibold mb-4">Evolução Mensal</h2>
                                        <div className="h-[300px]">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <ComposedChart data={chartData}>
                                                    <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                                                    <XAxis dataKey="monthName" stroke="#9CA3AF" />
                                                    <YAxis stroke="#9CA3AF" />
                                                    <Tooltip contentStyle={{ backgroundColor: '#1F2937', borderColor: '#374151' }} />
                                                    <Legend />
                                                    <Line type="monotone" dataKey="balance" name="Saldo Real" stroke="#10B981" strokeWidth={2} />
                                                    <Line type="monotone" dataKey="saldoSugerido" name="Meta (Média)" stroke="#3B82F6" strokeDasharray="5 5" />
                                                </ComposedChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>

                                    <div className="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                                        <div className="flex border-b border-gray-700 mb-4 overflow-x-auto scrollbar-hide">
                                            {[
                                                {id:'summary', label:'Resumo Mensal'},
                                                {id:'reserve', label:'Hist. Reserva'},
                                                {id:'incomes', label:'Entradas'},
                                                {id:'expenses', label:'Saídas'}
                                            ].map(tab => (
                                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`py-2 px-4 whitespace-nowrap text-sm font-semibold transition-all ${activeTab === tab.id ? 'text-blue-400 border-b-2 border-blue-400' : 'text-gray-500 hover:text-gray-300'}`}>{tab.label}</button>
                                            ))}
                                        </div>
                                        {activeTab === 'summary' && (
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-left">
                                                    <thead>
                                                        <tr className="border-b border-gray-700 text-gray-500 text-xs">
                                                            <th className="p-3">MÊS</th>
                                                            <th className="p-3 text-right">ENTRADAS</th>
                                                            <th className="p-3 text-right">SAÍDAS</th>
                                                            <th className="p-3 text-right">SALDO</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {sortedMonthlyBalanceHistory.map(m => (
                                                            <tr key={m.month} className="border-b border-gray-700/50 hover:bg-gray-700/20">
                                                                <td className="p-3 font-medium capitalize">{m.monthName}</td>
                                                                <td className="p-3 text-right text-green-400">{m.income.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                                                                <td className="p-3 text-right text-red-400">{m.expense.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                                                                <td className={`p-3 text-right font-bold ${m.balance >= 0 ? 'text-blue-400' : 'text-yellow-400'}`}>{m.balance.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                        {activeTab === 'reserve' && (
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-left">
                                                    <thead>
                                                        <tr className="border-b border-gray-700 text-gray-500 text-xs">
                                                            <th className="p-3">MÊS</th>
                                                            <th className="p-3 text-right">VARIAÇÃO</th>
                                                            <th className="p-3 text-right">TOTAL ACUM.</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {sortedStabilityReserveHistory.map(h => (
                                                            <tr key={h.monthKey} className="border-b border-gray-700/50">
                                                                <td className="p-3 font-medium capitalize">{h.monthName}</td>
                                                                <td className={`p-3 text-right ${h.amountAdded >= 0 ? 'text-green-400' : 'text-red-400'}`}>{h.amountAdded.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                                                                <td className="p-3 text-right font-bold text-purple-400">{h.totalReserve.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                        {activeTab === 'incomes' && <RecordsTable title="Entradas" records={sortedFilteredIncomes} onDelete={handleDeleteRecord} onEdit={setEditingRecord} type="income" sortConfig={sortConfigs.incomes} requestSort={k => handleRequestSort('incomes', k)} participants={participants} />}
                                        {activeTab === 'expenses' && <RecordsTable title="Saídas" records={sortedFilteredExpenses} onDelete={handleDeleteRecord} onEdit={setEditingRecord} type="expense" sortConfig={sortConfigs.expenses} requestSort={k => handleRequestSort('expenses', k)} participants={participants} />}
                                    </div>
                                </div>

                                <div className="lg:col-span-4 space-y-6">
                                    <div id="add-record-form" className="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-md">
                                        <h3 className="text-sm font-bold mb-4 uppercase tracking-widest opacity-70">Nova Transação</h3>
                                        <div className="flex mb-4 gap-2">
                                            <button onClick={() => setFormType('income')} className={`flex-1 py-1.5 rounded text-xs font-bold uppercase transition-all ${formType === 'income' ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400'}`}>Entrada</button>
                                            <button onClick={() => setFormType('expense')} className={`flex-1 py-1.5 rounded text-xs font-bold uppercase transition-all ${formType === 'expense' ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-400'}`}>Saída</button>
                                        </div>
                                        <form onSubmit={handleAddRecord} className="space-y-4">
                                            <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="Descrição..." className="w-full bg-gray-700 border border-gray-600 p-2 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500"/>
                                            {participants.length > 1 && (
                                                <select value={responsible} onChange={e => setResponsible(e.target.value)} className="w-full bg-gray-700 border border-gray-600 p-2 rounded-lg text-sm outline-none">
                                                    {participants.map(p => <option key={p} value={p}>{p}</option>)}
                                                </select>
                                            )}
                                            <div className="relative">
                                                <span className="absolute left-3 top-2 text-gray-500 text-xs">R$</span>
                                                <input type="number" step="0.01" value={amount} onChange={e => setAmount(e.target.value)} className="w-full bg-gray-700 border border-gray-600 pl-8 pr-3 py-2 rounded-lg text-sm outline-none focus:ring-1 focus:ring-blue-500" placeholder="0,00"/>
                                            </div>
                                            <div className="flex gap-2">
                                                <select value={month} onChange={e => setMonth(e.target.value)} className="flex-1 bg-gray-700 border border-gray-600 p-2 rounded-lg text-xs outline-none">{Array.from({length:12}, (_,i)=><option key={i} value={i}>{new Date(0,i).toLocaleString('pt-BR',{month:'long'})}</option>)}</select>
                                                <input type="number" value={year} onChange={e => setYear(e.target.value)} className="w-20 bg-gray-700 border border-gray-600 p-2 rounded-lg text-xs outline-none"/>
                                            </div>
                                            <button type="submit" className={`w-full py-3 rounded-lg font-bold text-xs uppercase tracking-widest transition-all hover:scale-[1.02] active:scale-[0.98] ${formType === 'income' ? 'bg-green-600 shadow-green-900/20' : 'bg-red-600 shadow-red-900/20'} shadow-lg`}>Adicionar</button>
                                        </form>
                                    </div>

                                    <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-md space-y-2">
                                        <div className="flex gap-2">
                                            <button onClick={handleUndo} disabled={historyIndex < 0} className="flex-1 bg-gray-700 py-2 rounded text-[10px] font-bold uppercase disabled:opacity-30">Desfazer</button>
                                            <button onClick={handleExportData} className="flex-1 bg-gray-700 py-2 rounded text-[10px] font-bold uppercase">Exportar</button>
                                        </div>
                                        <button onClick={() => setIsTourOpen(true)} className="w-full bg-purple-600 py-2 rounded text-[10px] font-bold uppercase tracking-widest">Tutorial</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        <footer className="text-center mt-12 py-8 border-t border-gray-800 opacity-30 flex flex-col items-center">
                            <p className="text-[10px] mb-3 uppercase tracking-[0.2em]">Plataforma de Controlo Financeiro</p>
                            <img src="https://i.postimg.cc/dVgn73g8/Monocromatica-Horizontal.png" alt="Desenvolvedor" className="h-5 grayscale brightness-200" />
                        </footer>
                    </main>

                    {showAdjustReserveModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-gray-800 p-6 rounded-xl max-w-sm w-full border border-gray-700 shadow-2xl">
                                <h2 className="text-xl font-bold mb-4">Ajustar Reserva</h2>
                                <p className="text-xs text-gray-400 mb-4">Indique o novo valor real que deseja ter na sua reserva.</p>
                                <input type="number" id="manual-res-input" className="w-full bg-gray-700 p-3 rounded-lg outline-none focus:ring-1 focus:ring-purple-500 mb-6" placeholder="Novo valor R$..." />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowAdjustReserveModal(false)} className="flex-1 py-2 bg-gray-600 rounded-lg text-sm">Cancelar</button>
                                    <button onClick={() => handleManualReserveAdjustment(parseFloat(document.getElementById('manual-res-input').value), 'manual')} className="flex-1 py-2 bg-purple-600 rounded-lg text-sm font-bold">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const EditModal = ({ record, onSave, onCancel, onError, participants }) => {
            const [d, setD] = useState(record.description); 
            const [a, setA] = useState(record.amount);
            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-gray-800 p-6 rounded-xl max-w-sm w-full border border-gray-700 shadow-2xl">
                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><EditIcon /> Editar Registo</h2>
                        <div className="space-y-4">
                            <div><label className="text-[10px] text-gray-500 uppercase font-bold">Descrição</label><input value={d} onChange={e => setD(e.target.value)} className="w-full bg-gray-700 p-2 rounded-lg outline-none border border-gray-600 mt-1" /></div>
                            <div><label className="text-[10px] text-gray-500 uppercase font-bold">Valor R$</label><input type="number" value={a} onChange={e => setA(e.target.value)} className="w-full bg-gray-700 p-2 rounded-lg outline-none border border-gray-600 mt-1" /></div>
                        </div>
                        <div className="flex gap-2 mt-8">
                            <button onClick={onCancel} className="flex-1 py-2 bg-gray-700 text-gray-300 rounded-lg text-xs font-bold uppercase">Sair</button>
                            <button onClick={() => onSave(record.id, record.type, {...record, description:d, amount:parseFloat(a)})} className="flex-1 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold uppercase tracking-wider">Guardar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
